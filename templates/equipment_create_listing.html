{% extends "base.html" %}

{% block title %}List Equipment - Equipment Sharing{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/buyer_connect.css') }}">
<style>
.map-fullscreen-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 1000;
    background: white;
    border: 2px solid rgba(0,0,0,0.2);
    border-radius: 4px;
    padding: 8px 12px;
    cursor: pointer;
    box-shadow: 0 1px 5px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
    font-size: 16px;
    color: #333;
}

.map-fullscreen-btn:hover {
    background: #f4f4f4;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

.map-fullscreen-btn:active {
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

#mapContainer.fullscreen {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    width: 100%;
    height: 100%;
    z-index: 9999;
    background: white;
}

#mapContainer.fullscreen #map {
    height: 100% !important;
    border-radius: 0;
    margin-bottom: 0;
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-layout">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">üåæ</div>
            <div>
                <div class="sidebar-title">Smart Farming</div>
                <div class="sidebar-subtitle">Agricultural Platform</div>
            </div>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Main Menu</div>
                <a href="{{ url_for('dashboard.dashboard') }}" class="nav-link">
                    <i class="fas fa-th-large"></i>
                    <span>Dashboard</span>
                </a>
                <a href="{{ url_for('crop.crop_suggestion') }}" class="nav-link">
                    <i class="fas fa-seedling"></i>
                    <span>Crop Suggestion</span>
                </a>
                <a href="{{ url_for('fertilizer.fertilizer_recommend') }}" class="nav-link">
                    <i class="fas fa-flask"></i>
                    <span>Fertilizer Advice</span>
                </a>
                <a href="{{ url_for('market.market_watch') }}" class="nav-link">
                    <i class="fas fa-chart-line"></i>
                    <span>Market Prices</span>
                    <span class="badge">Live</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Equipment Sharing</div>
                <a href="{{ url_for('equipment_sharing.create_listing') }}" class="nav-link active">
                    <i class="fas fa-plus-circle"></i>
                    <span>List Equipment</span>
                </a>
                <a href="{{ url_for('equipment_sharing.my_listings') }}" class="nav-link">
                    <i class="fas fa-list-alt"></i>
                    <span>My Listings</span>
                </a>
                <a href="{{ url_for('equipment_sharing.marketplace') }}" class="nav-link">
                    <i class="fas fa-tractor"></i>
                    <span>Rent Equipment</span>
                    <span class="badge" style="background: #3b82f6;">New</span>
                </a>
            </div>
        </nav>

        <div class="sidebar-user">
            <div class="user-info">
                <div class="user-avatar">{{ session.get('user_name', 'U')[0] }}</div>
                <div class="user-details">
                    <h4>{{ session.get('user_name', 'User') }}</h4>
                    <span>Farmer</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Page Header -->
        <div class="page-header">
            <h1>
                <i class="fas fa-tractor"></i> List Your Equipment for Rent
            </h1>
            <p class="page-subtitle">Share your farm equipment with other farmers and earn rental income</p>
        </div>

        <!-- Form Card -->
        <div class="form-card">
            <form id="listingForm" method="POST" action="{{ url_for('equipment_sharing.create_listing') }}">
                <!-- Equipment Selection -->
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-tractor"></i> Equipment Type *
                </label>
                <select name="equipment_name" id="equipmentSelect" required class="form-select">
                    <option value="">Select equipment...</option>
                    <option value="Tractor">üöú Tractor</option>
                    <option value="Harvester">üåæ Harvester</option>
                    <option value="Plough">üî® Plough</option>
                    <option value="Seed Drill">üå± Seed Drill</option>
                    <option value="Sprayer">üíß Sprayer</option>
                    <option value="Cultivator">‚öôÔ∏è Cultivator</option>
                    <option value="Rotavator">üîÑ Rotavator</option>
                    <option value="Thresher">üåæ Thresher</option>
                    <option value="Irrigation Pump">üí¶ Irrigation Pump</option>
                    <option value="Trailer">üöõ Trailer</option>
                    <option value="Disc Harrow">‚ö° Disc Harrow</option>
                    <option value="Leveler">üìè Leveler</option>
                </select>
            </div>

            <!-- Rental Rate and Availability Dates -->
            <div class="form-grid-2 form-group">
                <div>
                    <label class="form-label">
                        <i class="fas fa-rupee-sign"></i> Rent Per Day *
                    </label>
                    <input type="number" name="rent" id="equipmentRent" step="0.01" min="0" required
                        placeholder="Enter daily rental rate" class="form-input" style="font-weight: 600; color: #10b981;">
                    <div id="rentValidation" style="margin-top: 10px;"></div>
                </div>
                <div>
                    <label class="form-label">
                        <i class="fas fa-calendar-check"></i> Available From *
                    </label>
                    <input type="date" name="available_from" id="availableFrom" required class="form-input">
                </div>
            </div>

            <!-- Available To Date -->
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-calendar-times"></i> Available To *
                </label>
                <input type="date" name="available_to" id="availableTo" required class="form-input">
            </div>

            <!-- Hidden fields for auto-detected location -->
            <input type="hidden" name="state" id="state" required>
            <input type="hidden" name="district" id="district" required>

            <!-- Map Location Selector -->
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-map-marked-alt"></i> Pinpoint Your Equipment Location *
                </label>
                <div style="background: #f8fafc; padding: 12px; border-radius: 8px; margin-bottom: 12px; font-size: 14px; color: var(--text-secondary);">
                    <i class="fas fa-info-circle" style="color: #3b82f6;"></i> Click on the map to select your equipment location. Drag the marker to adjust position.
                </div>
                
                <!-- Map Control Buttons -->
                <div style="display: flex; gap: 12px; margin-bottom: 12px; flex-wrap: wrap;">
                    <button type="button" id="useCurrentLocationBtn" class="btn-submit" style="flex: 1; min-width: 200px;">
                        <i class="fas fa-crosshairs"></i> Use My Current Location
                    </button>
                    <button type="button" id="searchLocationBtn" class="btn-cancel" style="flex: 1; min-width: 200px;">
                        <i class="fas fa-search-location"></i> Search Location
                    </button>
                </div>
                
                <!-- Search Box (hidden by default) -->
                <div id="searchBox" style="display: none; margin-bottom: 12px;">
                    <input type="text" id="searchInput" placeholder="Search for your village, town, or landmark..." 
                        class="form-input" style="margin-bottom: 8px;">
                    <button type="button" id="doSearchBtn" class="btn-submit" style="width: 100%;">
                        <i class="fas fa-search"></i> Search
                    </button>
                </div>
                
                <div id="mapContainer" style="position: relative;">
                    <div id="map" style="height: 500px; border-radius: 8px; border: 2px solid #e2e8f0; margin-bottom: 12px; cursor: crosshair;"></div>
                    <button id="fullscreenBtn" class="map-fullscreen-btn" title="Toggle Fullscreen">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
                <div id="selectedLocation" style="padding: 12px; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #10b981; display: none;">
                    <div style="font-size: 13px; font-weight: 600; color: #047857; margin-bottom: 4px;">
                        <i class="fas fa-check-circle"></i> Location Selected
                    </div>
                    <div id="locationDetails" style="font-size: 13px; color: #064e3b;"></div>
                </div>
                <input type="hidden" name="latitude" id="latitude" required>
                <input type="hidden" name="longitude" id="longitude" required>
            </div>

            <div id="priceInfoBox" class="price-info-box">
                <div class="price-header">
                    <div class="price-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="price-title">
                        <h3>üìä Market Rental Rates</h3>
                        <div class="market-name" id="marketName">Select equipment to see rates</div>
                    </div>
                </div>
                <div class="price-main">
                    <div class="price-label">Recommended Rate</div>
                    <div class="price-recommended" id="recommendedPrice">‚Çπ0.00/day</div>
                </div>
                <div class="price-range-grid">
                    <div class="price-box min">
                        <div class="label">Minimum (‚àí20%)</div>
                        <div class="value" id="minPrice">‚Çπ0.00/day</div>
                    </div>
                    <div class="price-box max">
                        <div class="label">Maximum (+20%)</div>
                        <div class="value" id="maxPrice">‚Çπ0.00/day</div>
                    </div>
                </div>
                <div class="price-info">
                    <i class="fas fa-info-circle"></i>
                    Set your rental rate within ¬±20% of market rate for best results
                </div>
            </div>

            <!-- Equipment Description -->
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-align-left"></i> Equipment Description *
                </label>
                <textarea name="description" id="description" rows="4" required placeholder="Add details about model, condition, capacity, year, fuel type, etc."
                    class="form-textarea"></textarea>
                <small style="color: var(--text-secondary); margin-top: 4px; display: block;">Provide detailed information to attract renters</small>
            </div>

            <!-- Submit Button -->
            <div class="form-actions">
                <a href="{{ url_for('equipment_sharing.my_listings') }}" class="btn-cancel">
                    <i class="fas fa-times"></i> Cancel
                </a>
                <button type="submit" id="submitBtn" class="btn-submit">
                    <i class="fas fa-check-circle"></i> Create Listing
                </button>
            </div>
        </form>
    </div>

    <!-- Existing Listings -->
    {% if existing_listings %}
    <div class="form-card" style="margin-top: 32px;">
        <h2 style="font-size: 20px; font-weight: 700; color: var(--text-primary); margin-bottom: 20px;">
            <i class="fas fa-list"></i> Your Recent Equipment Listings
        </h2>
        <div style="display: grid; gap: 16px;">
            {% for listing in existing_listings[:3] %}
            <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid {% if listing.status == 'available' %}var(--accent-green){% elif listing.status == 'booked' %}var(--accent-blue){% else %}var(--text-muted){% endif %};">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3 style="font-size: 16px; font-weight: 600; color: var(--text-primary);">{{ listing.equipment_name }}</h3>
                        <div style="color: var(--text-secondary); font-size: 14px; margin-top: 4px;">
                            ‚Çπ{{ "%.2f"|format(listing.rent_per_day) }}/day ‚Ä¢ {{ listing.state }}
                        </div>
                    </div>
                    <span class="status-badge" style="padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; 
                        background: {% if listing.status == 'available' %}#dcfce7{% elif listing.status == 'booked' %}#dbeafe{% else %}#f1f5f9{% endif %}; 
                        color: {% if listing.status == 'available' %}#166534{% elif listing.status == 'booked' %}#1e40af{% else %}#64748b{% endif %};">
                        {{ listing.status|upper }}
                    </span>
                </div>
            </div>
            {% endfor %}
        </div>
        <a href="{{ url_for('equipment_sharing.my_listings') }}" class="btn-cancel" style="margin-top: 16px; display: inline-block;">
            View All Listings
        </a>
    </div>
    {% endif %}
    </div>
</div>

<!-- Leaflet CSS and JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
let currentMinRent = 0;
let currentMaxRent = 0;
let currentRecommendedRent = 0;

// Map variables
let map;
let marker;
let selectedLat = null;
let selectedLng = null;

// Initialize map with optimized settings for smooth navigation
function initializeMap() {
    if (map) {
        map.remove();
    }
    
    // Create map with optimized settings
    map = L.map('map', {
        center: [20.5937, 78.9629],
        zoom: 5,
        zoomControl: true,
        scrollWheelZoom: true,
        doubleClickZoom: true,
        touchZoom: true,
        boxZoom: true,
        keyboard: true,
        dragging: true,
        tap: true,
        zoomAnimation: true,
        fadeAnimation: true,
        markerZoomAnimation: true,
        inertia: true,
        inertiaDeceleration: 3000,
        inertiaMaxSpeed: 1500,
        worldCopyJump: false,
        maxBoundsViscosity: 1.0
    });
    
    // Add tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 19,
        minZoom: 3
    }).addTo(map);
    
    // Add click event to map
    map.on('click', function(e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;
        
        // Update or create marker
        if (marker) {
            marker.setLatLng(e.latlng);
        } else {
            marker = L.marker(e.latlng, {
                draggable: true,
                icon: L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                })
            }).addTo(map);
            
            // Allow marker to be dragged
            marker.on('dragend', function(e) {
                const position = marker.getLatLng();
                updateLocationDetails(position.lat, position.lng);
            });
        }
        
        updateLocationDetails(lat, lng);
    });
    
    // Try to get user's current location
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            const userLat = position.coords.latitude;
            const userLng = position.coords.longitude;
            map.setView([userLat, userLng], 13);
            
            // Add a circle to show user's approximate location
            L.circle([userLat, userLng], {
                color: '#3b82f6',
                fillColor: '#3b82f6',
                fillOpacity: 0.2,
                radius: 500
            }).addTo(map);
        });
    }
}

// Update location details
function updateLocationDetails(lat, lng) {
    selectedLat = lat;
    selectedLng = lng;
    
    document.getElementById('latitude').value = lat.toFixed(6);
    document.getElementById('longitude').value = lng.toFixed(6);
    
    document.getElementById('selectedLocation').style.display = 'block';
    document.getElementById('locationDetails').innerHTML = `
        <div style="display: flex; align-items: center; gap: 8px;">
            <i class="fas fa-spinner fa-spin"></i>
            <span>Fetching location name...</span>
        </div>
    `;
    
    // Reverse geocoding to get place name
    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`)
        .then(response => response.json())
        .then(data => {
            const address = data.address || {};
            const village = address.village || address.town || address.suburb || address.city || address.municipality || 'Unknown location';
            const locality = address.locality || address.neighbourhood || '';
            const displayName = data.display_name || 'Location details not available';
            
            // Extract state and district
            let detectedState = address.state || '';
            let detectedDistrict = address.state_district || address.county || address.city_district || '';
            
            // Clean up state name
            detectedState = detectedState.replace(/^State of /i, '').trim();
            
            // Auto-fill hidden fields
            document.getElementById('state').value = detectedState;
            document.getElementById('district').value = detectedDistrict;
            
            document.getElementById('locationDetails').innerHTML = `
                <div style="margin-bottom: 8px;">
                    <i class="fas fa-map-pin" style="color: #10b981;"></i> 
                    <strong style="font-size: 15px;">${village}</strong>
                    ${locality ? `, ${locality}` : ''}
                </div>
                <div style="font-size: 12px; color: #065f46; margin-bottom: 6px;">
                    ${displayName}
                </div>
                <div style="display: grid; grid-template-columns: auto 1fr; gap: 8px; font-size: 12px; color: #047857;">
                    <strong>Coordinates:</strong> <span>${lat.toFixed(6)}, ${lng.toFixed(6)}</span>
                    <strong>District:</strong> <span style="font-weight: 600; color: #065f46;">${detectedDistrict || 'Detecting...'}</span>
                    <strong>State:</strong> <span style="font-weight: 600; color: #065f46;">${detectedState || 'Detecting...'}</span>
                </div>
            `;
            
            // Auto-fetch live rental rate if equipment is selected
            const equipment = document.getElementById('equipmentSelect').value;
            if (equipment && detectedState && detectedDistrict) {
                fetchLiveRent();
            }
        })
        .catch(error => {
            console.error('Geocoding error:', error);
            document.getElementById('locationDetails').innerHTML = `
                <strong>Coordinates:</strong> ${lat.toFixed(6)}, ${lng.toFixed(6)}<br>
                <strong>District:</strong> ${document.getElementById('district').value || 'Not selected'}<br>
                <strong>State:</strong> ${document.getElementById('state').value || 'Not selected'}<br>
                <small style="color: #dc2626;">Could not fetch location name. Please ensure internet connection.</small>
            `;
        });
}

// Auto-fetch live rental rate when equipment and location are selected
function fetchLiveRent() {
    const equipment = document.getElementById('equipmentSelect').value;
    const district = document.getElementById('district').value;
    const state = document.getElementById('state').value;
    
    if (!equipment) {
        return;
    }
    
    if (!district || !state) {
        document.getElementById('priceInfoBox').style.display = 'none';
        return;
    }
    
    // Show loading
    document.getElementById('priceInfoBox').style.display = 'block';
    document.getElementById('marketName').textContent = 'Fetching market rental rates...';
    
    fetch('/equipment-sharing/api/get-live-rent', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ equipment_name: equipment, district, state })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            currentRecommendedRent = data.recommended_rent;
            currentMinRent = data.min_rent;
            currentMaxRent = data.max_rent;
            
            document.getElementById('recommendedPrice').textContent = `‚Çπ${currentRecommendedRent.toFixed(2)}/day`;
            document.getElementById('minPrice').textContent = `‚Çπ${currentMinRent.toFixed(2)}/day`;
            document.getElementById('maxPrice').textContent = `‚Çπ${currentMaxRent.toFixed(2)}/day`;
            document.getElementById('marketName').textContent = `${data.location || 'Market'} ‚Ä¢ ${equipment}`;
            
            // Auto-fill equipment rent with recommended rate
            document.getElementById('equipmentRent').value = currentRecommendedRent.toFixed(2);
            validateRent();
        } else {
            document.getElementById('marketName').textContent = 'No rental rate data available for this equipment/location';
            // Set default values if no data
            currentRecommendedRent = 0;
            currentMinRent = 0;
            currentMaxRent = 999999;
        }
    })
    .catch(error => {
        console.error('Error fetching rental rate:', error);
        document.getElementById('marketName').textContent = 'Error fetching rental rate. You can still set your own rate.';
        currentRecommendedRent = 0;
        currentMinRent = 0;
        currentMaxRent = 999999;
    });
}

// Validate rent is within ¬±20% range
function validateRent() {
    const equipmentRent = parseFloat(document.getElementById('equipmentRent').value);
    const validationDiv = document.getElementById('rentValidation');
    const submitBtn = document.getElementById('submitBtn');
    
    if (isNaN(equipmentRent) || equipmentRent <= 0) {
        validationDiv.innerHTML = '';
        return;
    }
    
    // If no market data, allow any positive value
    if (currentRecommendedRent === 0) {
        validationDiv.innerHTML = `
            <div class="validation-message success">
                <i class="fas fa-check-circle"></i>
                <span>Valid rental rate</span>
            </div>
        `;
        submitBtn.disabled = false;
        submitBtn.style.opacity = '1';
        submitBtn.style.cursor = 'pointer';
        return;
    }
    
    if (equipmentRent < currentMinRent || equipmentRent > currentMaxRent) {
        validationDiv.innerHTML = `
            <div class="validation-message error">
                <i class="fas fa-exclamation-triangle"></i>
                <span>Recommended: ‚Çπ${currentMinRent.toFixed(2)} - ‚Çπ${currentMaxRent.toFixed(2)}/day</span>
            </div>
        `;
        submitBtn.disabled = true;
        submitBtn.style.opacity = '0.5';
        submitBtn.style.cursor = 'not-allowed';
    } else {
        const diffPercent = ((equipmentRent - currentRecommendedRent) / currentRecommendedRent * 100).toFixed(1);
        const diffText = diffPercent > 0 ? `+${diffPercent}%` : `${diffPercent}%`;
        
        validationDiv.innerHTML = `
            <div class="validation-message success">
                <i class="fas fa-check-circle"></i>
                <span>Valid rate (${diffText} from market rate)</span>
            </div>
        `;
        submitBtn.disabled = false;
        submitBtn.style.opacity = '1';
        submitBtn.style.cursor = 'pointer';
    }
}

// Event listeners
document.getElementById('equipmentSelect').addEventListener('change', function() {
    const state = document.getElementById('state').value;
    const district = document.getElementById('district').value;
    if (state && district) {
        fetchLiveRent();
    }
});
document.getElementById('equipmentRent').addEventListener('input', validateRent);

// Validate date range
document.getElementById('availableFrom').addEventListener('change', validateDates);
document.getElementById('availableTo').addEventListener('change', validateDates);

function validateDates() {
    const fromDate = document.getElementById('availableFrom').value;
    const toDate = document.getElementById('availableTo').value;
    
    if (fromDate && toDate && new Date(fromDate) > new Date(toDate)) {
        alert('‚ö†Ô∏è "Available From" date must be before "Available To" date');
        document.getElementById('availableTo').value = '';
    }
}

// Form validation before submission
document.getElementById('listingForm').addEventListener('submit', function(e) {
    const equipmentRent = parseFloat(document.getElementById('equipmentRent').value);
    const latitude = document.getElementById('latitude').value;
    const longitude = document.getElementById('longitude').value;
    const description = document.getElementById('description').value.trim();
    const fromDate = document.getElementById('availableFrom').value;
    const toDate = document.getElementById('availableTo').value;
    
    // Validate location selection
    if (!latitude || !longitude) {
        e.preventDefault();
        alert('üìç Please select your location on the map by clicking on it');
        document.getElementById('map').scrollIntoView({ behavior: 'smooth', block: 'center' });
        return false;
    }
    
    // Validate rent
    if (isNaN(equipmentRent) || equipmentRent <= 0) {
        e.preventDefault();
        alert('‚ö†Ô∏è Please enter a valid rental rate greater than 0');
        return false;
    }
    
    // Validate description
    if (!description || description.length < 10) {
        e.preventDefault();
        alert('‚ö†Ô∏è Please provide a detailed description (at least 10 characters)');
        return false;
    }
    
    // Validate dates
    if (!fromDate || !toDate) {
        e.preventDefault();
        alert('‚ö†Ô∏è Please select availability dates');
        return false;
    }
    
    if (new Date(fromDate) > new Date(toDate)) {
        e.preventDefault();
        alert('‚ö†Ô∏è "Available From" date must be before "Available To" date');
        return false;
    }
    
    return true;
});

// Use Current Location Button
document.getElementById('useCurrentLocationBtn').addEventListener('click', function() {
    const btn = this;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Getting location...';
    
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const userLat = position.coords.latitude;
                const userLng = position.coords.longitude;
                
                map.setView([userLat, userLng], 16);
                
                if (marker) {
                    marker.setLatLng([userLat, userLng]);
                } else {
                    marker = L.marker([userLat, userLng], {
                        draggable: true,
                        icon: L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            shadowSize: [41, 41]
                        })
                    }).addTo(map);
                    
                    marker.on('dragend', function(e) {
                        const position = marker.getLatLng();
                        updateLocationDetails(position.lat, position.lng);
                    });
                }
                
                updateLocationDetails(userLat, userLng);
                
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-check-circle"></i> Location Set!';
                setTimeout(() => {
                    btn.innerHTML = '<i class="fas fa-crosshairs"></i> Use My Current Location';
                }, 2000);
            },
            function(error) {
                alert('‚ùå Could not get your location. Please click on the map manually or check location permissions.');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-crosshairs"></i> Use My Current Location';
            },
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );
    } else {
        alert('‚ùå Geolocation is not supported by your browser');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-crosshairs"></i> Use My Current Location';
    }
});

// Search Location Button
document.getElementById('searchLocationBtn').addEventListener('click', function() {
    const searchBox = document.getElementById('searchBox');
    searchBox.style.display = searchBox.style.display === 'none' ? 'block' : 'none';
});

// Search Location Function
document.getElementById('doSearchBtn').addEventListener('click', function() {
    const query = document.getElementById('searchInput').value.trim();
    
    if (!query) {
        alert('‚ö†Ô∏è Please enter a location to search');
        return;
    }
    
    const btn = this;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Searching...';
    
    const fullQuery = `${query}, India`;
    
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(fullQuery)}&limit=1`)
        .then(response => response.json())
        .then(data => {
            if (data && data.length > 0) {
                const lat = parseFloat(data[0].lat);
                const lng = parseFloat(data[0].lon);
                
                map.setView([lat, lng], 16);
                
                if (marker) {
                    marker.setLatLng([lat, lng]);
                } else {
                    marker = L.marker([lat, lng], {
                        draggable: true,
                        icon: L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            shadowSize: [41, 41]
                        })
                    }).addTo(map);
                    
                    marker.on('dragend', function(e) {
                        const position = marker.getLatLng();
                        updateLocationDetails(position.lat, position.lng);
                    });
                }
                
                updateLocationDetails(lat, lng);
                document.getElementById('searchBox').style.display = 'none';
                document.getElementById('searchInput').value = '';
            } else {
                alert('‚ùå Location not found. Try searching with different keywords or click on the map.');
            }
            
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-search"></i> Search';
        })
        .catch(error => {
            console.error('Search error:', error);
            alert('‚ùå Search failed. Please try again or click on the map manually.');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-search"></i> Search';
        });
});

// Allow Enter key to search
document.getElementById('searchInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('doSearchBtn').click();
    }
});

// Fullscreen toggle
document.getElementById('fullscreenBtn').addEventListener('click', function() {
    const mapContainer = document.getElementById('mapContainer');
    const icon = this.querySelector('i');
    
    if (mapContainer.classList.contains('fullscreen')) {
        mapContainer.classList.remove('fullscreen');
        icon.classList.remove('fa-compress');
        icon.classList.add('fa-expand');
        this.title = 'Toggle Fullscreen';
    } else {
        mapContainer.classList.add('fullscreen');
        icon.classList.remove('fa-expand');
        icon.classList.add('fa-compress');
        this.title = 'Exit Fullscreen';
    }
    
    setTimeout(() => {
        map.invalidateSize();
    }, 100);
});

// Exit fullscreen on ESC key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const mapContainer = document.getElementById('mapContainer');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        if (fullscreenBtn) {
            const icon = fullscreenBtn.querySelector('i');
            
            if (mapContainer.classList.contains('fullscreen')) {
                mapContainer.classList.remove('fullscreen');
                icon.classList.remove('fa-compress');
                icon.classList.add('fa-expand');
                fullscreenBtn.title = 'Toggle Fullscreen';
                setTimeout(() => {
                    map.invalidateSize();
                }, 100);
            }
        }
    }
});

// Set minimum date to today
document.getElementById('availableFrom').min = new Date().toISOString().split('T')[0];
document.getElementById('availableTo').min = new Date().toISOString().split('T')[0];

// Initialize on page load
window.addEventListener('DOMContentLoaded', function() {
    initializeMap();
});
</script>
{% endblock %}
