{% extends "base.html" %}

{% block title %}Market Watch - Smart Farming Assistant{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    .filter-card {
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        padding: 24px;
        margin-bottom: 24px;
    }

    .filter-row {
        display: flex;
        gap: 16px;
        align-items: flex-end;
        flex-wrap: wrap;
    }

    .filter-group {
        flex: 1;
        min-width: 200px;
        position: relative;
    }

    .filter-group label {
        display: block;
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .filter-group select {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid var(--border-color);
        border-radius: var(--radius-md);
        font-size: 14px;
        transition: all 0.3s ease;
        background: white;
    }

    .filter-group select:focus {
        outline: none;
        border-color: var(--accent-blue);
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
    }

    .filter-btn {
        padding: 12px 24px;
        background: linear-gradient(135deg, var(--accent-blue), #2563eb);
        color: white;
        border: none;
        border-radius: var(--radius-md);
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .filter-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }

    .market-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
        gap: 20px;
    }

    .market-card {
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        overflow: hidden;
        transition: all 0.3s ease;
        border-left: 4px solid var(--accent-green);
    }

    .market-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
    }

    .market-card.bearish {
        border-left-color: var(--accent-red);
    }

    .market-card-header {
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        border-bottom: 1px solid var(--border-color);
    }

    .commodity-info {
        display: flex;
        align-items: center;
        gap: 14px;
    }

    .commodity-icon {
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, var(--accent-green), #059669);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
    }

    .commodity-info h3 {
        font-size: 18px;
        margin: 0 0 4px 0;
        color: var(--text-primary);
    }

    .commodity-info .location {
        font-size: 13px;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .trend-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .trend-badge.bullish {
        background: var(--accent-green-light);
        color: #059669;
    }

    .trend-badge.bearish {
        background: #fee2e2;
        color: #dc2626;
    }

    .market-card-body {
        padding: 20px;
    }

    .price-display {
        display: flex;
        align-items: baseline;
        gap: 8px;
        margin-bottom: 16px;
    }

    .price-display .price {
        font-size: 32px;
        font-weight: 700;
        color: var(--accent-green);
    }

    .price-display .unit {
        font-size: 14px;
        color: var(--text-secondary);
    }

    .price-change {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
    }

    .price-change.positive {
        background: var(--accent-green-light);
        color: #059669;
    }

    .price-change.negative {
        background: #fee2e2;
        color: #dc2626;
    }

    .price-details {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid var(--border-color);
    }

    .price-detail {
        text-align: center;
    }

    .price-detail .value {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
    }

    .price-detail .label {
        font-size: 11px;
        color: var(--text-secondary);
        margin-top: 2px;
        text-transform: uppercase;
    }


    .empty-state {
        text-align: center;
        padding: 60px 20px;
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
    }

    .empty-state-icon {
        font-size: 64px;
        margin-bottom: 20px;
    }

    .empty-state h3 {
        font-size: 20px;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .empty-state p {
        color: var(--text-secondary);
        margin-bottom: 20px;
    }

    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }

    .summary-card {
        background: var(--card-bg);
        border-radius: var(--radius-md);
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 16px;
        box-shadow: var(--shadow-sm);
    }

    .summary-card .icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
    }

    .summary-card .icon.green {
        background: var(--accent-green-light);
    }

    .summary-card .icon.blue {
        background: rgba(59, 130, 246, 0.1);
    }

    .summary-card .icon.orange {
        background: rgba(249, 115, 22, 0.1);
    }

    .summary-card .icon.purple {
        background: rgba(139, 92, 246, 0.1);
    }

    .summary-card .info h4 {
        font-size: 24px;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0;
    }

    .summary-card .info p {
        font-size: 13px;
        color: var(--text-secondary);
        margin: 4px 0 0 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-layout">
    <!-- Mobile Sidebar Overlay -->
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">üåæ</div>
            <div>
                <div class="sidebar-title">Smart Farming</div>
                <div class="sidebar-subtitle">Agricultural Platform</div>
            </div>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Main Menu</div>
                <a href="{{ url_for('dashboard.dashboard') }}" class="nav-link">
                    <i class="fas fa-th-large"></i>
                    <span>Dashboard</span>
                </a>
                <a href="{{ url_for('crop.crop_suggestion') }}" class="nav-link">
                    <i class="fas fa-seedling"></i>
                    <span>Crop Suggestion</span>
                </a>
                <a href="{{ url_for('fertilizer.fertilizer_recommend') }}" class="nav-link">
                    <i class="fas fa-flask"></i>
                    <span>Fertilizer Advice</span>
                </a>
                <a href="{{ url_for('market.market_watch') }}" class="nav-link active">
                    <i class="fas fa-chart-line"></i>
                    <span>Market Prices</span>
                    <span class="badge">Live</span>
                </a>
            </div>


        </nav>

        <div class="sidebar-user">
            <div class="user-info" onclick="openProfileModal()" style="cursor: pointer;">
                <div class="user-avatar">{{ user_name[0] if user_name else 'U' }}</div>
                <div class="user-details">
                    <h4>{{ user_name }}</h4>
                    <span>Farmer</span>
                </div>
                <i class="fas fa-chevron-right" style="margin-left: auto; opacity: 0.5; font-size: 12px;"></i>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Mobile Sidebar Toggle -->
        <button class="mobile-sidebar-toggle" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
        </button>

        <!-- Hero Header -->
        <div class="hero-header" style="background: linear-gradient(135deg, var(--accent-blue), #2563eb);">
            <div class="hero-content">
                <div class="welcome-text">
                    <i class="fas fa-chart-line"></i> Real-Time Updates
                </div>
                <h1 class="hero-title">Live Market Prices</h1>
                <p class="hero-subtitle">Track commodity prices across 28,400+ markets in India. Updated daily at 9:00
                    AM.</p>
            </div>
        </div>

        <!-- Stats Bar -->
        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-icon blue"><i class="fas fa-store"></i></div>
                <div class="stat-info">
                    <h4>{{ total_records or '28,400' }}</h4>
                    <span>Total Records</span>
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-icon green"><i class="fas fa-map-marker-alt"></i></div>
                <div class="stat-info">
                    <h4>{{ total_states or '29' }}</h4>
                    <span>States Covered</span>
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-icon orange"><i class="fas fa-carrot"></i></div>
                <div class="stat-info">
                    <h4>50</h4>
                    <span>Commodities</span>
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-icon purple"><i class="fas fa-clock"></i></div>
                <div class="stat-info">
                    <h4>9 AM</h4>
                    <span>Daily Update</span>
                </div>
            </div>
            <div style="margin-left: auto;">
                <a href="{{ url_for('auth.logout') }}"
                    style="background: rgba(239, 68, 68, 0.2); color: #ef4444; padding: 12px 20px; border-radius: 8px; text-decoration: none; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div class="dashboard-content">
            <!-- Filter Card -->
            <div class="filter-card">
                <form method="GET" class="filter-row">
                    <div class="filter-group">
                        <label><i class="fas fa-map"></i> State</label>
                        <select name="state" id="stateSelect" onchange="updateDistricts()">
                            <option value="All States">All States</option>
                            {% for state in states %}
                            <option value="{{ state }}" {% if selected_state==state %}selected{% endif %}>{{ state }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label><i class="fas fa-building"></i> District</label>
                        <select name="district" id="districtSelect">
                            <option value="All Districts">All Districts</option>
                            {% for district in districts %}
                            <option value="{{ district }}" {% if selected_district==district %}selected{% endif %}>{{
                                district }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label><i class="fas fa-carrot"></i> Commodity</label>
                        <input type="text" name="commodity_search" id="commoditySearch"
                            placeholder="Search commodity..."
                            value="{{ selected_commodity if selected_commodity and selected_commodity != 'All' else '' }}"
                            autocomplete="off"
                            style="width: 100%; padding: 12px 16px; border: 2px solid var(--border-color); border-radius: var(--radius-md); font-size: 14px;">
                        <div id="commoditySuggestions"
                            style="display: none; position: absolute; background: white; border: 1px solid var(--border-color); border-radius: 8px; max-height: 200px; overflow-y: auto; z-index: 100; width: calc(100% - 32px); box-shadow: var(--shadow-md);">
                        </div>
                    </div>
                    <div class="filter-group" style="min-width: 180px;">
                        <label><i class="fas fa-filter"></i> Category</label>
                        <select name="commodity" id="commoditySelect">
                            <option value="All" {% if selected_commodity=='All' or not selected_commodity %}selected{%
                                endif %}>All Commodities</option>
                            <optgroup label="ü•¨ Vegetables (30)">
                                <option value="Tomato" {% if selected_commodity=='Tomato' %}selected{% endif %}>Tomato
                                </option>
                                <option value="Onion" {% if selected_commodity=='Onion' %}selected{% endif %}>Onion
                                </option>
                                <option value="Potato" {% if selected_commodity=='Potato' %}selected{% endif %}>Potato
                                </option>
                                <option value="Brinjal" {% if selected_commodity=='Brinjal' %}selected{% endif %}>
                                    Brinjal</option>
                                <option value="Cabbage" {% if selected_commodity=='Cabbage' %}selected{% endif %}>
                                    Cabbage</option>
                                <option value="Cauliflower" {% if selected_commodity=='Cauliflower' %}selected{% endif
                                    %}>Cauliflower</option>
                                <option value="Carrot" {% if selected_commodity=='Carrot' %}selected{% endif %}>Carrot
                                </option>
                                <option value="Beetroot" {% if selected_commodity=='Beetroot' %}selected{% endif %}>
                                    Beetroot</option>
                                <option value="Green Chilli" {% if selected_commodity=='Green Chilli' %}selected{% endif
                                    %}>Green Chilli</option>
                                <option value="Capsicum (Green)" {% if selected_commodity=='Capsicum (Green)'
                                    %}selected{% endif %}>Capsicum (Green)</option>
                                <option value="Capsicum (Red)" {% if selected_commodity=='Capsicum (Red)' %}selected{%
                                    endif %}>Capsicum (Red)</option>
                                <option value="Capsicum (Yellow)" {% if selected_commodity=='Capsicum (Yellow)'
                                    %}selected{% endif %}>Capsicum (Yellow)</option>
                                <option value="Beans" {% if selected_commodity=='Beans' %}selected{% endif %}>Beans
                                </option>
                                <option value="Cluster Beans" {% if selected_commodity=='Cluster Beans' %}selected{%
                                    endif %}>Cluster Beans</option>
                                <option value="Lady Finger" {% if selected_commodity=='Lady Finger' %}selected{% endif
                                    %}>Lady Finger</option>
                                <option value="Drumstick" {% if selected_commodity=='Drumstick' %}selected{% endif %}>
                                    Drumstick</option>
                                <option value="Bottle Gourd" {% if selected_commodity=='Bottle Gourd' %}selected{% endif
                                    %}>Bottle Gourd</option>
                                <option value="Ridge Gourd" {% if selected_commodity=='Ridge Gourd' %}selected{% endif
                                    %}>Ridge Gourd</option>
                                <option value="Snake Gourd" {% if selected_commodity=='Snake Gourd' %}selected{% endif
                                    %}>Snake Gourd</option>
                                <option value="Bitter Gourd" {% if selected_commodity=='Bitter Gourd' %}selected{% endif
                                    %}>Bitter Gourd</option>
                                <option value="Pumpkin" {% if selected_commodity=='Pumpkin' %}selected{% endif %}>
                                    Pumpkin</option>
                                <option value="Ash Gourd" {% if selected_commodity=='Ash Gourd' %}selected{% endif %}>
                                    Ash Gourd</option>
                                <option value="Radish" {% if selected_commodity=='Radish' %}selected{% endif %}>Radish
                                </option>
                                <option value="Turnip" {% if selected_commodity=='Turnip' %}selected{% endif %}>Turnip
                                </option>
                                <option value="Sweet Corn" {% if selected_commodity=='Sweet Corn' %}selected{% endif %}>
                                    Sweet Corn</option>
                                <option value="Peas" {% if selected_commodity=='Peas' %}selected{% endif %}>Peas
                                </option>
                                <option value="Garlic" {% if selected_commodity=='Garlic' %}selected{% endif %}>Garlic
                                </option>
                                <option value="Ginger" {% if selected_commodity=='Ginger' %}selected{% endif %}>Ginger
                                </option>
                                <option value="Coriander Leaves" {% if selected_commodity=='Coriander Leaves'
                                    %}selected{% endif %}>Coriander Leaves</option>
                                <option value="Spinach" {% if selected_commodity=='Spinach' %}selected{% endif %}>
                                    Spinach</option>
                            </optgroup>
                            <optgroup label="üçé Fruits (20)">
                                <option value="Apple" {% if selected_commodity=='Apple' %}selected{% endif %}>Apple
                                </option>
                                <option value="Banana" {% if selected_commodity=='Banana' %}selected{% endif %}>Banana
                                </option>
                                <option value="Orange" {% if selected_commodity=='Orange' %}selected{% endif %}>Orange
                                </option>
                                <option value="Mosambi" {% if selected_commodity=='Mosambi' %}selected{% endif %}>
                                    Mosambi</option>
                                <option value="Grapes" {% if selected_commodity=='Grapes' %}selected{% endif %}>Grapes
                                </option>
                                <option value="Pomegranate" {% if selected_commodity=='Pomegranate' %}selected{% endif
                                    %}>Pomegranate</option>
                                <option value="Papaya" {% if selected_commodity=='Papaya' %}selected{% endif %}>Papaya
                                </option>
                                <option value="Pineapple" {% if selected_commodity=='Pineapple' %}selected{% endif %}>
                                    Pineapple</option>
                                <option value="Watermelon" {% if selected_commodity=='Watermelon' %}selected{% endif %}>
                                    Watermelon</option>
                                <option value="Muskmelon" {% if selected_commodity=='Muskmelon' %}selected{% endif %}>
                                    Muskmelon</option>
                                <option value="Mango" {% if selected_commodity=='Mango' %}selected{% endif %}>Mango
                                </option>
                                <option value="Guava" {% if selected_commodity=='Guava' %}selected{% endif %}>Guava
                                </option>
                                <option value="Lemon" {% if selected_commodity=='Lemon' %}selected{% endif %}>Lemon
                                </option>
                                <option value="Custard Apple" {% if selected_commodity=='Custard Apple' %}selected{%
                                    endif %}>Custard Apple</option>
                                <option value="Sapota" {% if selected_commodity=='Sapota' %}selected{% endif %}>Sapota
                                </option>
                                <option value="Strawberry" {% if selected_commodity=='Strawberry' %}selected{% endif %}>
                                    Strawberry</option>
                                <option value="Kiwi" {% if selected_commodity=='Kiwi' %}selected{% endif %}>Kiwi
                                </option>
                                <option value="Pear" {% if selected_commodity=='Pear' %}selected{% endif %}>Pear
                                </option>
                                <option value="Plum" {% if selected_commodity=='Plum' %}selected{% endif %}>Plum
                                </option>
                                <option value="Peach" {% if selected_commodity=='Peach' %}selected{% endif %}>Peach
                                </option>
                            </optgroup>
                        </select>
                    </div>
                    <button type="submit" class="filter-btn">
                        <i class="fas fa-search"></i> Search
                    </button>
                </form>
            </div>

            <!-- Summary Cards -->
            <div class="summary-cards">
                <div class="summary-card">
                    <div class="icon green">üìà</div>
                    <div class="info">
                        <h4>{{ bullish_count or '0' }}</h4>
                        <p>Prices Rising</p>
                    </div>
                </div>
                <div class="summary-card">
                    <div class="icon blue">üìâ</div>
                    <div class="info">
                        <h4>{{ bearish_count or '0' }}</h4>
                        <p>Prices Falling</p>
                    </div>
                </div>
                <div class="summary-card">
                    <div class="icon orange">ü•¨</div>
                    <div class="info">
                        <h4>{{ vegetable_count or '30' }}</h4>
                        <p>Vegetables</p>
                    </div>
                </div>
                <div class="summary-card">
                    <div class="icon purple">üçé</div>
                    <div class="info">
                        <h4>{{ fruit_count or '20' }}</h4>
                        <p>Fruits</p>
                    </div>
                </div>
            </div>

            <!-- Market Grid -->
            {% if market_data %}

            <!-- Vegetables Section -->
            {% if vegetables %}
            <div style="margin-bottom: 40px;">
                <div
                    style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 3px solid var(--accent-green);">
                    <div
                        style="width: 50px; height: 50px; background: linear-gradient(135deg, var(--accent-green), #059669); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 28px;">
                        ü•¨
                    </div>
                    <div>
                        <h2 style="margin: 0; font-size: 24px; color: var(--text-primary);">Vegetables</h2>
                        <p style="margin: 4px 0 0 0; color: var(--text-secondary); font-size: 14px;">{{
                            vegetables|length }} items available</p>
                    </div>
                </div>
                <div class="market-grid">
                    {% for item in vegetables %}
                    <div class="market-card {{ 'bearish' if item.change < 0 else '' }}">
                        <div class="market-card-header">
                            <div class="commodity-info">
                                <div class="commodity-icon">
                                    ü•¨
                                </div>
                                <div>
                                    <h3>{{ item.commodity }}</h3>
                                    <div class="location">
                                        <i class="fas fa-map-marker-alt"></i>
                                        {{ item.district }}, {{ item.state }}
                                    </div>
                                </div>
                            </div>
                            <span class="trend-badge {{ 'bullish' if item.change >= 0 else 'bearish' }}">
                                {{ 'Bullish' if item.change >= 0 else 'Bearish' }}
                            </span>
                        </div>
                        <div class="market-card-body">
                            <div class="price-display">
                                <span class="price">‚Çπ{{ (item.modal_price / 100)|round(2) }}</span>
                                <span class="unit">per kg</span>
                            </div>
                            <span class="price-change {{ 'positive' if item.change >= 0 else 'negative' }}">
                                <i class="fas fa-arrow-{{ 'up' if item.change >= 0 else 'down' }}"></i>
                                {{ item.change|abs }}% from yesterday
                            </span>
                            <div class="price-details">
                                <div class="price-detail">
                                    <div class="value">‚Çπ{{ (item.min_price / 100)|round(2) }}</div>
                                    <div class="label">Min</div>
                                </div>
                                <div class="price-detail">
                                    <div class="value">‚Çπ{{ (item.modal_price / 100)|round(2) }}</div>
                                    <div class="label">Modal</div>
                                </div>
                                <div class="price-detail">
                                    <div class="value">‚Çπ{{ (item.max_price / 100)|round(2) }}</div>
                                    <div class="label">Max</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Fruits Section -->
            {% if fruits %}
            <div style="margin-bottom: 40px;">
                <div
                    style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 3px solid #f97316;">
                    <div
                        style="width: 50px; height: 50px; background: linear-gradient(135deg, #f97316, #ea580c); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 28px;">
                        üçé
                    </div>
                    <div>
                        <h2 style="margin: 0; font-size: 24px; color: var(--text-primary);">Fruits</h2>
                        <p style="margin: 4px 0 0 0; color: var(--text-secondary); font-size: 14px;">{{ fruits|length }}
                            items available</p>
                    </div>
                </div>
                <div class="market-grid">
                    {% for item in fruits %}
                    <div class="market-card {{ 'bearish' if item.change < 0 else '' }}">
                        <div class="market-card-header">
                            <div class="commodity-info">
                                <div class="commodity-icon"
                                    style="background: linear-gradient(135deg, #f97316, #ea580c);">
                                    üçé
                                </div>
                                <div>
                                    <h3>{{ item.commodity }}</h3>
                                    <div class="location">
                                        <i class="fas fa-map-marker-alt"></i>
                                        {{ item.district }}, {{ item.state }}
                                    </div>
                                </div>
                            </div>
                            <span class="trend-badge {{ 'bullish' if item.change >= 0 else 'bearish' }}">
                                {{ 'Bullish' if item.change >= 0 else 'Bearish' }}
                            </span>
                        </div>
                        <div class="market-card-body">
                            <div class="price-display">
                                <span class="price">‚Çπ{{ (item.modal_price / 100)|round(2) }}</span>
                                <span class="unit">per kg</span>
                            </div>
                            <span class="price-change {{ 'positive' if item.change >= 0 else 'negative' }}">
                                <i class="fas fa-arrow-{{ 'up' if item.change >= 0 else 'down' }}"></i>
                                {{ item.change|abs }}% from yesterday
                            </span>
                            <div class="price-details">
                                <div class="price-detail">
                                    <div class="value">‚Çπ{{ (item.min_price / 100)|round(2) }}</div>
                                    <div class="label">Min</div>
                                </div>
                                <div class="price-detail">
                                    <div class="value">‚Çπ{{ (item.modal_price / 100)|round(2) }}</div>
                                    <div class="label">Modal</div>
                                </div>
                                <div class="price-detail">
                                    <div class="value">‚Çπ{{ (item.max_price / 100)|round(2) }}</div>
                                    <div class="label">Max</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">üìä</div>
                <h3>No Market Data Available</h3>
                <p>Select a state and district to view market prices</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script id="states-data" type="application/json">
    {{ (states_districts or {}) | tojson | safe }}
</script>
<script>
    const statesDistricts = JSON.parse(document.getElementById('states-data').textContent);

    // All 50 commodities for autocomplete
    const allCommodities = [
        // Vegetables (30)
        "Tomato", "Onion", "Potato", "Brinjal", "Cabbage", "Cauliflower",
        "Carrot", "Beetroot", "Green Chilli", "Capsicum (Green)", "Capsicum (Red)",
        "Capsicum (Yellow)", "Beans", "Cluster Beans", "Lady Finger", "Drumstick",
        "Bottle Gourd", "Ridge Gourd", "Snake Gourd", "Bitter Gourd", "Pumpkin",
        "Ash Gourd", "Radish", "Turnip", "Sweet Corn", "Peas", "Garlic",
        "Ginger", "Coriander Leaves", "Spinach",
        // Fruits (20)
        "Apple", "Banana", "Orange", "Mosambi", "Grapes", "Pomegranate",
        "Papaya", "Pineapple", "Watermelon", "Muskmelon", "Mango", "Guava",
        "Lemon", "Custard Apple", "Sapota", "Strawberry", "Kiwi", "Pear",
        "Plum", "Peach"
    ];

    function updateDistricts() {
        const stateSelect = document.getElementById('stateSelect');
        const districtSelect = document.getElementById('districtSelect');
        const selectedState = stateSelect.value;

        districtSelect.innerHTML = '<option value="All Districts">All Districts</option>';

        if (selectedState && selectedState !== 'All States' && statesDistricts[selectedState]) {
            statesDistricts[selectedState].forEach(district => {
                const option = document.createElement('option');
                option.value = district;
                option.textContent = district;
                districtSelect.appendChild(option);
            });
        }
    }

    // Commodity search autocomplete
    const commoditySearch = document.getElementById('commoditySearch');
    const commoditySuggestions = document.getElementById('commoditySuggestions');
    const commoditySelect = document.getElementById('commoditySelect');

    if (commoditySearch) {
        commoditySearch.addEventListener('input', function () {
            const query = this.value.toLowerCase().trim();
            commoditySuggestions.innerHTML = '';

            if (query.length < 1) {
                commoditySuggestions.style.display = 'none';
                return;
            }

            const matches = allCommodities.filter(c => c.toLowerCase().includes(query));

            if (matches.length > 0) {
                commoditySuggestions.style.display = 'block';
                matches.forEach(commodity => {
                    const div = document.createElement('div');
                    div.textContent = commodity;
                    div.style.padding = '10px 16px';
                    div.style.cursor = 'pointer';
                    div.style.borderBottom = '1px solid #e2e8f0';
                    div.addEventListener('mouseenter', function () {
                        this.style.background = '#f1f5f9';
                    });
                    div.addEventListener('mouseleave', function () {
                        this.style.background = 'white';
                    });
                    div.addEventListener('click', function () {
                        commoditySearch.value = commodity;
                        commoditySelect.value = commodity;
                        commoditySuggestions.style.display = 'none';
                    });
                    commoditySuggestions.appendChild(div);
                });
            } else {
                commoditySuggestions.style.display = 'none';
            }
        });

        // Hide suggestions when clicking outside
        document.addEventListener('click', function (e) {
            if (!commoditySearch.contains(e.target) && !commoditySuggestions.contains(e.target)) {
                commoditySuggestions.style.display = 'none';
            }
        });

        // Clear dropdown when using search
        commoditySearch.addEventListener('focus', function () {
            if (this.value) {
                commoditySelect.value = 'All';
            }
        });
    }

    // Clear search when using dropdown
    if (commoditySelect) {
        commoditySelect.addEventListener('change', function () {
            if (this.value !== 'All') {
                commoditySearch.value = '';
            }
        });
    }

    // Mobile Sidebar Toggle
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.querySelector('.sidebar-overlay');
        sidebar.classList.toggle('active');
        overlay.classList.toggle('active');
    }
</script>
{% endblock %}