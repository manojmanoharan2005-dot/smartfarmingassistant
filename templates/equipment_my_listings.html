{% extends "base.html" %}

{% block title %}My Equipment - Equipment Sharing{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/buyer_connect.css') }}">
{% endblock %}

{% block content %}
<div class="dashboard-layout">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">üåæ</div>
            <div>
                <div class="sidebar-title">Smart Farming</div>
                <div class="sidebar-subtitle">Agricultural Platform</div>
            </div>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Main Menu</div>
                <a href="{{ url_for('dashboard.dashboard') }}" class="nav-link">
                    <i class="fas fa-th-large"></i>
                    <span>Dashboard</span>
                </a>
                <a href="{{ url_for('crop.crop_suggestion') }}" class="nav-link">
                    <i class="fas fa-seedling"></i>
                    <span>Crop Suggestion</span>
                </a>
                <a href="{{ url_for('fertilizer.fertilizer_recommend') }}" class="nav-link">
                    <i class="fas fa-flask"></i>
                    <span>Fertilizer Advice</span>
                </a>
                <a href="{{ url_for('market.market_watch') }}" class="nav-link">
                    <i class="fas fa-chart-line"></i>
                    <span>Market Prices</span>
                    <span class="badge">Live</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Equipment Sharing</div>
                <a href="{{ url_for('equipment_sharing.create_listing') }}" class="nav-link">
                    <i class="fas fa-plus-circle"></i>
                    <span>List My Equipment</span>
                </a>
                <a href="{{ url_for('equipment_sharing.my_listings') }}" class="nav-link active">
                    <i class="fas fa-list-alt"></i>
                    <span>My Equipment</span>
                </a>
                <a href="{{ url_for('equipment_sharing.marketplace') }}" class="nav-link">
                    <i class="fas fa-store"></i>
                    <span>Rent Equipment</span>
                    <span class="badge" style="background: #3b82f6;">New</span>
                </a>
            </div>
        </nav>

        <div class="sidebar-user">
            <div class="user-info">
                <div class="user-avatar">{{ session.get('user_name', 'U')[0] }}</div>
                <div class="user-details">
                    <h4>{{ session.get('user_name', 'User') }}</h4>
                    <span>Farmer</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Page Header -->
        <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1>
                    <i class="fas fa-list-alt"></i> My Equipment
                </h1>
                <p class="page-subtitle">Manage your equipment listings and track rentals</p>
            </div>
            <a href="{{ url_for('equipment_sharing.create_listing') }}" class="btn-submit">
                <i class="fas fa-plus-circle"></i> Create New Listing
            </a>
        </div>

        <!-- Listings -->
        {% if listings %}
        <div class="listings-grid" style="display: grid; gap: 24px; margin-top: 32px;">
            {% for listing in listings %}
            <div class="listing-card"
                style="background: white; border-radius: var(--radius-lg); box-shadow: var(--shadow-md); overflow: hidden; border-left: 4px solid {% if listing.status == 'available' %}var(--accent-green){% elif listing.status == 'booked' %}#f59e0b{% elif listing.status == 'completed' %}var(--accent-blue){% else %}var(--text-muted){% endif %};">
                <div
                    style="display: grid; grid-template-columns: auto 1fr auto; gap: 24px; padding: 28px; align-items: center;">
                    <!-- Equipment Icon -->
                    <div
                        style="width: 90px; height: 90px; background: linear-gradient(135deg, var(--accent-green), #059669); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; font-size: 48px; box-shadow: 0 4px 12px rgba(34, 197, 94, 0.2);">
                        {% if listing.equipment_name == 'Tractor' %}üöú
                        {% elif listing.equipment_name == 'Harvester' %}üöÅ
                        {% elif listing.equipment_name == 'Plough' %}üî®
                        {% elif listing.equipment_name == 'Sprayer' %}üíß
                        {% elif listing.equipment_name == 'Seeder' %}üå±
                        {% elif listing.equipment_name == 'Cultivator' %}‚öôÔ∏è
                        {% elif listing.equipment_name == 'Thresher' %}üîß
                        {% elif listing.equipment_name == 'Rotavator' %}üõ†Ô∏è
                        {% else %}üöú{% endif %}
                    </div>

                    <!-- Details -->
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
                            <h3 style="font-size: 26px; font-weight: 700; color: var(--text-primary); margin: 0;">{{
                                listing.equipment_name }}</h3>
                            {% if listing.status == 'available' %}
                            <span class="status-badge"
                                style="background: #dcfce7; color: #166534; padding: 6px 16px; border-radius: 20px; font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">
                                <i class="fas fa-check-circle"></i> AVAILABLE
                            </span>
                            {% elif listing.status == 'booked' %}
                            <span class="status-badge"
                                style="background: #fef3c7; color: #92400e; padding: 6px 16px; border-radius: 20px; font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">
                                <i class="fas fa-clock"></i> BOOKED
                            </span>
                            {% elif listing.status == 'completed' %}
                            <span class="status-badge"
                                style="background: #dbeafe; color: #1e40af; padding: 6px 16px; border-radius: 20px; font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">
                                <i class="fas fa-check-double"></i> COMPLETED
                            </span>
                            {% elif listing.status == 'cancelled' %}
                            <span class="status-badge"
                                style="background: #f1f5f9; color: #64748b; padding: 6px 16px; border-radius: 20px; font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">
                                <i class="fas fa-times-circle"></i> CANCELLED
                            </span>
                            {% endif %}
                        </div>

                        <div
                            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 20px; margin-bottom: 12px;">
                            <div>
                                <div
                                    style="font-size: 12px; color: var(--text-secondary); margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                                    Rent</div>
                                <div style="font-weight: 800; color: var(--accent-green); font-size: 22px;">‚Çπ{{
                                    "%.2f"|format(listing.owner_rent) }}/day</div>
                            </div>
                            <div>
                                <div
                                    style="font-size: 12px; color: var(--text-secondary); margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                                    Available From</div>
                                <div style="font-weight: 600; color: var(--text-primary); font-size: 15px;">
                                    <i class="fas fa-calendar-alt" style="color: var(--accent-blue);"></i> {{
                                    listing.available_from }}
                                </div>
                            </div>
                            <div>
                                <div
                                    style="font-size: 12px; color: var(--text-secondary); margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                                    Available To</div>
                                <div style="font-weight: 600; color: var(--text-primary); font-size: 15px;">
                                    <i class="fas fa-calendar-alt" style="color: var(--accent-blue);"></i> {{
                                    listing.available_to }}
                                </div>
                            </div>
                            <div>
                                <div
                                    style="font-size: 12px; color: var(--text-secondary); margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                                    Location</div>
                                <div style="font-weight: 600; color: var(--text-primary); font-size: 15px;">
                                    <i class="fas fa-map-marker-alt" style="color: var(--accent-red);"></i> {{
                                    listing.district }}, {{ listing.state }}
                                </div>
                            </div>
                            <div>
                                <div
                                    style="font-size: 12px; color: var(--text-secondary); margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                                    Posted On</div>
                                <div style="font-weight: 600; color: var(--text-primary); font-size: 15px;">
                                    <i class="fas fa-calendar-alt" style="color: var(--accent-blue);"></i> {{
                                    listing.created_at[:10] }}
                                </div>
                            </div>
                        </div>

                        {% if listing.status == 'booked' and listing.renter_name %}
                        <div
                            style="margin-top: 16px; padding: 14px 18px; background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: var(--radius-md); border-left: 4px solid #f59e0b; box-shadow: 0 2px 6px rgba(245, 158, 11, 0.2);">
                            <div style="font-size: 14px; color: #92400e; font-weight: 600; margin-bottom: 6px;">
                                <i class="fas fa-user-check"></i> <strong>Rented by:</strong> {{ listing.renter_name }}
                                ‚Ä¢ üìû {{ listing.renter_phone }}
                            </div>
                            <div style="font-size: 13px; color: #92400e;">
                                <i class="fas fa-calendar"></i> {{ listing.rental_from }} to {{ listing.rental_to }} ‚Ä¢
                                <strong>Total Rent:</strong> ‚Çπ{{ "%.2f"|format(listing.total_rent) }}
                            </div>
                        </div>
                        {% endif %}

                        {% if listing.description %}
                        <div
                            style="margin-top: 14px; padding: 12px 16px; background: var(--bg-secondary); border-radius: var(--radius-md); font-size: 14px; color: var(--text-secondary); line-height: 1.6;">
                            <i class="fas fa-align-left" style="color: var(--accent-blue);"></i> {{ listing.description
                            }}
                        </div>
                        {% endif %}
                    </div>

                    <!-- Actions -->
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        {% if listing.status == 'available' %}
                        <button onclick="cancelListing('{{ listing['_id'] }}', this)" class="btn-delete"
                            style="padding: 12px 24px; background: linear-gradient(135deg, #fee2e2, #fecaca); color: #dc2626; border: 2px solid #fca5a5; border-radius: var(--radius-md); font-weight: 700; cursor: pointer; white-space: nowrap; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(220, 38, 38, 0.2);">
                            <i class="fas fa-trash-alt"></i> Cancel
                        </button>
                        {% elif listing.status == 'booked' %}
                        <button onclick="completeListing('{{ listing['_id'] }}', this)" class="btn-submit"
                            style="padding: 12px 24px; background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: 2px solid #60a5fa; border-radius: var(--radius-md); font-weight: 700; cursor: pointer; white-space: nowrap; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);">
                            <i class="fas fa-check"></i> Complete
                        </button>
                        {% elif listing.status == 'cancelled' %}
                        <button disabled
                            style="padding: 12px 24px; background: #f1f5f9; color: #94a3b8; border: 2px solid #e2e8f0; border-radius: var(--radius-md); font-weight: 600; cursor: not-allowed; white-space: nowrap;">
                            <i class="fas fa-ban"></i> Cancelled
                        </button>
                        {% elif listing.status == 'completed' %}
                        <button disabled
                            style="padding: 12px 24px; background: #dbeafe; color: #1e40af; border: 2px solid #93c5fd; border-radius: var(--radius-md); font-weight: 600; cursor: not-allowed; white-space: nowrap;">
                            <i class="fas fa-check-double"></i> Completed
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-state-icon">üöú</div>
            <h3>No Equipment Listed Yet</h3>
            <p style="margin-bottom: 24px;">You haven't listed any equipment yet. Start sharing your equipment with
                other farmers!</p>
            <a href="{{ url_for('equipment_sharing.create_listing') }}" class="btn-submit">
                <i class="fas fa-plus-circle"></i> List Your First Equipment
            </a>
        </div>
        {% endif %}
    </div>
</div>

<script>
    function cancelListing(listingId, button) {
        if (!listingId) {
            alert('Error: Invalid Listing ID');
            console.error('Missing listing ID');
            return;
        }

        if (!confirm('‚ö†Ô∏è Are you sure you want to cancel this listing? This action cannot be undone.')) {
            return;
        }

        if (button) {
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cancelling...';
        }

        const apiBase = "{{ url_for('equipment_sharing.api_cancel_listing', listing_id='0') }}";
        const url = apiBase.replace('0', listingId);

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            }
        })
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    return response.json().then(err => { throw err; }).catch(() => {
                        throw new Error('Server error: ' + response.status);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Cancel data:', data);
                if (data.success) {
                    if (window.showToast) {
                        showToast('Listing cancelled successfully!', 'success');
                    } else {
                        alert('‚úÖ Listing cancelled successfully!');
                    }
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    throw new Error(data.error || 'Failed to cancel listing');
                }
            })
            .catch(error => {
                console.error('Cancel error:', error);
                const errorMsg = error.error || error.message || 'Failed to cancel listing';
                if (window.showToast) {
                    showToast('Error: ' + errorMsg, 'error');
                } else {
                    alert('Error: ' + errorMsg);
                }
                if (button) {
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-trash-alt"></i> Cancel';
                }
            });
    }

    function completeListing(listingId, button) {
        if (!listingId) {
            alert('Error: Invalid Listing ID');
            console.error('Missing listing ID');
            return;
        }

        if (!confirm('‚úÖ Mark this rental as completed?')) {
            return;
        }

        if (button) {
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Completing...';
        }

        fetch('/equipment-sharing/api/complete-rental/' + listingId, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            }
        })
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    return response.json().then(err => { throw err; }).catch(() => {
                        throw new Error('Server error: ' + response.status);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Complete data:', data);
                if (data.success) {
                    if (window.showToast) {
                        showToast('Rental completed successfully!', 'success');
                    } else {
                        alert('‚úÖ Rental completed successfully!');
                    }
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    throw new Error(data.error || 'Failed to complete rental');
                }
            })
            .catch(error => {
                console.error('Complete error:', error);
                const errorMsg = error.error || error.message || 'Failed to complete rental';
                if (window.showToast) {
                    showToast('Error: ' + errorMsg, 'error');
                } else {
                    alert('Error: ' + errorMsg);
                }
                if (button) {
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-check"></i> Complete';
                }
            });
    }
</script>

<style>
    .btn-delete:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3) !important;
        background: linear-gradient(135deg, #fca5a5, #f87171) !important;
    }

    .btn-submit:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4) !important;
    }

    .listing-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12) !important;
    }
</style>
{% endblock %}