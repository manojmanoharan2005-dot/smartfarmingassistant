{% extends "base.html" %}

{% block title %}Dashboard - Smart Farming Assistant{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}


{% block content %}
<div class="dashboard-layout">
    <!-- Mobile Sidebar Overlay -->
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">üåæ</div>
            <div>
                <div class="sidebar-title">Smart Farming</div>
                <div class="sidebar-subtitle">Agricultural Platform</div>
            </div>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Main Menu</div>
                <a href="{{ url_for('dashboard.dashboard') }}" class="nav-link active">
                    <i class="fas fa-th-large"></i>
                    <span>Dashboard</span>
                </a>
                <a href="{{ url_for('crop.crop_suggestion') }}" class="nav-link">
                    <i class="fas fa-seedling"></i>
                    <span>Crop Suggestion</span>
                </a>
                <a href="{{ url_for('fertilizer.fertilizer_recommend') }}" class="nav-link">
                    <i class="fas fa-flask"></i>
                    <span>Fertilizer Advice</span>
                </a>
                <a href="{{ url_for('market.market_watch') }}" class="nav-link">
                    <i class="fas fa-chart-line"></i>
                    <span>Market Prices</span>
                    <span class="badge">Live</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Buyer Connect</div>
                <a href="{{ url_for('buyer_connect.create_listing') }}" class="nav-link">
                    <i class="fas fa-plus-circle"></i>
                    <span>Sell My Crop</span>
                </a>
                <a href="{{ url_for('buyer_connect.my_listings') }}" class="nav-link">
                    <i class="fas fa-list-alt"></i>
                    <span>My Listings</span>
                </a>
                <a href="{{ url_for('buyer_connect.marketplace') }}" class="nav-link">
                    <i class="fas fa-store"></i>
                    <span>Buy from Farmers</span>
                    <span class="badge" style="background: #3b82f6;">New</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Tools</div>
                <a href="#" class="nav-link" onclick="openCalculatorModal(); return false;">
                    <i class="fas fa-calculator"></i>
                    <span>Expense Calculator</span>
                </a>
                <a href="#" class="nav-link" onclick="openWeatherModal(); return false;">
                    <i class="fas fa-cloud-sun"></i>
                    <span>Weather Forecast</span>
                </a>
                <a href="#" class="nav-link" onclick="openGovtSchemesModal(); return false;">
                    <i class="fas fa-landmark"></i>
                    <span>Govt. Schemes</span>
                </a>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">Equipment Sharing</div>
                <a href="{{ url_for('equipment_sharing.create_listing') }}" class="nav-link">
                    <i class="fas fa-plus-circle"></i>
                    <span>List My Equipment</span>
                </a>
                <a href="{{ url_for('equipment_sharing.my_listings') }}" class="nav-link">
                    <i class="fas fa-list-alt"></i>
                    <span>My Equipment</span>
                </a>
                <a href="{{ url_for('equipment_sharing.marketplace') }}" class="nav-link">
                    <i class="fas fa-store"></i>
                    <span>Rent Equipment</span>
                    <span class="badge" style="background: #10b981;">Live</span>
                </a>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">Resources</div>
                <a href="#" class="nav-link" onclick="openFarmersManualModal(); return false;">
                    <i class="fas fa-book"></i>
                    <span>Farmer's Manual</span>
                </a>
            </div>
        </nav>

        <div class="sidebar-user">
            <div class="user-info" onclick="openProfileModal()" style="cursor: pointer;">
                <div class="user-avatar">{{ user_name[0] if user_name else 'U' }}</div>
                <div class="user-details">
                    <h4>{{ user_name }}</h4>
                    <span>Farmer</span>
                </div>
                <i class="fas fa-chevron-right" style="margin-left: auto; opacity: 0.5; font-size: 12px;"></i>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Mobile Sidebar Toggle -->
        <button class="mobile-sidebar-toggle" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
        </button>

        <!-- Hero Header -->
        <div class="hero-header">
            <div class="hero-content">
                <div class="welcome-text">
                    <i class="fas fa-sun"></i> Good {{ 'Morning' if current_hour < 12 else ('Afternoon' if current_hour
                        < 17 else 'Evening' ) }}! </div>
                        <h1 class="hero-title">Welcome to Smart Farming</h1>
                        <p class="hero-subtitle">Your personalized agricultural assistant. Monitor crops, get
                            recommendations, and maximize your yields.</p>
                </div>
                <div class="hero-date">
                    <div class="day">{{ current_day }}</div>
                    <div class="month-year">{{ current_month }} {{ current_year }}</div>
                </div>
            </div>

            <!-- Stats Bar -->
            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-icon green">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-info">
                        <h4>{{ stats.total_recommendations }}</h4>
                        <span>Recommendations</span>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon blue">
                        <i class="fas fa-seedling"></i>
                    </div>
                    <div class="stat-info">
                        <h4>{{ stats.active_crops }}</h4>
                        <span>Active Crops</span>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon purple">
                        <i class="fas fa-flask"></i>
                    </div>
                    <div class="stat-info">
                        <h4>{{ stats.fertilizers_saved }}</h4>
                        <span>Fertilizers Saved</span>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon orange">
                        <i class="fas fa-chart-pie"></i>
                    </div>
                    <div class="stat-info">
                        <h4>{{ stats.crops_suggested }}</h4>
                        <span>Crops Suggested</span>
                    </div>
                </div>
                <div style="margin-left: auto; display: flex; gap: 12px; align-items: center;">
                    <!-- Notification Button -->
                    <button class="notification-toggle-btn" onclick="toggleNotificationPanel()"
                        style="width: 44px; height: 44px; font-size: 18px; background: rgba(59, 130, 246, 0.15); color: #3b82f6; border: none; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; position: relative; transition: all 0.3s ease;">
                        <i class="fas fa-bell"></i>
                        {% if notifications %}
                        <span
                            style="position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; border-radius: 50%; min-width: 20px; height: 20px; font-size: 11px; display: flex; align-items: center; justify-content: center; font-weight: 700; border: 2px solid #1a1c1e; box-shadow: 0 0 10px rgba(239, 68, 68, 0.4);">{{
                            notifications|length }}</span>
                        {% endif %}
                    </button>

                    <!-- Notification Panel -->
                    <div id="notificationPanel" class="notification-panel"
                        style="display: none; position: absolute; top: 80px; right: 20px; width: 420px; background: rgba(30, 41, 59, 0.98); backdrop-filter: blur(12px); border: 1px solid rgba(51, 65, 85, 0.5); border-radius: 16px; box-shadow: 0 20px 40px rgba(0,0,0,0.4); z-index: 1000; overflow: hidden; transform-origin: top right; animation: panelSlide 0.2s ease;">
                        <div class="panel-header"
                            style="padding: 18px 24px; border-bottom: 1px solid rgba(51, 65, 85, 0.5); display: flex; justify-content: space-between; align-items: center; background: rgba(255, 255, 255, 0.03);">
                            <h3
                                style="font-size: 1.1rem; font-weight: 600; color: #f1f5f9; margin: 0; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-bell" style="color: #64748b; font-size: 0.9em;"></i> Notifications
                            </h3>
                            <button onclick="markAllRead()"
                                style="background: transparent; border: 1px solid rgba(59, 130, 246, 0.3); color: #60a5fa; font-size: 0.85rem; cursor: pointer; padding: 6px 12px; border-radius: 6px; transition: all 0.2s;">
                                Mark all read
                            </button>
                        </div>
                        <div class="panel-body" style="max-height: 400px; overflow-y: auto;">
                            {% if notifications %}
                            {% for notif in notifications %}
                            <div class="notification-item"
                                style="padding: 16px 24px; border-bottom: 1px solid rgba(51, 65, 85, 0.3); display: flex; gap: 16px; align-items: start; transition: background 0.2s;">
                                <div class="notif-icon"
                                    style="width: 42px; height: 42px; border-radius: 12px; display: flex; align-items: center; justify-content: center; background: rgba(59, 130, 246, 0.15); color: #3b82f6; flex-shrink: 0; font-size: 1.2rem;">
                                    {% if notif.type == 'success' %}<i class="fas fa-check-circle"
                                        style="color: #10b981;"></i>
                                    {% elif notif.type == 'warning' %}<i class="fas fa-exclamation-triangle"
                                        style="color: #f59e0b;"></i>
                                    {% elif notif.type == 'alert' %}<i class="fas fa-bell" style="color: #ef4444;"></i>
                                    {% else %}<i class="fas fa-info-circle"></i>{% endif %}
                                </div>
                                <div style="flex: 1;">
                                    <p
                                        style="margin: 0; color: #f1f5f9; font-size: 0.95rem; line-height: 1.5; font-weight: 500;">
                                        {{
                                        notif.message }}</p>
                                    <span
                                        style="font-size: 0.85rem; color: #94a3b8; display: block; margin-top: 6px; display: flex; align-items: center; gap: 4px;">
                                        <i class="far fa-clock" style="font-size: 10px;"></i> {{ notif.time_ago }}
                                    </span>
                                </div>
                            </div>
                            {% endfor %}
                            {% else %}
                            <div style="padding: 40px; text-align: center; color: #64748b;">
                                <div
                                    style="width: 60px; height: 60px; background: rgba(148, 163, 184, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
                                    <i class="fas fa-bell-slash" style="font-size: 24px; opacity: 0.7;"></i>
                                </div>
                                <p style="margin: 0; font-size: 1rem; color: #cbd5e1;">No new alerts</p>
                                <p style="margin: 4px 0 0; font-size: 0.85rem; opacity: 0.7;">You're all caught up!</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <script>
                        function toggleNotificationPanel() {
                            const panel = document.getElementById('notificationPanel');
                            if (panel.style.display === 'none') {
                                panel.style.display = 'block';
                            } else {
                                panel.style.display = 'none';
                            }
                        }

                        // Close panel when clicking outside
                        document.addEventListener('click', function (event) {
                            const panel = document.getElementById('notificationPanel');
                            const btn = document.querySelector('.notification-toggle-btn');
                            if (panel && btn && !panel.contains(event.target) && !btn.contains(event.target)) {
                                panel.style.display = 'none';
                            }
                        });

                        function markAllRead() {
                            fetch('/mark-notifications-read', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                }
                            })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        toggleNotificationPanel();
                                        showToast('All notifications marked as read', 'success');
                                        // Remove badge
                                        const badge = document.querySelector('.notification-toggle-btn span');
                                        if (badge) badge.remove();
                                        // Clear list
                                        const list = document.querySelector('.panel-body');
                                        if (list) {
                                            list.innerHTML = '<div style="padding: 32px; text-align: center; color: #64748b;"><i class="fas fa-bell-slash" style="font-size: 24px; margin-bottom: 8px; opacity: 0.5;"></i><p style="margin: 0; font-size: 13px;">No new alerts</p></div>';
                                        }
                                    } else {
                                        showToast('Failed to mark notifications', 'error');
                                    }
                                })
                                .catch(error => {
                                    console.error('Error:', error);
                                    showToast('Error marking notifications', 'error');
                                });
                        }
                    </script>

                    <!-- Download Button -->
                    <div style="position: relative;">
                        <button class="download-toggle-btn" onclick="toggleDownloadPanel()"
                            style="width: 44px; height: 44px; font-size: 18px; background: rgba(16, 185, 129, 0.15); color: #10b981; border: none; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; position: relative; transition: all 0.3s ease;">
                            <i class="fas fa-download"></i>
                        </button>

                        <!-- Download Panel -->
                        <div id="downloadPanel" class="download-panel"
                            style="display: none; position: absolute; top: 55px; right: 0; width: 320px; background: rgba(30, 41, 59, 0.98); backdrop-filter: blur(12px); border: 1px solid rgba(51, 65, 85, 0.5); border-radius: 16px; box-shadow: 0 20px 40px rgba(0,0,0,0.4); z-index: 1000; overflow: hidden;">
                            <div style="padding: 18px 20px; border-bottom: 1px solid rgba(51, 65, 85, 0.5); background: rgba(255, 255, 255, 0.03);">
                                <h3 style="margin: 0; font-size: 1rem; font-weight: 600; color: #f1f5f9; display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-download" style="color: #10b981;"></i> Download Reports
                                </h3>
                                <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #94a3b8;">Export your farming data</p>
                            </div>
                            <div style="padding: 12px;">
                                <a href="{{ url_for('report.download_market_prices_pdf') }}" 
                                    style="display: flex; align-items: center; gap: 14px; padding: 14px 16px; border-radius: 12px; text-decoration: none; transition: all 0.2s; margin-bottom: 8px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1);"
                                    onmouseover="this.style.background='rgba(14, 165, 233, 0.15)'; this.style.borderColor='#0ea5e9';"
                                    onmouseout="this.style.background='rgba(255, 255, 255, 0.05)'; this.style.borderColor='rgba(255, 255, 255, 0.1)';">
                                    <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #0ea5e9, #0284c7); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px;">
                                        üìä
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: #f1f5f9; font-size: 0.9rem;">Market Prices</div>
                                        <div style="font-size: 0.8rem; color: #94a3b8;">Today's commodity prices</div>
                                    </div>
                                    <i class="fas fa-chevron-right" style="color: #64748b; font-size: 12px;"></i>
                                </a>

                                <a href="{{ url_for('report.download_weather_pdf') }}"
                                    style="display: flex; align-items: center; gap: 14px; padding: 14px 16px; border-radius: 12px; text-decoration: none; transition: all 0.2s; margin-bottom: 8px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1);"
                                    onmouseover="this.style.background='rgba(245, 158, 11, 0.15)'; this.style.borderColor='#f59e0b';"
                                    onmouseout="this.style.background='rgba(255, 255, 255, 0.05)'; this.style.borderColor='rgba(255, 255, 255, 0.1)';">
                                    <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px;">
                                        ‚òÅÔ∏è
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: #f1f5f9; font-size: 0.9rem;">Weather Forecast</div>
                                        <div style="font-size: 0.8rem; color: #94a3b8;">7-day weather data</div>
                                    </div>
                                    <i class="fas fa-chevron-right" style="color: #64748b; font-size: 12px;"></i>
                                </a>

                                <a href="{{ url_for('report.download_expense_pdf') }}"
                                    style="display: flex; align-items: center; gap: 14px; padding: 14px 16px; border-radius: 12px; text-decoration: none; transition: all 0.2s; margin-bottom: 8px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1);"
                                    onmouseover="this.style.background='rgba(236, 72, 153, 0.15)'; this.style.borderColor='#ec4899';"
                                    onmouseout="this.style.background='rgba(255, 255, 255, 0.05)'; this.style.borderColor='rgba(255, 255, 255, 0.1)';">
                                    <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #ec4899, #db2777); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px;">
                                        üßÆ
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: #f1f5f9; font-size: 0.9rem;">Expense Calculator</div>
                                        <div style="font-size: 0.8rem; color: #94a3b8;">Last calculation</div>
                                    </div>
                                    <i class="fas fa-chevron-right" style="color: #64748b; font-size: 12px;"></i>
                                </a>

                                <a href="{{ url_for('report.download_crop_progress_pdf') }}"
                                    style="display: flex; align-items: center; gap: 14px; padding: 14px 16px; border-radius: 12px; text-decoration: none; transition: all 0.2s; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1);"
                                    onmouseover="this.style.background='rgba(34, 197, 94, 0.15)'; this.style.borderColor='#22c55e';"
                                    onmouseout="this.style.background='rgba(255, 255, 255, 0.05)'; this.style.borderColor='rgba(255, 255, 255, 0.1)';">
                                    <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #22c55e, #16a34a); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px;">
                                        üå±
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: #f1f5f9; font-size: 0.9rem;">Crop Progress</div>
                                        <div style="font-size: 0.8rem; color: #94a3b8;">Active crops status</div>
                                    </div>
                                    <i class="fas fa-chevron-right" style="color: #64748b; font-size: 12px;"></i>
                                </a>
                            </div>
                        </div>
                    </div>

                    <script>
                        function toggleDownloadPanel() {
                            const panel = document.getElementById('downloadPanel');
                            if (panel.style.display === 'none') {
                                panel.style.display = 'block';
                            } else {
                                panel.style.display = 'none';
                            }
                        }

                        // Close panel when clicking outside
                        document.addEventListener('click', function (event) {
                            const panel = document.getElementById('downloadPanel');
                            const btn = document.querySelector('.download-toggle-btn');
                            if (panel && btn && !panel.contains(event.target) && !btn.contains(event.target)) {
                                panel.style.display = 'none';
                            }
                        });
                    </script>

                    <button class="chatbot-toggle" onclick="openChatbotModal()"
                        style="width: 44px; height: 44px; font-size: 18px;">
                        <i class="fas fa-robot"></i>
                    </button>
                    <a href="{{ url_for('auth.logout') }}"
                        style="background: rgba(239, 68, 68, 0.2); color: #ef4444; padding: 12px 20px; border-radius: 8px; text-decoration: none; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </a>
                </div>
            </div>

            <!-- Dashboard Content -->
            <div class="dashboard-content">
                <div class="dashboard-grid">
                    <!-- Left Column - Live Commodity Feed for User's District -->
                    <div class="left-column">
                        <div class="card card-dark">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-chart-line"></i> Live Commodity Feed
                                </div>
                                <span class="card-badge">Live</span>
                            </div>
                            <div class="card-body">
                                {% if user and user.district %}
                                <div
                                    style="font-size: 12px; color: rgba(255,255,255,0.6); margin-bottom: 12px; display: flex; align-items: center; gap: 6px;">
                                    <i class="fas fa-map-marker-alt"></i> {{ user.district }}, {{ user.state }}
                                </div>
                                {% endif %}
                                <div class="commodity-list">
                                    {% if price_predictions %}
                                    {% for pred in price_predictions[:10] %}
                                    <div class="commodity-item">
                                        <div class="commodity-info">
                                            {% set icon_bg_start = '#3b82f6' %}
                                            {% set icon_bg_end = '#2563eb' %}
                                            {% set icon_symbol = 'üåæ' %}
                                            {% if pred.commodity == 'Potato' %}
                                            {% set icon_bg_start = '#f59e0b' %}{% set icon_bg_end = '#d97706' %}{% set
                                            icon_symbol = 'ü•î' %}
                                            {% elif pred.commodity == 'Tomato' %}
                                            {% set icon_bg_start = '#ef4444' %}{% set icon_bg_end = '#dc2626' %}{% set
                                            icon_symbol = 'üçÖ' %}
                                            {% elif pred.commodity == 'Onion' %}
                                            {% set icon_bg_start = '#a855f7' %}{% set icon_bg_end = '#9333ea' %}{% set
                                            icon_symbol = 'üßÖ' %}
                                            {% elif pred.commodity == 'Carrot' %}
                                            {% set icon_bg_start = '#f97316' %}{% set icon_bg_end = '#ea580c' %}{% set
                                            icon_symbol = 'ü•ï' %}
                                            {% elif pred.commodity == 'Cabbage' %}
                                            {% set icon_bg_start = '#22c55e' %}{% set icon_bg_end = '#16a34a' %}{% set
                                            icon_symbol = 'ü•¨' %}
                                            {% elif pred.commodity == 'Cauliflower' %}
                                            {% set icon_bg_start = '#f5f5f5' %}{% set icon_bg_end = '#e5e5e5' %}{% set
                                            icon_symbol = 'ü•¶' %}
                                            {% elif pred.commodity == 'Brinjal' %}
                                            {% set icon_bg_start = '#8b5cf6' %}{% set icon_bg_end = '#7c3aed' %}{% set
                                            icon_symbol = 'üçÜ' %}
                                            {% elif pred.commodity == 'Capsicum' %}
                                            {% set icon_bg_start = '#22c55e' %}{% set icon_bg_end = '#16a34a' %}{% set
                                            icon_symbol = 'ü´ë' %}
                                            {% elif pred.commodity == 'Beans' %}
                                            {% set icon_bg_start = '#84cc16' %}{% set icon_bg_end = '#65a30d' %}{% set
                                            icon_symbol = 'ü´ò' %}
                                            {% elif pred.commodity == 'Peas' %}
                                            {% set icon_bg_start = '#10b981' %}{% set icon_bg_end = '#059669' %}{% set
                                            icon_symbol = 'ü´õ' %}
                                            {% elif pred.commodity == 'Banana' %}
                                            {% set icon_bg_start = '#fbbf24' %}{% set icon_bg_end = '#f59e0b' %}{% set
                                            icon_symbol = 'üçå' %}
                                            {% elif pred.commodity == 'Mango' %}
                                            {% set icon_bg_start = '#fb923c' %}{% set icon_bg_end = '#f97316' %}{% set
                                            icon_symbol = 'ü•≠' %}
                                            {% elif pred.commodity == 'Apple' %}
                                            {% set icon_bg_start = '#ef4444' %}{% set icon_bg_end = '#dc2626' %}{% set
                                            icon_symbol = 'üçé' %}
                                            {% elif pred.commodity == 'Orange' %}
                                            {% set icon_bg_start = '#fb923c' %}{% set icon_bg_end = '#f97316' %}{% set
                                            icon_symbol = 'üçä' %}
                                            {% endif %}
                                            <div class="commodity-icon dynamic-bg"
                                                style="--bg-start: {{ icon_bg_start }}; --bg-end: {{ icon_bg_end }};">
                                                {{ icon_symbol }}
                                            </div>
                                            <div>
                                                <div class="commodity-name">{{ pred.commodity }}</div>
                                                <div class="commodity-location">{{ pred.market or user.district }}</div>
                                            </div>
                                        </div>
                                        <div class="commodity-price">
                                            <div class="price-value">‚Çπ{{ pred.current_price_kg }}/kg</div>
                                            <div
                                                class="price-change {{ 'up' if pred.trend == 'increase' else 'down' if pred.trend == 'decrease' else '' }}">
                                                {% if pred.trend == 'increase' %}
                                                <i class="fas fa-arrow-up"></i> {{ pred.change_percent }}%
                                                {% elif pred.trend == 'decrease' %}
                                                <i class="fas fa-arrow-down"></i> {{ pred.change_percent }}%
                                                {% else %}
                                                <span style="color: rgba(255,255,255,0.5);">‚Üî {{ pred.change_percent
                                                    }}%</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                    {% elif market_prices %}
                                    {% for price in market_prices[:10] %}
                                    <div class="commodity-item">
                                        <div class="commodity-info">
                                            <div class="commodity-icon">
                                                {% if price.commodity in ['Tomato'] %}üçÖ
                                                {% elif price.commodity in ['Potato'] %}ü•î
                                                {% elif price.commodity in ['Onion'] %}üßÖ
                                                {% elif price.commodity in ['Carrot'] %}ü•ï
                                                {% elif price.commodity in ['Cabbage'] %}ü•¨
                                                {% elif price.commodity in ['Apple', 'Banana', 'Mango', 'Orange'] %}üçé
                                                {% else %}üåæ{% endif %}
                                            </div>
                                            <div>
                                                <div class="commodity-name">{{ price.commodity }}</div>
                                                <div class="commodity-location">{{ price.district }}</div>
                                            </div>
                                        </div>
                                        <div class="commodity-price">
                                            <div class="price-value">‚Çπ{{ price.price }}/kg</div>
                                            <div class="price-change {{ 'up' if price.change > 0 else 'down' }}">
                                                <i class="fas fa-arrow-{{ 'up' if price.change > 0 else 'down' }}"></i>
                                                {{ price.change }}%
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                    {% else %}
                                    <div style="text-align: center; padding: 20px; color: rgba(255,255,255,0.6);">
                                        <i class="fas fa-chart-bar"
                                            style="font-size: 32px; margin-bottom: 12px; opacity: 0.5;"></i>
                                        <p style="margin: 0;">No market data available for your district yet.</p>
                                        <p style="margin: 4px 0 0 0; font-size: 12px;">Update your profile with your
                                            district to see live prices.</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <a href="{{ url_for('market.market_watch') }}" class="view-all-link">
                                View All Prices <i class="fas fa-arrow-right"></i>
                            </a>
                        </div>


                    </div>

                    <!-- Middle Column -->
                    <div class="middle-column">
                        <!-- Active Crop Management -->
                        <div class="card mt-2">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-tasks"></i> Active Crop Management
                                </div>
                            </div>
                            <div class="card-body">
                                {% if growing_activities %}
                                {% for activity in growing_activities[:3] %}
                                <div class="crop-card">
                                    <div class="crop-progress-ring">
                                        <svg width="70" height="70">
                                            <circle class="progress-bg" cx="35" cy="35" r="30" />
                                            <circle class="progress-bar" cx="35" cy="35" r="30" stroke-dasharray="188.5"
                                                stroke-dashoffset="{{ 188.5 - (188.5 * activity.progress / 100) }}" />
                                        </svg>
                                        <div class="crop-progress-text">{{ activity.progress }}%</div>
                                    </div>
                                    <div class="crop-details">
                                        <div class="crop-name">{{ activity.crop }}</div>
                                        <div class="crop-stage">{{ activity.current_stage }}</div>
                                        <div class="crop-meta">
                                            <span><i class="fas fa-calendar"></i> Started: {{ activity.started
                                                }}</span>
                                            <span><i class="fas fa-clock"></i> Day {{ activity.current_day }}</span>
                                        </div>
                                    </div>
                                    <div class="crop-actions">
                                        <button class="crop-action-btn view-btn" title="View Details"
                                            data-id="{{ activity.id }}" data-crop="{{ activity.crop }}"
                                            data-stage="{{ activity.current_stage }}"
                                            data-progress="{{ activity.progress }}"
                                            data-day="{{ activity.current_day }}" data-started="{{ activity.started }}"
                                            data-notes="{{ activity.notes|default('') }}"
                                            onclick="handleCropView(this)">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="crop-action-btn edit-btn" title="Edit Crop"
                                            data-id="{{ activity.id }}" data-crop="{{ activity.crop }}"
                                            data-stage="{{ activity.current_stage }}"
                                            data-notes="{{ activity.notes|default('') }}"
                                            onclick="handleCropEdit(this)">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="crop-action-btn delete-btn" title="Delete"
                                            onclick="deleteCropActivity('{{ activity.id }}')"><i
                                                class="fas fa-trash"></i></button>
                                    </div>
                                </div>
                                {% endfor %}
                                {% else %}
                                <div class="empty-state">
                                    <div class="empty-state-icon">üå±</div>
                                    <h4>No Active Crops</h4>
                                    <p>Start growing by getting a crop recommendation</p>
                                    <a href="{{ url_for('crop.crop_suggestion') }}" class="empty-state-btn">
                                        <i class="fas fa-plus"></i> Get Crop Suggestion
                                    </a>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Saved Fertilizers -->
                        <div class="card mt-2">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-flask"></i> Saved Fertilizers
                                </div>
                            </div>
                            <div class="card-body">
                                {% if saved_fertilizers %}
                                {% for fertilizer in saved_fertilizers[:3] %}
                                <div class="fertilizer-card" style="background: linear-gradient(135deg, #f8fafc, #f1f5f9); border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px; margin-bottom: 12px; display: flex; align-items: center; gap: 16px;">
                                    <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; flex-shrink: 0;">
                                        üß™
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 700; color: #1e293b; font-size: 16px; margin-bottom: 4px;">
                                            {{ fertilizer.name or fertilizer.fertilizer_name or fertilizer.recommendation or 'Fertilizer' }}
                                        </div>
                                        <div style="font-size: 13px; color: #64748b; margin-bottom: 6px;">
                                            <i class="fas fa-seedling" style="color: #10b981; margin-right: 4px;"></i>
                                            <span style="font-weight: 600;">{{ fertilizer.crop_type or fertilizer.crop or 'General' }}</span>
                                            {% if fertilizer.date %}
                                            <span style="margin-left: 8px; color: #94a3b8;">
                                                <i class="fas fa-calendar" style="margin-right: 4px;"></i>{{ fertilizer.date }}
                                            </span>
                                            {% endif %}
                                        </div>
                                        <div style="font-size: 12px; color: #475569;">
                                            {% if fertilizer.nitrogen or fertilizer.phosphorus or fertilizer.potassium %}
                                            <span style="background: #dbeafe; color: #1e40af; padding: 3px 8px; border-radius: 4px; margin-right: 4px;">N: {{ fertilizer.nitrogen or '0' }}</span>
                                            <span style="background: #fef3c7; color: #92400e; padding: 3px 8px; border-radius: 4px; margin-right: 4px;">P: {{ fertilizer.phosphorus or '0' }}</span>
                                            <span style="background: #dcfce7; color: #14532d; padding: 3px 8px; border-radius: 4px;">K: {{ fertilizer.potassium or '0' }}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 8px;">
                                        <button class="crop-action-btn view-btn" title="View Details" 
                                            onclick="viewFertilizerDetails('{{ fertilizer._id or loop.index }}', '{{ fertilizer.name or fertilizer.fertilizer_name or fertilizer.recommendation }}', '{{ fertilizer.crop_type or fertilizer.crop }}', '{{ fertilizer.nitrogen }}', '{{ fertilizer.phosphorus or fertilizer.phosphorous }}', '{{ fertilizer.potassium }}', '{{ fertilizer.soil_type or "Neutral Soil" }}', '{{ fertilizer.saved_at[:10] if fertilizer.saved_at else fertilizer.date or "" }}')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="crop-action-btn delete-btn" title="Delete"
                                            onclick="deleteFertilizer('{{ fertilizer._id or loop.index }}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                                {% else %}
                                <div class="empty-state">
                                    <div class="empty-state-icon">üß™</div>
                                    <h4>No Saved Fertilizers</h4>
                                    <p>Get personalized fertilizer recommendations</p>
                                    <a href="{{ url_for('fertilizer.fertilizer_recommend') }}" class="empty-state-btn">
                                        <i class="fas fa-plus"></i> Get Fertilizer Advice
                                    </a>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Right Column -->
                    <div class="right-column">
                        <!-- Weather Card - User's Registered District -->
                        <div class="card card-blue weather-card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-cloud-sun"></i> Live Weather
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-sync-alt" onclick="refreshWeather()"
                                        style="cursor: pointer; font-size: 14px; opacity: 0.7;"
                                        title="Refresh Weather"></i>
                                    <span class="card-badge" style="background: #10b981;">Live</span>
                                </div>
                            </div>
                            <div class="card-body">
                                {% if weather_data and weather_data.current %}
                                <div class="weather-main">
                                    <div class="weather-icon-large">{{ weather_data.current.icon }}</div>
                                    <div>
                                        <div class="weather-temp" id="weather-temp">{{
                                            weather_data.current.temperature
                                            }}¬∞C</div>
                                        <div class="weather-desc" id="weather-desc">{{
                                            weather_data.current.condition }}
                                        </div>
                                        <div class="weather-location">
                                            <i class="fas fa-map-marker-alt"></i>
                                            <span id="weather-location">{{ weather_data.current.location }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="weather-details">
                                    <div class="weather-detail">
                                        <div class="weather-detail-icon">üíß</div>
                                        <div class="weather-detail-value" id="weather-humidity">{{
                                            weather_data.current.humidity }}%</div>
                                        <div class="weather-detail-label">Humidity</div>
                                    </div>
                                    <div class="weather-detail">
                                        <div class="weather-detail-icon">üí®</div>
                                        <div class="weather-detail-value" id="weather-wind">{{
                                            weather_data.current.wind_speed }} km/h</div>
                                        <div class="weather-detail-label">Wind</div>
                                    </div>
                                    <div class="weather-detail">
                                        <div class="weather-detail-icon">üëÅÔ∏è</div>
                                        <div class="weather-detail-value" id="weather-visibility">{% if
                                            weather_data.current and weather_data.current.visibility
                                            %}{{ weather_data.current.visibility }}{% else %}10{% endif %} km</div>
                                        <div class="weather-detail-label">Visibility</div>
                                    </div>
                                </div>

                                <!-- 7-Day Forecast -->
                                {% if weather_data.forecast %}
                                <div id="weather-forecast-section"
                                    style="margin-top: 16px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 16px;">
                                    <div
                                        style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                                        <h4
                                            style="margin: 0; font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.9);">
                                            <i class="fas fa-calendar-alt"></i> 7-Day Forecast
                                        </h4>
                                    </div>
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        {% for day in weather_data.forecast[:7] %}
                                        <div
                                            style="display: flex; align-items: center; justify-content: space-between; padding: 8px 10px; background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 12px;">
                                            <div style="flex: 1; font-weight: 600; color: rgba(255,255,255,0.9);">{{
                                                day.day }}</div>
                                            <div style="flex: 0 0 30px; text-align: center; font-size: 18px;">{{
                                                day.icon }}</div>
                                            <div
                                                style="flex: 2; text-align: center; font-size: 11px; color: rgba(255,255,255,0.7);">
                                                {{ day.condition[:15] }}{% if day.condition|length > 15 %}...{% endif %}
                                            </div>
                                            <div style="flex: 1; text-align: right;">
                                                <span style="font-weight: 700; color: #fbbf24;">{{ day.high }}¬∞</span>
                                                <span
                                                    style="color: rgba(255,255,255,0.5); margin-left: 4px; font-size: 11px;">{{
                                                    day.low }}¬∞</span>
                                            </div>
                                            <div
                                                style="flex: 0 0 45px; text-align: right; font-size: 11px; color: #60a5fa;">
                                                <i class="fas fa-tint"></i> {{ day.rain_chance }}%
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}

                                {% if weather_data.alerts %}
                                <div
                                    style="margin-top: 16px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 12px;">
                                    {% for alert in weather_data.alerts[:2] %}
                                    {% set alert_bg = 'rgba(239, 68, 68, 0.1)' if alert.type == 'warning' else 'rgba(16,
                                    185, 129, 0.1)' %}
                                    {% set alert_text_color = '#ef4444' if alert.type == 'warning' else '#10b981' %}
                                    <div class="alert-card-dynamic"
                                        style="display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 8px; margin-bottom: 8px; --bg-color: {{ alert_bg }};">
                                        <span style="font-size: 20px;">{{ alert.icon }}</span>
                                        <div>
                                            <div class="alert-text-dynamic"
                                                style="font-size: 12px; font-weight: 600; --text-color: {{ alert_text_color }};">
                                                {{ alert.title }}</div>
                                            <div style="font-size: 11px; color: var(--text-secondary);">{{
                                                alert.message[:60] }}...</div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                                {% else %}
                                <div class="weather-main">
                                    <div class="weather-icon-large">‚òÄÔ∏è</div>
                                    <div>
                                        <div class="weather-temp" id="weather-temp">28¬∞C</div>
                                        <div class="weather-desc" id="weather-desc">Loading...</div>
                                        <div class="weather-location">
                                            <i class="fas fa-map-marker-alt"></i>
                                            <span id="weather-location">{{ user.district }}, {{ user.state }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="weather-details">
                                    <div class="weather-detail">
                                        <div class="weather-detail-icon">üíß</div>
                                        <div class="weather-detail-value" id="weather-humidity">--%</div>
                                        <div class="weather-detail-label">Humidity</div>
                                    </div>
                                    <div class="weather-detail">
                                        <div class="weather-detail-icon">üí®</div>
                                        <div class="weather-detail-value" id="weather-wind">-- km/h</div>
                                        <div class="weather-detail-label">Wind</div>
                                    </div>
                                    <div class="weather-detail">
                                        <div class="weather-detail-icon">üåßÔ∏è</div>
                                        <div class="weather-detail-value" id="weather-rain">--%</div>
                                        <div class="weather-detail-label">Rain</div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>


                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chatbot Container -->
    <div class="chatbot-container" id="chatbotContainer">
        <button class="chatbot-toggle" onclick="toggleChatbot()">
            <i class="fas fa-comments"></i>
        </button>
        <div class="chatbot-window" id="chatbotWindow">
            <div class="chatbot-header">
                <div class="chatbot-avatar">ü§ñ</div>
                <div class="chatbot-title">
                    <h4>Farm Assistant</h4>
                    <span>Always here to help</span>
                </div>
                <button class="chatbot-close" onclick="toggleChatbot()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="chatbot-messages" id="chatMessages">
                <div class="chat-message bot">
                    <div class="message-avatar">ü§ñ</div>
                    <div class="message-content">
                        Hello! I'm your Smart Farming Assistant. How can I help you today? You can ask me about
                        crops,
                        fertilizers, weather, or any farming-related questions.
                    </div>
                </div>
            </div>
            <div class="chatbot-input">
                <input type="text" id="chatInput" placeholder="Type your message..."
                    onkeypress="handleChatKeypress(event)">
                <button onclick="sendChatMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Equipment Sharing Modal -->
    <div class="modal-overlay" id="equipmentModal" style="display: none;">
        <div class="card" style="width: 800px; max-width: 95vw; max-height: 90vh; overflow-y: auto;">
            <div class="card-header" style="background: linear-gradient(135deg, #6366f1, #4f46e5); color: white;">
                <div class="card-title" style="color: white;"><i class="fas fa-truck-pickup"></i> Equipment Sharing
                    Platform</div>
                <button onclick="closeEquipmentModal()"
                    style="background: none; border: none; font-size: 24px; cursor: pointer; color: white;">√ó</button>
            </div>
            <div class="card-body" style="padding: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <h3 style="margin: 0; color: var(--text-primary);" id="equipmentModalTitle">Rent Farm
                            Machinery
                        </h3>
                        <p style="margin: 4px 0 0 0; color: var(--text-secondary); font-size: 14px;"
                            id="equipmentModalSubtitle">Connect with local farmers to share equipment and reduce
                            costs.
                        </p>
                    </div>
                    <button class="empty-state-btn" style="margin: 0; padding: 10px 20px;"
                        onclick="toggleEquipmentForm()" id="toggleEquipFormBtn">
                        <i class="fas fa-plus"></i> List Your Equipment
                    </button>
                </div>

                <!-- Listing Form (Hidden by default) -->
                <div id="equipmentListingForm"
                    style="display: none; background: #f8fafc; padding: 20px; border-radius: 16px; border: 1px solid #e2e8f0; margin-bottom: 20px;">
                    <form id="addEquipmentForm" onsubmit="event.preventDefault(); submitEquipmentListing();">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label
                                    style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">Equipment
                                    Name</label>
                                <input type="text" id="equipName" required placeholder="e.g. John Deere Tractor"
                                    style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;">
                            </div>
                            <div>
                                <label
                                    style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">Equipment
                                    Type</label>
                                <select id="equipType" required
                                    style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;">
                                    <option value="Tractor">Tractor</option>
                                    <option value="Sprayer">Sprayer</option>
                                    <option value="Harvester">Harvester</option>
                                    <option value="Plough">Plough</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label
                                    style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">Rental
                                    Rate (‚Çπ)</label>
                                <input type="number" id="equipRate" required placeholder="e.g. 500"
                                    style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;">
                            </div>
                            <div>
                                <label
                                    style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">Rate
                                    Unit</label>
                                <select id="equipRateUnit"
                                    style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;">
                                    <option value="hr">Per Hour</option>
                                    <option value="day">Per Day</option>
                                    <option value="acre">Per Acre</option>
                                </select>
                            </div>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label
                                style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">Description</label>
                            <textarea id="equipDesc" rows="2" placeholder="Describe the condition and specifications..."
                                style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;"></textarea>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button type="button" class="btn-cancel" onclick="toggleEquipmentForm()"
                                style="padding: 10px 20px; background: white; border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer;">Cancel</button>
                            <button type="submit"
                                style="padding: 10px 20px; background: #4f46e5; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">List
                                Equipment</button>
                        </div>
                    </form>
                </div>

                <div id="equipmentListContainer" class="equipment-grid"
                    style="display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 20px;">
                    <!-- Content will be loaded dynamically -->
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                        <div class="loading-spinner" style="margin: 0 auto;"></div>
                        <p style="margin-top: 15px; color: var(--text-secondary);">Loading equipment listings...</p>
                    </div>
                </div>
            </div>
            <div class="card-footer"
                style="padding: 20px 24px; background: #f8fafc; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end;">
                <button onclick="closeEquipmentModal()"
                    style="padding: 10px 20px; background: white; border: 1px solid #e2e8f0; border-radius: 8px; color: #64748b; font-weight: 600; cursor: pointer;">Close</button>
            </div>
        </div>
    </div>

    <!-- Weather Modal -->
    <div class="modal-overlay" id="weatherModal" style="display: none;">
        <div class="card" style="width: 550px; max-width: 90vw;">
            <div class="card-header" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white;">
                <div class="card-title" style="color: white;"><i class="fas fa-cloud-sun"></i> Weather Forecast
                </div>
                <button onclick="closeWeatherModal()"
                    style="background: none; border: none; font-size: 20px; cursor: pointer; color: white;">√ó</button>
            </div>
            <div class="card-body" style="padding: 20px;">
                <!-- Search Section -->
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; gap: 10px; margin-bottom: 12px;">
                        <input type="text" id="citySearchInput" placeholder="Enter city name (e.g., Mumbai, Delhi)"
                            style="flex: 1; padding: 12px 16px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 14px;"
                            onkeypress="if(event.key==='Enter') searchWeatherByCity()">
                        <button onclick="searchWeatherByCity()"
                            style="padding: 12px 20px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            <i class="fas fa-search"></i> Search
                        </button>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="flex: 1; height: 1px; background: var(--border-color);"></div>
                        <span style="color: var(--text-secondary); font-size: 12px;">OR</span>
                        <div style="flex: 1; height: 1px; background: var(--border-color);"></div>
                    </div>
                    <button onclick="fetchWeatherByLocation()"
                        style="width: 100%; margin-top: 12px; padding: 12px; background: var(--accent-green); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        <i class="fas fa-location-arrow"></i> Use My Current Location
                    </button>
                </div>
                <!-- Weather Content -->
                <div id="weatherModalContent">
                    <div style="text-align: center; padding: 30px; color: var(--text-secondary);">
                        <i class="fas fa-cloud-sun" style="font-size: 48px; color: #3b82f6; margin-bottom: 16px;"></i>
                        <p>Search for a city or use your current location to see weather</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Modal -->
    <div class="modal-overlay" id="notificationModal" style="display: none;">
        <div class="card" style="width: 580px; max-width: 95vw; max-height: 85vh; overflow-y: auto; border: none;">
            <div class="notif-header">
                <div class="notif-title">
                    <i class="fas fa-bell" style="color: #3b82f6;"></i>
                    Notifications
                    <span
                        style="font-size: 14px; font-weight: 500; background: rgba(59, 130, 246, 0.2); color: #60a5fa; padding: 4px 12px; border-radius: 20px; margin-left: 8px;">{{
                        notifications|length if notifications else 0 }} New</span>
                </div>
                <button onclick="closeNotificationModal()"
                    style="background: rgba(255,255,255,0.1); border: none; width: 36px; height: 36px; border-radius: 50%; font-size: 20px; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; transition: all 0.3s;">√ó</button>
            </div>
            <div class="card-body" style="padding: 25px; background: #f8fafc;">
                {% if notifications %}
                <div style="display: flex; flex-direction: column;">
                    {% for notification in notifications %}
                    <div class="notif-item">
                        <div class="notif-icon-box">
                            {% if notification.type == 'task' %}‚ö°
                            {% elif notification.type == 'harvest' %}üéØ
                            {% elif notification.type == 'equipment' or notification.type == 'rental_request' %}üöú
                            {% else %}üì¢{% endif %}
                        </div>
                        <div style="flex: 1;">
                            <div class="notif-content-title">{{ notification.title or notification.crop }}</div>
                            <div class="notif-content-msg">{{ notification.message }}</div>
                            <div class="notif-time"><i class="far fa-clock"></i> {{ notification.time_ago }}</div>

                            {% if notification.data and (notification.data.get('is_actionable') or
                            notification.data.get('action_type') == 'rental') %}
                            <div class="notif-action-bar">
                                <button
                                    onclick="handleRentalAction('accept', '{{ notification.data.equipment_id }}', '{{ notification.id }}', '{{ notification.data.requester_id }}')"
                                    class="notif-btn-primary">
                                    <i class="fas fa-check"></i> Accept Request
                                </button>
                                <button
                                    onclick="handleRentalAction('reject', '{{ notification.data.equipment_id }}', '{{ notification.id }}', '{{ notification.data.requester_id }}')"
                                    class="notif-btn-secondary">
                                    <i class="fas fa-times"></i> Dismiss
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div style="text-align: center; padding: 60px 20px;">
                    <div
                        style="width: 100px; height: 100px; background: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05);">
                        <i class="fas fa-bell-slash" style="font-size: 40px; color: #cbd5e1;"></i>
                    </div>
                    <h3 style="color: #1e293b; margin-bottom: 8px;">All caught up!</h3>
                    <p style="color: #64748b; font-size: 15px;">You don't have any new notifications right now.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Advanced Expense Calculator Modal -->
    <div class="modal-overlay" id="calculatorModal" style="display: none;">
        <div class="card" style="width: 1200px; max-width: 95vw; max-height: 90vh; overflow-y: auto;">
            <div class="card-header" style="background: linear-gradient(135deg, #52b788, #2d6a4f); color: white;">
                <div class="card-title" style="color: white;"><i class="fas fa-calculator"></i> üí∞ Advanced Farming
                    Expense Calculator</div>
                <button onclick="closeCalculatorModal()"
                    style="background: none; border: none; font-size: 24px; cursor: pointer; color: white;">√ó</button>
            </div>
            <div class="card-body" style="padding: 24px;">
                <p style="color: var(--text-secondary); margin-bottom: 20px;">Calculate and track all your farming
                    expenses for better financial planning with profit analysis</p>

                <!-- Season and Crop Type Selection -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                    <div style="background: var(--body-bg); padding: 15px; border-radius: 12px;">
                        <label
                            style="display: block; margin-bottom: 8px; color: var(--accent-green); font-weight: 600;">üå±
                            Select Crop Type</label>
                        <select id="cropType"
                            style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px;"
                            onchange="loadBenchmarkData()">
                            <option value="">Select Crop</option>
                            <optgroup label="Cereals">
                                <option value="rice">Rice</option>
                                <option value="wheat">Wheat</option>
                                <option value="maize">Maize (Corn)</option>
                            </optgroup>
                            <optgroup label="Pulses & Legumes">
                                <option value="blackgram">Black Gram</option>
                                <option value="chickpea">Chickpea</option>
                                <option value="kidneybeans">Kidney Beans</option>
                                <option value="lentil">Lentil</option>
                                <option value="mothbeans">Moth Beans</option>
                                <option value="mungbean">Mung Bean</option>
                                <option value="pigeonpeas">Pigeon Peas</option>
                                <option value="greenpeas">Green Peas</option>
                                <option value="beans">Beans</option>
                                <option value="pulses">Other Pulses</option>
                            </optgroup>
                            <optgroup label="Vegetables">
                                <option value="potato">Potato</option>
                                <option value="tomato">Tomato</option>
                                <option value="onion">Onion</option>
                                <option value="carrot">Carrot</option>
                                <option value="cabbage">Cabbage</option>
                                <option value="cauliflower">Cauliflower</option>
                                <option value="spinach">Spinach</option>
                                <option value="brinjal">Brinjal (Eggplant)</option>
                                <option value="okra">Lady's Finger (Okra)</option>
                                <option value="beetroot">Beetroot</option>
                                <option value="radish">Radish</option>
                                <option value="capsicum">Capsicum</option>
                                <option value="pumpkin">Pumpkin</option>
                                <option value="bottlegourd">Bottle Gourd</option>
                                <option value="bittergourd">Bitter Gourd</option>
                                <option value="ridgegourd">Ridge Gourd</option>
                                <option value="mushroom">Mushroom</option>
                                <option value="vegetables">Other Vegetables</option>
                            </optgroup>
                            <optgroup label="Fruits">
                                <option value="apple">Apple</option>
                                <option value="banana">Banana</option>
                                <option value="mango">Mango</option>
                                <option value="orange">Orange</option>
                                <option value="grapes">Grapes</option>
                                <option value="papaya">Papaya</option>
                                <option value="pineapple">Pineapple</option>
                                <option value="guava">Guava</option>
                                <option value="watermelon">Watermelon</option>
                                <option value="muskmelon">Muskmelon</option>
                                <option value="pomegranate">Pomegranate</option>
                                <option value="strawberry">Strawberry</option>
                                <option value="cherry">Cherry</option>
                                <option value="kiwi">Kiwi</option>
                                <option value="lemon">Lemon</option>
                                <option value="pear">Pear</option>
                                <option value="peach">Peach</option>
                                <option value="plum">Plum</option>
                                <option value="custardapple">Custard Apple</option>
                            </optgroup>
                            <optgroup label="Cash Crops & Others">
                                <option value="cotton">Cotton</option>
                                <option value="sugarcane">Sugarcane</option>
                                <option value="jute">Jute</option>
                                <option value="coffee">Coffee</option>
                                <option value="coconut">Coconut</option>
                                <option value="oilseeds">Oilseeds</option>
                            </optgroup>
                        </select>
                    </div>
                    <div style="background: var(--body-bg); padding: 15px; border-radius: 12px;">
                        <label
                            style="display: block; margin-bottom: 8px; color: var(--accent-green); font-weight: 600;">üóìÔ∏è
                            Select Season</label>
                        <select id="seasonType"
                            style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px;">
                            <option value="kharif">Kharif (Monsoon)</option>
                            <option value="rabi">Rabi (Winter)</option>
                            <option value="zaid">Zaid (Summer)</option>
                        </select>
                    </div>
                    <div style="background: var(--body-bg); padding: 15px; border-radius: 12px;">
                        <label
                            style="display: block; margin-bottom: 8px; color: var(--accent-green); font-weight: 600;">üìÖ
                            Entry Date</label>
                        <input type="date" id="entryDate"
                            style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px;">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 24px;">
                    <!-- Input Section -->
                    <div>
                        <h3 style="color: var(--accent-green); margin-bottom: 16px;">‚úèÔ∏è Add Expenses</h3>

                        <div
                            style="background: var(--body-bg); padding: 12px; border-radius: 10px; margin-bottom: 12px;">
                            <h4 style="margin: 0 0 8px 0; font-size: 14px;">üåæ Seeds & Planting Material</h4>
                            <input type="number" id="seedCost" placeholder="Enter amount"
                                style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;"
                                oninput="calculateTotal()">
                            <small id="seedBenchmark" style="color: var(--text-secondary); font-size: 11px;"></small>
                        </div>

                        <div
                            style="background: var(--body-bg); padding: 12px; border-radius: 10px; margin-bottom: 12px;">
                            <h4 style="margin: 0 0 8px 0; font-size: 14px;">üß™ Fertilizers & Manure</h4>
                            <input type="number" id="fertilizerCost" placeholder="Enter amount"
                                style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;"
                                oninput="calculateTotal()">
                            <small id="fertilizerBenchmark"
                                style="color: var(--text-secondary); font-size: 11px;"></small>
                        </div>

                        <div
                            style="background: var(--body-bg); padding: 12px; border-radius: 10px; margin-bottom: 12px;">
                            <h4 style="margin: 0 0 8px 0; font-size: 14px;">üêõ Pesticides & Insecticides</h4>
                            <input type="number" id="pesticideCost" placeholder="Enter amount"
                                style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;"
                                oninput="calculateTotal()">
                            <small id="pesticideBenchmark"
                                style="color: var(--text-secondary); font-size: 11px;"></small>
                        </div>

                        <div
                            style="background: var(--body-bg); padding: 12px; border-radius: 10px; margin-bottom: 12px;">
                            <h4 style="margin: 0 0 8px 0; font-size: 14px;">üíß Irrigation & Water</h4>
                            <input type="number" id="irrigationCost" placeholder="Enter amount"
                                style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;"
                                oninput="calculateTotal()">
                        </div>

                        <div
                            style="background: var(--body-bg); padding: 12px; border-radius: 10px; margin-bottom: 12px;">
                            <h4 style="margin: 0 0 8px 0; font-size: 14px;">üë®‚Äçüåæ Labor Cost</h4>
                            <input type="number" id="laborCost" placeholder="Enter amount"
                                style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;"
                                oninput="calculateTotal()">
                        </div>

                        <div
                            style="background: var(--body-bg); padding: 12px; border-radius: 10px; margin-bottom: 12px;">
                            <h4 style="margin: 0 0 8px 0; font-size: 14px;">üöú Machinery & Equipment</h4>
                            <input type="number" id="machineryCost" placeholder="Enter amount"
                                style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;"
                                oninput="calculateTotal()">
                        </div>

                        <div style="background: var(--body-bg); padding: 12px; border-radius: 10px;">
                            <h4 style="margin: 0 0 8px 0; font-size: 14px;">üì¶ Other Expenses</h4>
                            <input type="number" id="otherCost" placeholder="Transport, Storage, etc."
                                style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;"
                                oninput="calculateTotal()">
                        </div>
                    </div>

                    <!-- Summary Section -->
                    <div>
                        <h3 style="color: var(--accent-green); margin-bottom: 16px;">üìÑ Expense Summary</h3>

                        <div
                            style="background: linear-gradient(135deg, #52b788, #2d6a4f); padding: 20px; border-radius: 12px; color: white; margin-bottom: 16px;">
                            <h3 style="margin: 0 0 8px 0; color: white; font-size: 16px;">Total Expenses</h3>
                            <h1 style="margin: 0; font-size: 36px; color: white;" id="totalExpense">‚Çπ0</h1>
                        </div>

                        <div
                            style="background: var(--body-bg); padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                            <h4 style="margin: 0 0 12px 0;">üìä Expense Breakdown</h4>
                            <canvas id="expenseChart" style="max-height: 200px;"></canvas>
                            <div id="expenseBreakdown" style="margin-top: 12px; font-size: 13px;">
                                <div
                                    style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border-color);">
                                    <span>Seeds:</span><strong id="seedDisplay">‚Çπ0</strong>
                                </div>
                                <div
                                    style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border-color);">
                                    <span>Fertilizers:</span><strong id="fertilizerDisplay">‚Çπ0</strong>
                                </div>
                                <div
                                    style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border-color);">
                                    <span>Pesticides:</span><strong id="pesticideDisplay">‚Çπ0</strong>
                                </div>
                                <div
                                    style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border-color);">
                                    <span>Irrigation:</span><strong id="irrigationDisplay">‚Çπ0</strong>
                                </div>
                                <div
                                    style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border-color);">
                                    <span>Labor:</span><strong id="laborDisplay">‚Çπ0</strong>
                                </div>
                                <div
                                    style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border-color);">
                                    <span>Machinery:</span><strong id="machineryDisplay">‚Çπ0</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 6px 0;">
                                    <span>Other:</span><strong id="otherDisplay">‚Çπ0</strong>
                                </div>
                            </div>
                        </div>

                        <div
                            style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 16px; border-radius: 8px;">
                            <h4 style="margin: 0 0 8px 0; color: #856404;">üí° Cost per Acre</h4>
                            <input type="number" id="landArea" placeholder="Land area (acres)" step="0.1"
                                style="width: 100%; padding: 10px; border: 1px solid #ffc107; border-radius: 8px; margin-bottom: 8px;"
                                oninput="calculateTotal()">
                            <h3 style="margin: 0; color: #856404;" id="costPerAcre">‚Çπ0 per acre</h3>
                            <small id="benchmarkComparison" style="color: #856404;"></small>
                        </div>
                    </div>

                    <!-- Revenue & Profit Section -->
                    <div>
                        <h3 style="color: var(--accent-green); margin-bottom: 16px;">üíµ Revenue & Profit</h3>

                        <div
                            style="background: #d1f2eb; border-left: 4px solid #52b788; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                            <h4 style="margin: 0 0 12px 0; color: #0f5132;">üì¶ Expected Production</h4>
                            <input type="number" id="expectedYield" placeholder="Yield (quintals)"
                                style="width: 100%; padding: 10px; border: 1px solid #52b788; border-radius: 8px; margin-bottom: 8px;"
                                oninput="calculateTotal()">
                            <input type="number" id="marketPrice" placeholder="Price (‚Çπ/quintal)"
                                style="width: 100%; padding: 10px; border: 1px solid #52b788; border-radius: 8px;"
                                oninput="calculateTotal()">
                        </div>

                        <div
                            style="background: linear-gradient(135deg, #06d6a0, #118ab2); padding: 16px; border-radius: 12px; color: white; margin-bottom: 16px;">
                            <h3 style="margin: 0 0 8px 0; color: white; font-size: 14px;">Total Revenue</h3>
                            <h2 style="margin: 0; font-size: 28px; color: white;" id="totalRevenue">‚Çπ0</h2>
                        </div>

                        <div id="profitCard"
                            style="background: linear-gradient(135deg, #4caf50, #2e7d32); padding: 16px; border-radius: 12px; color: white; margin-bottom: 16px;">
                            <h3 style="margin: 0 0 8px 0; color: white; font-size: 14px;">Net Profit</h3>
                            <h2 style="margin: 0; font-size: 28px; color: white;" id="netProfit">‚Çπ0</h2>
                            <p style="margin: 8px 0 0 0; font-size: 12px; opacity: 0.9;" id="profitMargin">Profit
                                Margin: 0%</p>
                        </div>

                        <div
                            style="background: #e8f5e9; border-left: 4px solid #4caf50; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                            <h4 style="margin: 0 0 8px 0; color: #2e7d32;">üéØ Break-even Analysis</h4>
                            <p style="margin: 4px 0; color: #2e7d32; font-size: 12px;">Min selling price:</p>
                            <h4 style="margin: 4px 0; color: #2e7d32;" id="minPrice">‚Çπ0 per quintal</h4>
                            <p style="margin: 8px 0 4px 0; color: #2e7d32; font-size: 12px;">Break-even quantity:
                            </p>
                            <h4 style="margin: 4px 0; color: #2e7d32;" id="breakEvenQty">0 quintals</h4>
                        </div>

                        <div
                            style="background: #fff9e6; border-left: 4px solid #ff9800; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                            <h4 style="margin: 0 0 12px 0; color: #e65100;">üè¶ Loan Calculator</h4>
                            <input type="number" id="loanAmount" placeholder="Loan amount (‚Çπ)"
                                style="width: 100%; padding: 8px; border: 1px solid #ff9800; border-radius: 6px; margin-bottom: 8px; font-size: 13px;"
                                oninput="calculateLoan()">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                                <input type="number" id="interestRate" placeholder="Rate %" value="7"
                                    style="padding: 8px; border: 1px solid #ff9800; border-radius: 6px; font-size: 13px;"
                                    oninput="calculateLoan()">
                                <input type="number" id="loanPeriod" placeholder="Months" value="12"
                                    style="padding: 8px; border: 1px solid #ff9800; border-radius: 6px; font-size: 13px;"
                                    oninput="calculateLoan()">
                            </div>
                            <div style="background: white; padding: 10px; border-radius: 6px; font-size: 12px;">
                                <div style="display: flex; justify-content: space-between;"><span>Monthly
                                        EMI:</span><strong id="monthlyEMI" style="color: #e65100;">‚Çπ0</strong></div>
                                <div style="display: flex; justify-content: space-between;"><span>Total
                                        Interest:</span><strong id="totalInterest" style="color: #e65100;">‚Çπ0</strong>
                                </div>
                                <div
                                    style="display: flex; justify-content: space-between; border-top: 1px solid #ffe0b2; padding-top: 6px; margin-top: 6px;">
                                    <span>Total Amount:</span><strong id="totalAmount"
                                        style="color: #e65100;">‚Çπ0</strong>
                                </div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <button onclick="saveExpenseEntry()"
                                style="padding: 12px; background: #52b788; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">üíæ
                                Save</button>
                            <button onclick="exportToPDF()"
                                style="padding: 12px; background: #0284c7; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">üìÑ
                                PDF</button>
                        </div>
                        <button onclick="resetCalculator()"
                            style="width: 100%; padding: 12px; background: #dc3545; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 8px;">üîÑ
                            Reset</button>
                    </div>
                </div>

                <!-- Tips Section -->
                <div
                    style="margin-top: 24px; background: #e7f5ff; border-left: 4px solid #0284c7; padding: 16px; border-radius: 8px;">
                    <h4 style="color: #0c4a6e; margin: 0 0 12px 0;">üí° Money Saving Tips</h4>
                    <ul style="margin: 0; padding-left: 20px; line-height: 1.8; color: #0c4a6e; font-size: 13px;">
                        <li><strong>Buy in Bulk:</strong> Purchase seeds and fertilizers with other farmers to get
                            discounts</li>
                        <li><strong>Government Subsidies:</strong> Check schemes for subsidy on seeds, fertilizers,
                            equipment</li>
                        <li><strong>Drip Irrigation:</strong> Saves 40-60% water cost compared to flood irrigation
                        </li>
                        <li><strong>Organic Manure:</strong> Make your own compost to reduce fertilizer cost</li>
                        <li><strong>Soil Testing:</strong> Prevents over-fertilization, saves 20-30% fertilizer cost
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Govt Schemes Modal -->
    <div class="modal-overlay" id="govtSchemesModal" style="display: none;">
        <div class="card" style="width: 1000px; max-width: 95vw; max-height: 90vh; overflow-y: auto;">
            <div class="card-header" style="background: linear-gradient(135deg, #059669, #047857); color: white;">
                <div class="card-title" style="color: white;"><i class="fas fa-landmark"></i> üèõÔ∏è Government Schemes
                    for
                    Farmers</div>
                <button onclick="closeGovtSchemesModal()"
                    style="background: none; border: none; font-size: 24px; cursor: pointer; color: white;">√ó</button>
            </div>
            <div class="card-body" style="padding: 24px;">
                <p style="color: var(--text-secondary); margin-bottom: 24px; text-align: center;">Explore government
                    schemes designed to support farmers across India</p>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px;">
                    <!-- Central Government Schemes -->
                    <div>
                        <h3
                            style="color: var(--accent-green); margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 24px;">üáÆüá≥</span> Central Government Schemes
                        </h3>

                        <div
                            style="background: var(--body-bg); padding: 16px; border-radius: 12px; margin-bottom: 12px; border-left: 4px solid #10b981;">
                            <h4 style="margin: 0 0 8px 0; color: var(--text-primary);">PM-KISAN (Pradhan Mantri
                                Kisan
                                Samman Nidhi)</h4>
                            <p style="margin: 0 0 12px 0; color: var(--text-secondary); font-size: 13px;">Income
                                support
                                of ‚Çπ6,000/year in three equal installments to all farmer families</p>
                            <a href="https://pmkisan.gov.in/" target="_blank"
                                style="color: #10b981; font-weight: 600; text-decoration: none; font-size: 13px;">Visit
                                Official Website ‚Üí</a>
                        </div>

                        <div
                            style="background: var(--body-bg); padding: 16px; border-radius: 12px; margin-bottom: 12px; border-left: 4px solid #3b82f6;">
                            <h4 style="margin: 0 0 8px 0; color: var(--text-primary);">Kisan Credit Card (KCC)</h4>
                            <p style="margin: 0 0 12px 0; color: var(--text-secondary); font-size: 13px;">Provides
                                credit to farmers for agriculture and allied activities at concessional rates</p>
                            <a href="https://www.nabard.org/content1.aspx?id=523&catid=8&mid=523" target="_blank"
                                style="color: #3b82f6; font-weight: 600; text-decoration: none; font-size: 13px;">Learn
                                More ‚Üí</a>
                        </div>

                        <div
                            style="background: var(--body-bg); padding: 16px; border-radius: 12px; margin-bottom: 12px; border-left: 4px solid #f97316;">
                            <h4 style="margin: 0 0 8px 0; color: var(--text-primary);">PM Fasal Bima Yojana</h4>
                            <p style="margin: 0 0 12px 0; color: var(--text-secondary); font-size: 13px;">Crop
                                insurance
                                scheme providing financial support to farmers in case of crop failure</p>
                            <a href="https://pmfby.gov.in/" target="_blank"
                                style="color: #f97316; font-weight: 600; text-decoration: none; font-size: 13px;">Apply
                                Now ‚Üí</a>
                        </div>

                        <div
                            style="background: var(--body-bg); padding: 16px; border-radius: 12px; margin-bottom: 12px; border-left: 4px solid #8b5cf6;">
                            <h4 style="margin: 0 0 8px 0; color: var(--text-primary);">Soil Health Card Scheme</h4>
                            <p style="margin: 0 0 12px 0; color: var(--text-secondary); font-size: 13px;">Provides
                                soil
                                health cards to farmers with information on nutrient status of their soil</p>
                            <a href="https://soilhealth.dac.gov.in/" target="_blank"
                                style="color: #8b5cf6; font-weight: 600; text-decoration: none; font-size: 13px;">Get
                                Soil Card ‚Üí</a>
                        </div>

                        <div
                            style="background: var(--body-bg); padding: 16px; border-radius: 12px; margin-bottom: 12px; border-left: 4px solid #06b6d4;">
                            <h4 style="margin: 0 0 8px 0; color: var(--text-primary);">PM Krishi Sinchayee Yojana
                            </h4>
                            <p style="margin: 0 0 12px 0; color: var(--text-secondary); font-size: 13px;">Aims to
                                enhance water use efficiency through Micro Irrigation and watershed development</p>
                            <a href="https://pmksy.gov.in/" target="_blank"
                                style="color: #06b6d4; font-weight: 600; text-decoration: none; font-size: 13px;">Know
                                More ‚Üí</a>
                        </div>

                        <div
                            style="background: var(--body-bg); padding: 16px; border-radius: 12px; margin-bottom: 12px; border-left: 4px solid #84cc16;">
                            <h4 style="margin: 0 0 8px 0; color: var(--text-primary);">Paramparagat Krishi Vikas
                                Yojana
                            </h4>
                            <p style="margin: 0 0 12px 0; color: var(--text-secondary); font-size: 13px;">Promotes
                                organic farming through cluster approach and PGS certification</p>
                            <a href="https://pgsindia-ncof.gov.in/" target="_blank"
                                style="color: #84cc16; font-weight: 600; text-decoration: none; font-size: 13px;">Register
                                ‚Üí</a>
                        </div>

                        <div
                            style="background: var(--body-bg); padding: 16px; border-radius: 12px; margin-bottom: 12px; border-left: 4px solid #ec4899;">
                            <h4 style="margin: 0 0 8px 0; color: var(--text-primary);">National Agriculture Market
                                (e-NAM)</h4>
                            <p style="margin: 0 0 12px 0; color: var(--text-secondary); font-size: 13px;">Online
                                trading
                                platform for agricultural commodities in India</p>
                            <a href="https://www.enam.gov.in/" target="_blank"
                                style="color: #ec4899; font-weight: 600; text-decoration: none; font-size: 13px;">Trade
                                Online ‚Üí</a>
                        </div>

                        <div
                            style="background: var(--body-bg); padding: 16px; border-radius: 12px; border-left: 4px solid #14b8a6;">
                            <h4 style="margin: 0 0 8px 0; color: var(--text-primary);">Kisan Call Centre</h4>
                            <p style="margin: 0 0 12px 0; color: var(--text-secondary); font-size: 13px;">24x7
                                toll-free
                                helpline (1800-180-1551) for farmers' queries</p>
                            <a href="https://mkisan.gov.in/Home/KCC" target="_blank"
                                style="color: #14b8a6; font-weight: 600; text-decoration: none; font-size: 13px;">Contact
                                Support ‚Üí</a>
                        </div>
                    </div>

                    <!-- State Schemes & Resources -->
                    <div>
                        <h3
                            style="color: var(--accent-purple); margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 24px;">üìç</span> State Government Schemes
                        </h3>

                        <div
                            style="background: var(--body-bg); padding: 16px; border-radius: 12px; margin-bottom: 12px; border-left: 4px solid #a855f7;">
                            <h4 style="margin: 0 0 8px 0; color: var(--text-primary);">Check Your State Schemes</h4>
                            <p style="margin: 0 0 12px 0; color: var(--text-secondary); font-size: 13px;">Each state
                                offers additional schemes. Visit your state agriculture department website</p>
                            <a href="https://agricoop.gov.in/en" target="_blank"
                                style="color: #a855f7; font-weight: 600; text-decoration: none; font-size: 13px;">State
                                Agriculture Portals ‚Üí</a>
                        </div>

                        <div
                            style="background: var(--body-bg); padding: 16px; border-radius: 12px; margin-bottom: 12px; border-left: 4px solid #f59e0b;">
                            <h4 style="margin: 0 0 8px 0; color: var(--text-primary);">Karnataka Schemes</h4>
                            <p style="margin: 0 0 12px 0; color: var(--text-secondary); font-size: 13px;">Raitha
                                Bandhu,
                                Krishi Bhagya, and other state-specific programs</p>
                            <a href="https://raitamitra.karnataka.gov.in/" target="_blank"
                                style="color: #f59e0b; font-weight: 600; text-decoration: none; font-size: 13px;">Karnataka
                                Portal ‚Üí</a>
                        </div>

                        <div
                            style="background: var(--body-bg); padding: 16px; border-radius: 12px; margin-bottom: 12px; border-left: 4px solid #ef4444;">
                            <h4 style="margin: 0 0 8px 0; color: var(--text-primary);">Maharashtra Schemes</h4>
                            <p style="margin: 0 0 12px 0; color: var(--text-secondary); font-size: 13px;">Mahatma
                                Jyotiba Phule Shetkari Karjmukti Yojana and others</p>
                            <a href="https://krishi.maharashtra.gov.in/" target="_blank"
                                style="color: #ef4444; font-weight: 600; text-decoration: none; font-size: 13px;">Maharashtra
                                Portal ‚Üí</a>
                        </div>

                        <h3
                            style="color: #0284c7; margin: 24px 0 16px 0; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 24px;">üìö</span> Additional Resources
                        </h3>

                        <div
                            style="background: var(--body-bg); padding: 16px; border-radius: 12px; margin-bottom: 12px; border-left: 4px solid #0284c7;">
                            <h4 style="margin: 0 0 8px 0; color: var(--text-primary);">Ministry of Agriculture
                                Portal
                            </h4>
                            <p style="margin: 0 0 12px 0; color: var(--text-secondary); font-size: 13px;">Complete
                                information about all agricultural schemes and subsidies</p>
                            <a href="https://agricoop.gov.in/" target="_blank"
                                style="color: #0284c7; font-weight: 600; text-decoration: none; font-size: 13px;">Visit
                                Portal ‚Üí</a>
                        </div>

                        <div
                            style="background: var(--body-bg); padding: 16px; border-radius: 12px; margin-bottom: 12px; border-left: 4px solid #22c55e;">
                            <h4 style="margin: 0 0 8px 0; color: var(--text-primary);">Kisan Rath Mobile App</h4>
                            <p style="margin: 0 0 12px 0; color: var(--text-secondary); font-size: 13px;">Helps
                                farmers
                                find transport for their agricultural produce</p>
                            <a href="https://kisanrath.nic.in/" target="_blank"
                                style="color: #22c55e; font-weight: 600; text-decoration: none; font-size: 13px;">Download
                                App ‚Üí</a>
                        </div>

                        <div
                            style="background: var(--body-bg); padding: 16px; border-radius: 12px; margin-bottom: 12px; border-left: 4px solid #6366f1;">
                            <h4 style="margin: 0 0 8px 0; color: var(--text-primary);">Direct Benefit Transfer (DBT)
                            </h4>
                            <p style="margin: 0 0 12px 0; color: var(--text-secondary); font-size: 13px;">Track your
                                subsidy and benefit transfers</p>
                            <a href="https://dbtbharat.gov.in/" target="_blank"
                                style="color: #6366f1; font-weight: 600; text-decoration: none; font-size: 13px;">Check
                                Status ‚Üí</a>
                        </div>

                        <!-- Helpline Info -->
                        <div
                            style="background: linear-gradient(135deg, #fef3c7, #fde68a); padding: 20px; border-radius: 12px; margin-top: 16px;">
                            <h4
                                style="margin: 0 0 12px 0; color: #92400e; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-phone-alt"></i> Farmer Helplines
                            </h4>
                            <div style="display: grid; gap: 8px; font-size: 14px; color: #78350f;">
                                <div><strong>Kisan Call Centre:</strong> 1800-180-1551 (Toll Free)</div>
                                <div><strong>PM-KISAN Helpline:</strong> 155261 / 011-24300606</div>
                                <div><strong>Crop Insurance:</strong> 1800-209-5959</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="modal-overlay" id="profileModal" style="display: none;">
        <div class="card" style="width: 500px; max-width: 95vw; max-height: 90vh; overflow-y: auto;">
            <div class="card-header"
                style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; text-align: center; padding: 30px;">
                <button onclick="closeProfileModal()"
                    style="position: absolute; right: 16px; top: 16px; background: none; border: none; font-size: 24px; cursor: pointer; color: white;">√ó</button>
                <div
                    style="width: 80px; height: 80px; background: linear-gradient(135deg, #a78bfa, #8b5cf6); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; font-size: 32px; font-weight: 700; border: 4px solid white; box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
                    {{ user_name[0] if user_name else 'U' }}
                </div>
                <h2 style="margin: 0; font-size: 24px;">{{ user_name or 'Farmer' }}</h2>
                <p style="margin: 8px 0 0 0; opacity: 0.9; font-size: 14px;">üåæ Smart Farmer</p>
            </div>
            <div class="card-body" style="padding: 24px;">
                <div style="display: grid; gap: 16px;">
                    <!-- Email -->
                    <div
                        style="display: flex; align-items: center; gap: 16px; padding: 16px; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0;">
                        <div
                            style="width: 44px; height: 44px; background: linear-gradient(135deg, #3b82f6, #2563eb); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white;">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #64748b; text-transform: uppercase; font-weight: 600;">
                                Email</div>
                            <div style="font-size: 15px; color: #1e293b; font-weight: 500;">{{ user.email if user
                                else
                                'Not set' }}</div>
                        </div>
                    </div>

                    <!-- Phone -->
                    <div
                        style="display: flex; align-items: center; gap: 16px; padding: 16px; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0;">
                        <div
                            style="width: 44px; height: 44px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white;">
                            <i class="fas fa-phone"></i>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #64748b; text-transform: uppercase; font-weight: 600;">
                                Phone</div>
                            <div style="font-size: 15px; color: #1e293b; font-weight: 500;">{{ user.phone if user
                                and
                                user.phone else 'Not set' }}</div>
                        </div>
                    </div>

                    <!-- Location -->
                    <div
                        style="display: flex; align-items: center; gap: 16px; padding: 16px; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0;">
                        <div
                            style="width: 44px; height: 44px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white;">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #64748b; text-transform: uppercase; font-weight: 600;">
                                Location</div>
                            <div style="font-size: 15px; color: #1e293b; font-weight: 500;">{{ user.district if user
                                and
                                user.district else 'Not set' }}{% if user and user.state %}, {{ user.state }}{%
                                endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Member Since -->
                    <div
                        style="display: flex; align-items: center; gap: 16px; padding: 16px; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0;">
                        <div
                            style="width: 44px; height: 44px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white;">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #64748b; text-transform: uppercase; font-weight: 600;">
                                Member Since</div>
                            <div style="font-size: 15px; color: #1e293b; font-weight: 500;">{{
                                user.created_at.strftime('%B %d, %Y') if user and user.created_at and
                                user.created_at.strftime else 'December 2025' }}</div>
                        </div>
                    </div>
                </div>

                <!-- Stats -->
                <div
                    style="margin-top: 24px; padding: 20px; background: linear-gradient(135deg, #f0fdf4, #ecfdf5); border-radius: 12px; border: 1px solid #bbf7d0;">
                    <h4
                        style="margin: 0 0 16px 0; font-size: 14px; color: #166534; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-chart-bar"></i> Your Farming Activity
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; text-align: center;">
                        <div>
                            <div style="font-size: 24px; font-weight: 700; color: #10b981;">{{ stats.crops_suggested
                                if
                                stats else 0 }}</div>
                            <div style="font-size: 11px; color: #64748b;">Crops Suggested</div>
                        </div>
                        <div>
                            <div style="font-size: 24px; font-weight: 700; color: #3b82f6;">{{
                                stats.fertilizers_saved
                                if stats else 0 }}</div>
                            <div style="font-size: 11px; color: #64748b;">Fertilizer Plans</div>
                        </div>
                        <div>
                            <div style="font-size: 24px; font-weight: 700; color: #f59e0b;">{{ stats.active_crops if
                                stats else 0 }}</div>
                            <div style="font-size: 11px; color: #64748b;">Active Crops</div>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div style="margin-top: 24px; display: flex; gap: 12px;">
                    <button onclick="closeProfileModal()"
                        style="flex: 1; padding: 12px; background: white; border: 2px solid #e2e8f0; border-radius: 10px; font-weight: 600; color: #475569; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <i class="fas fa-times"></i> Close
                    </button>
                    <button onclick="window.location.href=this.dataset.url;" data-url="{{ url_for('auth.logout') }}"
                        style="flex: 1; padding: 12px; background: linear-gradient(135deg, #ef4444, #dc2626); border: none; border-radius: 10px; font-weight: 600; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Crop View Modal -->
    <div class="modal-overlay" id="cropViewModal" style="display: none;">
        <div class="card" style="width: 600px; max-width: 95vw; max-height: 90vh; overflow-y: auto;">
            <div class="card-header"
                style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 24px; position: relative;">
                <button onclick="closeCropViewModal()"
                    style="position: absolute; right: 16px; top: 16px; background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; color: white; font-size: 18px;">√ó</button>
                <div style="display: flex; align-items: center; gap: 16px;">
                    <div
                        style="width: 60px; height: 60px; background: rgba(255,255,255,0.2); border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 32px;">
                        üå±</div>
                    <div>
                        <h2 style="margin: 0; font-size: 22px;" id="viewCropName">Crop Name</h2>
                        <p style="margin: 6px 0 0 0; opacity: 0.9; font-size: 14px;" id="viewCropStage">Current
                            Stage
                        </p>
                    </div>
                </div>
            </div>
            <div class="card-body" style="padding: 24px;">
                <!-- Progress Section -->
                <div
                    style="text-align: center; padding: 20px; background: linear-gradient(135deg, #f0fdf4, #ecfdf5); border-radius: 16px; margin-bottom: 20px;">
                    <div style="position: relative; width: 120px; height: 120px; margin: 0 auto;">
                        <svg width="120" height="120" style="transform: rotate(-90deg);">
                            <circle cx="60" cy="60" r="50" fill="none" stroke="#e2e8f0" stroke-width="10" />
                            <circle cx="60" cy="60" r="50" fill="none" stroke="#10b981" stroke-width="10"
                                stroke-dasharray="314.16" id="viewProgressCircle" stroke-linecap="round" />
                        </svg>
                        <div
                            style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                            <div style="font-size: 28px; font-weight: 700; color: #10b981;" id="viewProgressText">0%
                            </div>
                            <div style="font-size: 11px; color: #64748b;">Complete</div>
                        </div>
                    </div>
                </div>

                <!-- Stats Grid -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px;">
                    <div
                        style="padding: 16px; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0; text-align: center;">
                        <div style="font-size: 11px; color: #64748b; text-transform: uppercase; font-weight: 600;">
                            Current Day</div>
                        <div style="font-size: 24px; font-weight: 700; color: #1e293b; margin-top: 4px;"
                            id="viewCurrentDay">0</div>
                    </div>
                    <div
                        style="padding: 16px; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0; text-align: center;">
                        <div style="font-size: 11px; color: #64748b; text-transform: uppercase; font-weight: 600;">
                            Started On</div>
                        <div style="font-size: 16px; font-weight: 700; color: #1e293b; margin-top: 4px;"
                            id="viewStartDate">-</div>
                    </div>
                </div>

                <!-- Timeline -->
                <div style="margin-bottom: 20px;">
                    <h4
                        style="margin: 0 0 16px 0; font-size: 14px; color: #1e293b; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-tasks" style="color: #10b981;"></i> Growth Timeline
                    </h4>
                    <div id="viewTimeline" style="position: relative; padding-left: 24px;">
                        <!-- Timeline items will be inserted here -->
                    </div>
                </div>

                <!-- Notes Section -->
                <div style="margin-bottom: 20px;">
                    <h4
                        style="margin: 0 0 12px 0; font-size: 14px; color: #1e293b; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-sticky-note" style="color: #f59e0b;"></i> Notes
                    </h4>
                    <div id="viewNotes"
                        style="padding: 16px; background: #fffbeb; border-radius: 12px; border: 1px solid #fde68a; font-size: 14px; color: #92400e; min-height: 60px;">
                        No notes added yet.
                    </div>
                </div>

                <!-- Action Buttons -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                    <button id="editCropBtn"
                        style="padding: 12px; background: linear-gradient(135deg, #3b82f6, #2563eb); border: none; border-radius: 10px; font-weight: 600; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button id="fullViewCropBtn"
                        style="padding: 12px; background: linear-gradient(135deg, #10b981, #059669); border: none; border-radius: 10px; font-weight: 600; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <i class="fas fa-eye"></i> Full View
                    </button>
                    <button onclick="closeCropViewModal()"
                        style="padding: 12px; background: white; border: 2px solid #e2e8f0; border-radius: 10px; font-weight: 600; color: #475569; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Crop Edit Modal -->
    <div class="modal-overlay" id="cropEditModal" style="display: none;">
        <div class="card" style="width: 500px; max-width: 95vw; max-height: 90vh; overflow-y: auto;">
            <div class="card-header"
                style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; padding: 24px; position: relative;">
                <button onclick="closeCropEditModal()"
                    style="position: absolute; right: 16px; top: 16px; background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; color: white; font-size: 18px;">√ó</button>
                <div style="display: flex; align-items: center; gap: 16px;">
                    <div
                        style="width: 50px; height: 50px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">
                        ‚úèÔ∏è</div>
                    <div>
                        <h2 style="margin: 0; font-size: 20px;">Edit Crop Activity</h2>
                        <p style="margin: 4px 0 0 0; opacity: 0.9; font-size: 13px;" id="editCropTitle">Update your
                            crop
                            details</p>
                    </div>
                </div>
            </div>
            <div class="card-body" style="padding: 24px;">
                <form id="editCropForm">
                    <input type="hidden" id="editCropId" name="cropId">

                    <!-- Crop Name (Read-only) -->
                    <div style="margin-bottom: 16px;">
                        <label
                            style="display: block; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px;">
                            <i class="fas fa-seedling" style="color: #10b981; margin-right: 6px;"></i> Crop Name
                        </label>
                        <input type="text" id="editCropName" readonly
                            style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px; background: #f8fafc; color: #64748b;">
                    </div>

                    <!-- Current Stage -->
                    <div style="margin-bottom: 16px;">
                        <label
                            style="display: block; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px;">
                            <i class="fas fa-layer-group" style="color: #3b82f6; margin-right: 6px;"></i> Update
                            Stage
                        </label>
                        <select id="editCropStage" name="stage"
                            style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px; background: white; cursor: pointer;">
                            <option value="Seed Sowing">üå± Seed Sowing</option>
                            <option value="Germination">üåø Germination</option>
                            <option value="Seedling">üåæ Seedling</option>
                            <option value="Vegetative Growth">üå≥ Vegetative Growth</option>
                            <option value="Flowering">üå∏ Flowering</option>
                            <option value="Fruit Development">üçé Fruit Development</option>
                            <option value="Maturity">‚úÖ Maturity</option>
                            <option value="Harvest Ready">üéâ Harvest Ready</option>
                        </select>
                    </div>

                    <!-- Notes -->
                    <div style="margin-bottom: 16px;">
                        <label
                            style="display: block; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px;">
                            <i class="fas fa-sticky-note" style="color: #f59e0b; margin-right: 6px;"></i> Notes &
                            Observations
                        </label>
                        <textarea id="editCropNotes" name="notes" rows="4"
                            placeholder="Add notes about your crop's progress, observations, or reminders..."
                            style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px; resize: vertical;"></textarea>
                    </div>

                    <!-- Task Checklist -->
                    <div style="margin-bottom: 20px;">
                        <label
                            style="display: block; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 12px;">
                            <i class="fas fa-check-square" style="color: #8b5cf6; margin-right: 6px;"></i> Quick
                            Tasks
                        </label>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <label
                                style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #f8fafc; border-radius: 10px; cursor: pointer; border: 1px solid #e2e8f0;">
                                <input type="checkbox" name="task_watering"
                                    style="width: 18px; height: 18px; accent-color: #10b981;">
                                <span style="font-size: 14px; color: #374151;">üíß Watering completed today</span>
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #f8fafc; border-radius: 10px; cursor: pointer; border: 1px solid #e2e8f0;">
                                <input type="checkbox" name="task_fertilizer"
                                    style="width: 18px; height: 18px; accent-color: #10b981;">
                                <span style="font-size: 14px; color: #374151;">üß™ Fertilizer applied</span>
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #f8fafc; border-radius: 10px; cursor: pointer; border: 1px solid #e2e8f0;">
                                <input type="checkbox" name="task_pest"
                                    style="width: 18px; height: 18px; accent-color: #10b981;">
                                <span style="font-size: 14px; color: #374151;">üêõ Pest check done</span>
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #f8fafc; border-radius: 10px; cursor: pointer; border: 1px solid #e2e8f0;">
                                <input type="checkbox" name="task_weeding"
                                    style="width: 18px; height: 18px; accent-color: #10b981;">
                                <span style="font-size: 14px; color: #374151;">üåø Weeding completed</span>
                            </label>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 12px;">
                        <button type="button" onclick="closeCropEditModal()"
                            style="flex: 1; padding: 14px; background: white; border: 2px solid #e2e8f0; border-radius: 10px; font-weight: 600; color: #475569; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="submit"
                            style="flex: 1; padding: 14px; background: linear-gradient(135deg, #10b981, #059669); border: none; border-radius: 10px; font-weight: 600; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Fertilizer View Modal -->
    <div class="modal-overlay" id="fertilizerViewModal" style="display: none;">
        <div class="card" style="width: 500px; max-width: 95vw; max-height: 90vh; overflow-y: auto;">
            <div class="card-header"
                style="background: linear-gradient(135deg, #8b5cf6, #6d28d9); color: white; padding: 24px; position: relative;">
                <button onclick="closeFertilizerViewModal()"
                    style="position: absolute; right: 16px; top: 16px; background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; color: white; font-size: 18px;">√ó</button>
                <div style="display: flex; align-items: center; gap: 16px;">
                    <div
                        style="width: 60px; height: 60px; background: rgba(255,255,255,0.2); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 32px;">
                        üß™</div>
                    <div>
                        <h2 style="margin: 0; font-size: 22px;" id="viewFertilizerName">Fertilizer Name</h2>
                        <p style="margin: 4px 0 0 0; opacity: 0.9; font-size: 14px;"><i class="fas fa-seedling"></i>
                            For: <span id="viewFertilizerCrop">Crop</span></p>
                    </div>
                </div>
            </div>
            <div class="card-body" style="padding: 24px;">
                <!-- Fertilizer Details -->
                <div style="margin-bottom: 20px;">
                    <h4
                        style="margin: 0 0 16px 0; font-size: 14px; color: #1e293b; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-info-circle" style="color: #8b5cf6;"></i> Fertilizer Details
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                        <div
                            style="padding: 16px; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0; text-align: center;">
                            <div style="font-size: 11px; color: #64748b; text-transform: uppercase; font-weight: 600;">
                                Soil Type</div>
                            <div style="font-size: 16px; font-weight: 700; color: #1e293b; margin-top: 4px;"
                                id="viewFertilizerSoil">-</div>
                        </div>
                        <div
                            style="padding: 16px; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0; text-align: center;">
                            <div style="font-size: 11px; color: #64748b; text-transform: uppercase; font-weight: 600;">
                                Saved On</div>
                            <div style="font-size: 16px; font-weight: 700; color: #1e293b; margin-top: 4px;"
                                id="viewFertilizerDate">-</div>
                        </div>
                    </div>
                </div>

                <!-- NPK Values -->
                <div style="margin-bottom: 20px;">
                    <h4
                        style="margin: 0 0 16px 0; font-size: 14px; color: #1e293b; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-chart-bar" style="color: #10b981;"></i> Soil NPK Values
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                        <div
                            style="padding: 16px; background: linear-gradient(135deg, #dcfce7, #bbf7d0); border-radius: 12px; text-align: center;">
                            <div style="font-size: 11px; color: #166534; text-transform: uppercase; font-weight: 600;">
                                Nitrogen (N)</div>
                            <div style="font-size: 24px; font-weight: 700; color: #15803d; margin-top: 4px;"
                                id="viewFertilizerN">-</div>
                        </div>
                        <div
                            style="padding: 16px; background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 12px; text-align: center;">
                            <div style="font-size: 11px; color: #92400e; text-transform: uppercase; font-weight: 600;">
                                Phosphorus (P)</div>
                            <div style="font-size: 24px; font-weight: 700; color: #b45309; margin-top: 4px;"
                                id="viewFertilizerP">-</div>
                        </div>
                        <div
                            style="padding: 16px; background: linear-gradient(135deg, #ede9fe, #ddd6fe); border-radius: 12px; text-align: center;">
                            <div style="font-size: 11px; color: #5b21b6; text-transform: uppercase; font-weight: 600;">
                                Potassium (K)</div>
                            <div style="font-size: 24px; font-weight: 700; color: #7c3aed; margin-top: 4px;"
                                id="viewFertilizerK">-</div>
                        </div>
                    </div>
                </div>

                <!-- Application Tips -->
                <div style="margin-bottom: 20px;">
                    <h4
                        style="margin: 0 0 12px 0; font-size: 14px; color: #1e293b; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-lightbulb" style="color: #f59e0b;"></i> Application Tips
                    </h4>
                    <div
                        style="padding: 16px; background: #fffbeb; border-radius: 12px; border: 1px solid #fde68a; font-size: 13px; color: #92400e;">
                        <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                            <li>Apply fertilizer in early morning or late evening</li>
                            <li>Water the soil before and after application</li>
                            <li>Keep away from plant stem to avoid burning</li>
                            <li>Follow recommended dosage for best results</li>
                        </ul>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div style="margin-bottom: 16px;">
                    <h4
                        style="margin: 0 0 12px 0; font-size: 14px; color: #1e293b; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-shopping-cart" style="color: #f59e0b;"></i> Buy From
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                        <a id="buyAmazonBtn" href="https://www.amazon.in/s?k=fertilizer" target="_blank"
                            rel="noopener noreferrer"
                            style="padding: 12px; background: linear-gradient(135deg, #ff9900, #e68a00); border: none; border-radius: 10px; font-weight: 600; color: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; font-size: 12px; transition: all 0.3s; text-decoration: none;">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/a/a9/Amazon_logo.svg"
                                style="height: 18px; width: auto; filter: brightness(0) invert(1);" alt="Amazon">
                            Amazon
                        </a>
                        <a id="buyIndiamartBtn" href="https://www.indiamart.com/search.mp?ss=fertilizer" target="_blank"
                            rel="noopener noreferrer"
                            style="padding: 12px; background: linear-gradient(135deg, #0066cc, #004d99); border: none; border-radius: 10px; font-weight: 600; color: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; font-size: 12px; transition: all 0.3s; text-decoration: none;">
                            <span style="font-size: 20px;">üè≠</span>
                            IndiaMart
                        </a>
                        <a href="https://www.google.com/maps/search/fertilizer+shop+near+me" target="_blank"
                            style="padding: 12px; background: linear-gradient(135deg, #34a853, #2d8f47); border: none; border-radius: 10px; font-weight: 600; color: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; text-decoration: none; font-size: 12px;">
                            <span style="font-size: 20px;">üìç</span>
                            Nearby Stores
                        </a>
                    </div>
                </div>

                <button onclick="closeFertilizerViewModal()"
                    style="width: 100%; padding: 14px; background: white; border: 2px solid #e2e8f0; border-radius: 10px; font-weight: 600; color: #475569; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>

    <!-- Farmer's Manual Modal -->
    <div class="modal-overlay" id="farmersManualModal" style="display: none;">
        <div class="card" style="width: 1000px; max-width: 95vw; max-height: 90vh; overflow-y: auto;">
            <div class="card-header"
                style="background: linear-gradient(135deg, #059669, #047857); color: white; padding: 24px; position: sticky; top: 0; z-index: 100;">
                <button onclick="closeFarmersManualModal()"
                    style="position: absolute; right: 16px; top: 16px; background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; color: white; font-size: 18px;">√ó</button>
                <div style="display: flex; align-items: center; gap: 16px;">
                    <div
                        style="width: 60px; height: 60px; background: rgba(255,255,255,0.2); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 32px;">
                        üìö</div>
                    <div>
                        <h2 style="margin: 0; font-size: 24px;">Farmer's Manual</h2>
                        <p style="margin: 4px 0 0 0; opacity: 0.9; font-size: 14px;">Understanding Agricultural
                            Calculations & Recommendations</p>
                    </div>
                </div>
            </div>
            <div class="card-body" style="padding: 24px;">
                <!-- Navigation Tabs -->
                <div
                    style="display: flex; gap: 8px; margin-bottom: 24px; flex-wrap: wrap; border-bottom: 2px solid #e2e8f0; padding-bottom: 12px;">
                    <button onclick="showManualSection('soil')" id="tab-soil" class="manual-tab active"
                        style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">
                        üå± Soil Analysis
                    </button>
                    <button onclick="showManualSection('npk')" id="tab-npk" class="manual-tab"
                        style="padding: 10px 20px; background: #f1f5f9; color: #64748b; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">
                        üß™ NPK Values
                    </button>
                    <button onclick="showManualSection('climate')" id="tab-climate" class="manual-tab"
                        style="padding: 10px 20px; background: #f1f5f9; color: #64748b; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">
                        üå¶Ô∏è Climate Factors
                    </button>
                    <button onclick="showManualSection('crop')" id="tab-crop" class="manual-tab"
                        style="padding: 10px 20px; background: #f1f5f9; color: #64748b; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">
                        üåæ Crop Recommendation
                    </button>
                    <button onclick="showManualSection('fertilizer')" id="tab-fertilizer" class="manual-tab"
                        style="padding: 10px 20px; background: #f1f5f9; color: #64748b; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">
                        üíä Fertilizer Recommendation
                    </button>
                </div>

                <!-- Soil Analysis Section -->
                <div id="section-soil" class="manual-section">
                    <h3 style="color: #059669; margin-bottom: 16px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-flask"></i> Soil Analysis Parameters
                    </h3>

                    <!-- pH Value -->
                    <div
                        style="background: #f0fdf4; border-left: 4px solid #10b981; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 12px 0; color: #065f46; font-size: 16px;">üìä Soil pH Value</h4>
                        <p style="margin: 0 0 12px 0; color: #374151; line-height: 1.6;">
                            <strong>Definition:</strong> pH measures the acidity or alkalinity of soil on a scale of
                            0-14.
                        </p>
                        <div style="background: white; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                            <strong style="color: #059669;">Calculation Method:</strong>
                            <p
                                style="margin: 8px 0; font-family: monospace; background: #f8fafc; padding: 12px; border-radius: 6px; font-size: 13px;">
                                pH = -log‚ÇÅ‚ÇÄ[H‚Å∫]<br>
                                Where [H‚Å∫] is the hydrogen ion concentration in moles per liter
                            </p>
                        </div>
                        <div style="background: white; padding: 16px; border-radius: 8px;">
                            <strong style="color: #059669;">Interpretation:</strong>
                            <ul style="margin: 8px 0; padding-left: 20px; line-height: 1.8;">
                                <li><strong>pH &lt; 5.5:</strong> Highly Acidic - Lime application needed</li>
                                <li><strong>pH 5.5-6.5:</strong> Slightly Acidic - Ideal for most crops</li>
                                <li><strong>pH 6.5-7.5:</strong> Neutral - Optimal for nutrient availability</li>
                                <li><strong>pH 7.5-8.5:</strong> Slightly Alkaline - May need sulfur</li>
                                <li><strong>pH &gt; 8.5:</strong> Highly Alkaline - Nutrient deficiency risk</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Soil Moisture -->
                    <div
                        style="background: #eff6ff; border-left: 4px solid #3b82f6; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 12px 0; color: #1e40af; font-size: 16px;">üíß Soil Moisture Content</h4>
                        <div style="background: white; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                            <strong style="color: #3b82f6;">Gravimetric Method:</strong>
                            <p
                                style="margin: 8px 0; font-family: monospace; background: #f8fafc; padding: 12px; border-radius: 6px; font-size: 13px;">
                                Moisture % = [(Wet Weight - Dry Weight) / Dry Weight] √ó 100
                            </p>
                        </div>
                        <div style="background: white; padding: 16px; border-radius: 8px;">
                            <strong style="color: #3b82f6;">Optimal Ranges:</strong>
                            <ul style="margin: 8px 0; padding-left: 20px; line-height: 1.8;">
                                <li><strong>Sandy Soil:</strong> 10-15% - Drains quickly</li>
                                <li><strong>Loamy Soil:</strong> 20-30% - Ideal water retention</li>
                                <li><strong>Clay Soil:</strong> 30-40% - High water holding capacity</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Carbon Level -->
                    <div
                        style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 20px; border-radius: 12px;">
                        <h4 style="margin: 0 0 12px 0; color: #92400e; font-size: 16px;">üçÇ Organic Carbon Content</h4>
                        <p style="margin: 0 0 12px 0; color: #374151; line-height: 1.6;">
                            <strong>Definition:</strong> Organic carbon is the carbon stored in soil organic matter,
                            crucial for soil fertility, water retention, and microbial activity.
                        </p>
                        <div style="background: white; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                            <strong style="color: #f59e0b;">Walkley-Black Method (Wet Oxidation):</strong>
                            <p
                                style="margin: 8px 0; font-family: monospace; background: #f8fafc; padding: 12px; border-radius: 6px; font-size: 13px;">
                                Organic Carbon % = [(Blank - Sample) √ó N √ó 0.003 √ó 100] / Sample Weight<br>
                                Organic Matter % = Organic Carbon % √ó 1.724<br><br>
                                Where:<br>
                                ‚Ä¢ Blank = ml of FeSO‚ÇÑ used for blank titration<br>
                                ‚Ä¢ Sample = ml of FeSO‚ÇÑ used for sample titration<br>
                                ‚Ä¢ N = Normality of FeSO‚ÇÑ solution<br>
                                ‚Ä¢ 0.003 = Milliequivalent weight of carbon
                            </p>
                        </div>
                        <div style="background: white; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                            <strong style="color: #f59e0b;">Step-by-Step Calculation Example:</strong>
                            <p style="margin: 8px 0; color: #374151; line-height: 1.8;">
                                <strong>Given:</strong><br>
                                ‚Ä¢ Blank titration = 15.0 ml FeSO‚ÇÑ<br>
                                ‚Ä¢ Sample titration = 10.5 ml FeSO‚ÇÑ<br>
                                ‚Ä¢ Normality of FeSO‚ÇÑ = 0.5 N<br>
                                ‚Ä¢ Soil sample weight = 0.5 g<br><br>
                                <strong>Calculation:</strong><br>
                                OC % = [(15.0 - 10.5) √ó 0.5 √ó 0.003 √ó 100] / 0.5<br>
                                OC % = [4.5 √ó 0.5 √ó 0.003 √ó 100] / 0.5<br>
                                OC % = 0.675 / 0.5 = <strong>1.35%</strong><br><br>
                                Organic Matter % = 1.35 √ó 1.724 = <strong>2.33%</strong>
                            </p>
                        </div>
                        <div style="background: white; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                            <strong style="color: #f59e0b;">Classification & Interpretation:</strong>
                            <ul style="margin: 8px 0; padding-left: 20px; line-height: 1.8;">
                                <li><strong>&lt; 0.5%:</strong> Very Low - Severe deficiency, add 10-15 tons/ha FYM</li>
                                <li><strong>0.5-0.75%:</strong> Low - Add 5-10 tons/ha compost/manure</li>
                                <li><strong>0.75-1.0%:</strong> Medium - Maintain with crop residues</li>
                                <li><strong>&gt; 1.0%:</strong> High - Good soil health, continue practices</li>
                            </ul>
                        </div>
                        <div style="background: #fffbeb; padding: 16px; border-radius: 8px; border: 1px solid #fde68a;">
                            <strong style="color: #92400e;">üí° Importance of Soil Carbon:</strong>
                            <ul style="margin: 8px 0; padding-left: 20px; line-height: 1.8; color: #374151;">
                                <li>Improves soil structure and water holding capacity</li>
                                <li>Enhances nutrient availability and cation exchange</li>
                                <li>Supports beneficial soil microorganisms</li>
                                <li>Reduces soil erosion and compaction</li>
                                <li>Sequesters atmospheric CO‚ÇÇ (climate benefit)</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- NPK Section -->
                <div id="section-npk" class="manual-section" style="display: none;">
                    <h3 style="color: #059669; margin-bottom: 16px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-atom"></i> NPK Nutrient Analysis
                    </h3>

                    <!-- Nitrogen (N) -->
                    <div
                        style="background: #dbeafe; border-left: 4px solid #3b82f6; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 12px 0; color: #1e40af; font-size: 16px;">üîµ Nitrogen (N)</h4>
                        <p style="margin: 0 0 12px 0; color: #374151; line-height: 1.6;">
                            <strong>Role:</strong> Essential for leaf growth, chlorophyll production, and protein
                            synthesis.
                        </p>
                        <div style="background: white; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                            <strong style="color: #3b82f6;">Alkaline Permanganate Method:</strong>
                            <p
                                style="margin: 8px 0; font-family: monospace; background: #f8fafc; padding: 12px; border-radius: 6px; font-size: 13px;">
                                Available N (kg/ha) = [(Blank - Sample) √ó N √ó 0.014 √ó 1000] / Sample Weight
                            </p>
                        </div>
                        <div style="background: white; padding: 16px; border-radius: 8px;">
                            <strong style="color: #3b82f6;">Nutrient Status:</strong>
                            <ul style="margin: 8px 0; padding-left: 20px; line-height: 1.8;">
                                <li><strong>&lt; 280 kg/ha:</strong> Low - Heavy fertilization needed</li>
                                <li><strong>280-560 kg/ha:</strong> Medium - Moderate fertilization</li>
                                <li><strong>&gt; 560 kg/ha:</strong> High - Minimal fertilization</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Phosphorus (P) -->
                    <div
                        style="background: #fce7f3; border-left: 4px solid #ec4899; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 12px 0; color: #9f1239; font-size: 16px;">üî¥ Phosphorus (P)</h4>
                        <p style="margin: 0 0 12px 0; color: #374151; line-height: 1.6;">
                            <strong>Role:</strong> Critical for root development, flowering, and energy transfer (ATP).
                        </p>
                        <div style="background: white; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                            <strong style="color: #ec4899;">Olsen's Method (for alkaline soils):</strong>
                            <p
                                style="margin: 8px 0; font-family: monospace; background: #f8fafc; padding: 12px; border-radius: 6px; font-size: 13px;">
                                Available P‚ÇÇO‚ÇÖ (kg/ha) = [Reading √ó 2.5 √ó Volume] / Sample Weight
                            </p>
                        </div>
                        <div style="background: white; padding: 16px; border-radius: 8px;">
                            <strong style="color: #ec4899;">Nutrient Status:</strong>
                            <ul style="margin: 8px 0; padding-left: 20px; line-height: 1.8;">
                                <li><strong>&lt; 12.5 kg/ha:</strong> Low - Phosphatic fertilizers required</li>
                                <li><strong>12.5-25 kg/ha:</strong> Medium - Moderate application</li>
                                <li><strong>&gt; 25 kg/ha:</strong> High - Maintenance dose only</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Potassium (K) -->
                    <div
                        style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 20px; border-radius: 12px;">
                        <h4 style="margin: 0 0 12px 0; color: #92400e; font-size: 16px;">üü° Potassium (K)</h4>
                        <p style="margin: 0 0 12px 0; color: #374151; line-height: 1.6;">
                            <strong>Role:</strong> Regulates water uptake, disease resistance, and fruit quality.
                        </p>
                        <div style="background: white; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                            <strong style="color: #f59e0b;">Flame Photometer Method:</strong>
                            <p
                                style="margin: 8px 0; font-family: monospace; background: #f8fafc; padding: 12px; border-radius: 6px; font-size: 13px;">
                                Available K‚ÇÇO (kg/ha) = [Reading √ó Dilution Factor √ó 2.5] / Sample Weight
                            </p>
                        </div>
                        <div style="background: white; padding: 16px; border-radius: 8px;">
                            <strong style="color: #f59e0b;">Nutrient Status:</strong>
                            <ul style="margin: 8px 0; padding-left: 20px; line-height: 1.8;">
                                <li><strong>&lt; 110 kg/ha:</strong> Low - Potassic fertilizers needed</li>
                                <li><strong>110-280 kg/ha:</strong> Medium - Balanced application</li>
                                <li><strong>&gt; 280 kg/ha:</strong> High - Minimal supplementation</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Climate Factors Section -->
                <div id="section-climate" class="manual-section" style="display: none;">
                    <h3 style="color: #059669; margin-bottom: 16px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-cloud-rain"></i> Climate & Environmental Factors
                    </h3>

                    <!-- Rainfall -->
                    <div
                        style="background: #dbeafe; border-left: 4px solid #0ea5e9; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 12px 0; color: #075985; font-size: 16px;">üåßÔ∏è Rainfall Analysis</h4>
                        <div style="background: white; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                            <strong style="color: #0ea5e9;">Measurement & Calculation:</strong>
                            <p
                                style="margin: 8px 0; font-family: monospace; background: #f8fafc; padding: 12px; border-radius: 6px; font-size: 13px;">
                                Rainfall (mm) = Volume of Water Collected (ml) / Area of Collector (cm¬≤) √ó 10<br>
                                Annual Rainfall = Œ£ Monthly Rainfall
                            </p>
                        </div>
                        <div style="background: white; padding: 16px; border-radius: 8px;">
                            <strong style="color: #0ea5e9;">Crop Water Requirements:</strong>
                            <ul style="margin: 8px 0; padding-left: 20px; line-height: 1.8;">
                                <li><strong>Rice:</strong> 1200-1500 mm/season</li>
                                <li><strong>Wheat:</strong> 450-650 mm/season</li>
                                <li><strong>Cotton:</strong> 700-1300 mm/season</li>
                                <li><strong>Sugarcane:</strong> 1500-2500 mm/season</li>
                                <li><strong>Vegetables:</strong> 300-500 mm/season</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Temperature -->
                    <div
                        style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 12px 0; color: #92400e; font-size: 16px;">üå°Ô∏è Temperature Requirements
                        </h4>
                        <div style="background: white; padding: 16px; border-radius: 8px;">
                            <strong style="color: #f59e0b;">Optimal Temperature Ranges:</strong>
                            <ul style="margin: 8px 0; padding-left: 20px; line-height: 1.8;">
                                <li><strong>Cool Season Crops:</strong> 15-20¬∞C (Wheat, Peas, Cabbage)</li>
                                <li><strong>Warm Season Crops:</strong> 20-30¬∞C (Rice, Cotton, Tomato)</li>
                                <li><strong>Hot Season Crops:</strong> 25-35¬∞C (Watermelon, Okra, Chili)</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Humidity -->
                    <div
                        style="background: #e0f2fe; border-left: 4px solid #06b6d4; padding: 20px; border-radius: 12px;">
                        <h4 style="margin: 0 0 12px 0; color: #164e63; font-size: 16px;">üí® Humidity Measurement &
                            Calculations</h4>
                        <p style="margin: 0 0 12px 0; color: #374151; line-height: 1.6;">
                            <strong>Definition:</strong> Humidity measures the amount of water vapor in the air,
                            critical for plant transpiration, disease development, and irrigation scheduling.
                        </p>
                        <div style="background: white; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                            <strong style="color: #06b6d4;">Relative Humidity (RH) Formula:</strong>
                            <p
                                style="margin: 8px 0; font-family: monospace; background: #f8fafc; padding: 12px; border-radius: 6px; font-size: 13px;">
                                RH % = (Actual Vapor Pressure / Saturation Vapor Pressure) √ó 100<br><br>
                                Alternative Formula:<br>
                                RH % = (Actual Moisture Content / Maximum Moisture Capacity) √ó 100
                            </p>
                        </div>
                        <div style="background: white; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                            <strong style="color: #06b6d4;">Saturation Vapor Pressure Calculation:</strong>
                            <p
                                style="margin: 8px 0; font-family: monospace; background: #f8fafc; padding: 12px; border-radius: 6px; font-size: 13px;">
                                SVP = 6.11 √ó 10^[(7.5 √ó T) / (237.3 + T)]<br><br>
                                Where:<br>
                                ‚Ä¢ SVP = Saturation Vapor Pressure (mb or hPa)<br>
                                ‚Ä¢ T = Temperature in ¬∞C<br>
                                ‚Ä¢ 6.11 = Constant (mb at 0¬∞C)
                            </p>
                        </div>
                        <div style="background: white; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                            <strong style="color: #06b6d4;">Step-by-Step Calculation Example:</strong>
                            <p style="margin: 8px 0; color: #374151; line-height: 1.8;">
                                <strong>Given:</strong><br>
                                ‚Ä¢ Air temperature = 30¬∞C<br>
                                ‚Ä¢ Dew point temperature = 20¬∞C<br><br>
                                <strong>Step 1: Calculate SVP at air temperature (30¬∞C)</strong><br>
                                SVP‚ÇÉ‚ÇÄ = 6.11 √ó 10^[(7.5 √ó 30) / (237.3 + 30)]<br>
                                SVP‚ÇÉ‚ÇÄ = 6.11 √ó 10^[225 / 267.3]<br>
                                SVP‚ÇÉ‚ÇÄ = 6.11 √ó 10^0.842 = 6.11 √ó 6.95<br>
                                SVP‚ÇÉ‚ÇÄ = <strong>42.46 mb</strong><br><br>
                                <strong>Step 2: Calculate actual vapor pressure at dew point (20¬∞C)</strong><br>
                                AVP‚ÇÇ‚ÇÄ = 6.11 √ó 10^[(7.5 √ó 20) / (237.3 + 20)]<br>
                                AVP‚ÇÇ‚ÇÄ = 6.11 √ó 10^[150 / 257.3]<br>
                                AVP‚ÇÇ‚ÇÄ = 6.11 √ó 10^0.583 = 6.11 √ó 3.83<br>
                                AVP‚ÇÇ‚ÇÄ = <strong>23.40 mb</strong><br><br>
                                <strong>Step 3: Calculate Relative Humidity</strong><br>
                                RH = (23.40 / 42.46) √ó 100<br>
                                RH = <strong>55.1%</strong>
                            </p>
                        </div>
                        <div style="background: white; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                            <strong style="color: #06b6d4;">Dew Point Calculation:</strong>
                            <p
                                style="margin: 8px 0; font-family: monospace; background: #f8fafc; padding: 12px; border-radius: 6px; font-size: 13px;">
                                Td = (237.3 √ó b) / (a - b)<br><br>
                                Where:<br>
                                a = (17.27 √ó T) / (237.3 + T) + ln(RH/100)<br>
                                b = (a √ó 237.3) / (17.27 - a)<br>
                                Td = Dew Point Temperature (¬∞C)
                            </p>
                        </div>
                        <div style="background: white; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                            <strong style="color: #06b6d4;">Impact on Crops & Agriculture:</strong>
                            <ul style="margin: 8px 0; padding-left: 20px; line-height: 1.8;">
                                <li><strong>&lt; 40% RH:</strong> Low humidity - Increased transpiration, water stress,
                                    tip burn</li>
                                <li><strong>40-60% RH:</strong> Optimal for most field crops - Balanced water uptake
                                </li>
                                <li><strong>60-70% RH:</strong> Good for leafy vegetables - Reduced water loss</li>
                                <li><strong>70-80% RH:</strong> High humidity - Disease risk (fungal), poor pollination
                                </li>
                                <li><strong>&gt; 80% RH:</strong> Very high - Severe disease pressure, blossom drop</li>
                            </ul>
                        </div>
                        <div style="background: #f0f9ff; padding: 16px; border-radius: 8px; border: 1px solid #bae6fd;">
                            <strong style="color: #164e63;">üí° Practical Applications:</strong>
                            <ul style="margin: 8px 0; padding-left: 20px; line-height: 1.8; color: #374151;">
                                <li><strong>Irrigation Timing:</strong> High RH (>70%) = Delay irrigation to prevent
                                    disease</li>
                                <li><strong>Fungicide Application:</strong> Apply when RH &lt; 80% for better efficacy
                                </li>
                                <li><strong>Pollination:</strong> Optimal at 50-70% RH for pollen viability</li>
                                <li><strong>Harvest Planning:</strong> Low RH (&lt;60%) ideal for grain harvesting</li>
                                <li><strong>Disease Forecasting:</strong> RH &gt; 90% for 6+ hours = High disease risk
                                </li>
                            </ul>
                        </div>
                        <div
                            style="background: #fef3c7; padding: 16px; border-radius: 8px; border: 1px solid #fde68a; margin-top: 12px;">
                            <strong style="color: #92400e;">‚ö†Ô∏è Critical Humidity Thresholds:</strong>
                            <table style="width: 100%; margin-top: 8px; font-size: 13px;">
                                <tr style="border-bottom: 1px solid #fde68a;">
                                    <td style="padding: 8px; font-weight: 600;">Disease</td>
                                    <td style="padding: 8px; font-weight: 600;">Critical RH</td>
                                    <td style="padding: 8px; font-weight: 600;">Duration</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #fef3c7;">
                                    <td style="padding: 8px;">Late Blight (Potato/Tomato)</td>
                                    <td style="padding: 8px;">&gt; 90%</td>
                                    <td style="padding: 8px;">12+ hours</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #fef3c7;">
                                    <td style="padding: 8px;">Powdery Mildew</td>
                                    <td style="padding: 8px;">40-70%</td>
                                    <td style="padding: 8px;">Continuous</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px;">Downy Mildew</td>
                                    <td style="padding: 8px;">&gt; 85%</td>
                                    <td style="padding: 8px;">6+ hours</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Crop Recommendation Section -->
                <div id="section-crop" class="manual-section" style="display: none;">
                    <h3 style="color: #059669; margin-bottom: 16px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-seedling"></i> Crop Recommendation System
                    </h3>

                    <div
                        style="background: #f0fdf4; border-left: 4px solid #10b981; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 12px 0; color: #065f46; font-size: 16px;">ü§ñ Machine Learning Model</h4>
                        <p style="margin: 0 0 12px 0; color: #374151; line-height: 1.6;">
                            Our system uses a <strong>Random Forest Classifier</strong> trained on thousands of
                            agricultural data points to recommend the best crop for your conditions.
                        </p>
                        <div style="background: white; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                            <strong style="color: #10b981;">Input Parameters:</strong>
                            <ul style="margin: 8px 0; padding-left: 20px; line-height: 1.8;">
                                <li><strong>Nitrogen (N):</strong> Available nitrogen in soil (kg/ha)</li>
                                <li><strong>Phosphorus (P):</strong> Available phosphorus in soil (kg/ha)</li>
                                <li><strong>Potassium (K):</strong> Available potassium in soil (kg/ha)</li>
                                <li><strong>Temperature:</strong> Average temperature (¬∞C)</li>
                                <li><strong>Humidity:</strong> Relative humidity (%)</li>
                                <li><strong>pH:</strong> Soil pH value (0-14)</li>
                                <li><strong>Rainfall:</strong> Annual rainfall (mm)</li>
                            </ul>
                        </div>
                        <div style="background: white; padding: 16px; border-radius: 8px;">
                            <strong style="color: #10b981;">Recommendation Logic:</strong>
                            <p
                                style="margin: 8px 0; font-family: monospace; background: #f8fafc; padding: 12px; border-radius: 6px; font-size: 13px;">
                                1. Normalize all input parameters<br>
                                2. Compare with optimal ranges for each crop<br>
                                3. Calculate suitability score using weighted factors<br>
                                4. Rank crops by probability score<br>
                                5. Return top 3 recommendations with confidence levels
                            </p>
                        </div>
                    </div>

                    <div
                        style="background: #eff6ff; border-left: 4px solid #3b82f6; padding: 20px; border-radius: 12px;">
                        <h4 style="margin: 0 0 12px 0; color: #1e40af; font-size: 16px;">üìä Suitability Scoring</h4>
                        <div style="background: white; padding: 16px; border-radius: 8px;">
                            <strong style="color: #3b82f6;">Weighted Score Formula:</strong>
                            <p
                                style="margin: 8px 0; font-family: monospace; background: #f8fafc; padding: 12px; border-radius: 6px; font-size: 13px;">
                                Score = (0.25 √ó NPK_Match) + (0.20 √ó Climate_Match) + <br>
                                (0.20 √ó pH_Match) + (0.20 √ó Rainfall_Match) + <br>
                                (0.15 √ó Seasonal_Factor)
                            </p>
                            <p style="margin: 12px 0 0 0; color: #374151; line-height: 1.6;">
                                Where each match factor is calculated as:<br>
                                <code style="background: #f8fafc; padding: 4px 8px; border-radius: 4px;">
                                    Match = 100 - |Actual - Optimal| / Optimal √ó 100
                                </code>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Fertilizer Recommendation Section -->
                <div id="section-fertilizer" class="manual-section" style="display: none;">
                    <h3 style="color: #059669; margin-bottom: 16px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-flask"></i> Fertilizer Recommendation System
                    </h3>

                    <div
                        style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 12px 0; color: #92400e; font-size: 16px;">üßÆ Nutrient Requirement
                            Calculation</h4>
                        <div style="background: white; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                            <strong style="color: #f59e0b;">Fertilizer Dose Formula:</strong>
                            <p
                                style="margin: 8px 0; font-family: monospace; background: #f8fafc; padding: 12px; border-radius: 6px; font-size: 13px;">
                                Fertilizer Required (kg/ha) = <br>
                                [(Crop Requirement - Soil Available) √ó 100] / Fertilizer Nutrient %
                            </p>
                        </div>
                        <div style="background: white; padding: 16px; border-radius: 8px;">
                            <strong style="color: #f59e0b;">Example Calculation for Rice:</strong>
                            <p style="margin: 8px 0; color: #374151; line-height: 1.8;">
                                <strong>Given:</strong><br>
                                ‚Ä¢ Crop N requirement: 120 kg/ha<br>
                                ‚Ä¢ Soil available N: 280 kg/ha<br>
                                ‚Ä¢ Urea contains: 46% N<br><br>
                                <strong>Calculation:</strong><br>
                                N deficit = 120 - (280 √ó 0.5) = -20 kg/ha<br>
                                Since soil has sufficient N, minimal urea needed<br>
                                Urea = max(0, deficit) √ó 100 / 46 = 0 kg/ha
                            </p>
                        </div>
                    </div>

                    <div
                        style="background: #dbeafe; border-left: 4px solid #3b82f6; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 12px 0; color: #1e40af; font-size: 16px;">üìã Common Fertilizer Types</h4>
                        <div style="background: white; padding: 16px; border-radius: 8px;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                                        <th style="padding: 12px; text-align: left; color: #1e293b;">Fertilizer</th>
                                        <th style="padding: 12px; text-align: center; color: #1e293b;">N%</th>
                                        <th style="padding: 12px; text-align: center; color: #1e293b;">P%</th>
                                        <th style="padding: 12px; text-align: center; color: #1e293b;">K%</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr style="border-bottom: 1px solid #f1f5f9;">
                                        <td style="padding: 10px;">Urea</td>
                                        <td style="padding: 10px; text-align: center;">46</td>
                                        <td style="padding: 10px; text-align: center;">0</td>
                                        <td style="padding: 10px; text-align: center;">0</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #f1f5f9;">
                                        <td style="padding: 10px;">DAP</td>
                                        <td style="padding: 10px; text-align: center;">18</td>
                                        <td style="padding: 10px; text-align: center;">46</td>
                                        <td style="padding: 10px; text-align: center;">0</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #f1f5f9;">
                                        <td style="padding: 10px;">MOP</td>
                                        <td style="padding: 10px; text-align: center;">0</td>
                                        <td style="padding: 10px; text-align: center;">0</td>
                                        <td style="padding: 10px; text-align: center;">60</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #f1f5f9;">
                                        <td style="padding: 10px;">NPK 10:26:26</td>
                                        <td style="padding: 10px; text-align: center;">10</td>
                                        <td style="padding: 10px; text-align: center;">26</td>
                                        <td style="padding: 10px; text-align: center;">26</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 10px;">NPK 20:20:20</td>
                                        <td style="padding: 10px; text-align: center;">20</td>
                                        <td style="padding: 10px; text-align: center;">20</td>
                                        <td style="padding: 10px; text-align: center;">20</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div
                        style="background: #f0fdf4; border-left: 4px solid #10b981; padding: 20px; border-radius: 12px;">
                        <h4 style="margin: 0 0 12px 0; color: #065f46; font-size: 16px;">‚öñÔ∏è Recommendation Algorithm
                        </h4>
                        <div style="background: white; padding: 16px; border-radius: 8px;">
                            <strong style="color: #10b981;">Decision Tree Logic:</strong>
                            <p
                                style="margin: 8px 0; font-family: monospace; background: #f8fafc; padding: 12px; border-radius: 6px; font-size: 13px;">
                                IF (N &lt; Low_Threshold) AND (P &lt; Low_Threshold) AND (K &lt; Low_Threshold)<br>
                                THEN Recommend: NPK Complex (20:20:20)<br>
                                ELSE IF (N &lt; Low_Threshold) AND (P is Adequate)<br>
                                THEN Recommend: Urea<br>
                                ELSE IF (P &lt; Low_Threshold)<br>
                                THEN Recommend: DAP or SSP<br>
                                ELSE IF (K &lt; Low_Threshold)<br>
                                THEN Recommend: MOP<br>
                                ELSE<br>
                                THEN Recommend: Maintenance dose only
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div style="margin-top: 24px; padding-top: 20px; border-top: 2px solid #e2e8f0; text-align: center;">
                    <p style="color: #64748b; font-size: 13px; margin: 0 0 16px 0;">
                        üí° <strong>Note:</strong> These calculations are based on standard agricultural practices and
                        scientific methods.
                        Always consult with local agricultural experts for region-specific recommendations.
                    </p>
                    <button onclick="closeFarmersManualModal()"
                        style="padding: 12px 32px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 14px;">
                        <i class="fas fa-check"></i> Got It!
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script id="dashboard-data" type="application/json">
    {
        "userId": "{{ user.id | default(user._id) | default('') }}",
        "userState": "{{ user.state }}",
        "userDistrict": "{{ user.district }}",
        "defaultCommodity": "{{ price_predictions[0].commodity if price_predictions else (market_prices[0].commodity if market_prices else 'Tomato') }}"
    }
    </script>
    {% endblock %}

    {% block scripts %}
    <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
    {% endblock %}