{% extends "base.html" %}

{% block title %}My Listings - Direct Buyer Connect{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/buyer_connect.css') }}">
{% endblock %}

{% block content %}
<div class="dashboard-layout">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">ğŸŒ¾</div>
            <div>
                <div class="sidebar-title">Smart Farming</div>
                <div class="sidebar-subtitle">Agricultural Platform</div>
            </div>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Main Menu</div>
                <a href="{{ url_for('dashboard.dashboard') }}" class="nav-link">
                    <i class="fas fa-th-large"></i>
                    <span>Dashboard</span>
                </a>
                <a href="{{ url_for('crop.crop_suggestion') }}" class="nav-link">
                    <i class="fas fa-seedling"></i>
                    <span>Crop Suggestion</span>
                </a>
                <a href="{{ url_for('fertilizer.fertilizer_recommend') }}" class="nav-link">
                    <i class="fas fa-flask"></i>
                    <span>Fertilizer Advice</span>
                </a>
                <a href="{{ url_for('market.market_watch') }}" class="nav-link">
                    <i class="fas fa-chart-line"></i>
                    <span>Market Prices</span>
                    <span class="badge">Live</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Buyer Connect</div>
                <a href="{{ url_for('buyer_connect.create_listing') }}" class="nav-link">
                    <i class="fas fa-plus-circle"></i>
                    <span>Sell My Crop</span>
                </a>
                <a href="{{ url_for('buyer_connect.my_listings') }}" class="nav-link active">
                    <i class="fas fa-list-alt"></i>
                    <span>My Listings</span>
                </a>
                <a href="{{ url_for('buyer_connect.marketplace') }}" class="nav-link">
                    <i class="fas fa-store"></i>
                    <span>Buy from Farmers</span>
                    <span class="badge" style="background: #3b82f6;">New</span>
                </a>
            </div>
        </nav>

        <div class="sidebar-user">
            <div class="user-info">
                <div class="user-avatar">{{ session.get('user_name', 'U')[0] }}</div>
                <div class="user-details">
                    <h4>{{ session.get('user_name', 'User') }}</h4>
                    <span>Farmer</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Page Header -->
        <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1>
                    <i class="fas fa-list-alt"></i> My Listings
                </h1>
                <p class="page-subtitle">Manage your crop listings and track sales</p>
            </div>
            <a href="{{ url_for('buyer_connect.create_listing') }}" class="btn-submit">
                <i class="fas fa-plus-circle"></i> Create New Listing
            </a>
        </div>

        <!-- Listings -->
        {% if listings %}
        <div class="listings-grid" style="display: grid; gap: 24px; margin-top: 32px;">
            {% for listing in listings %}
            <div class="listing-card status-{{ listing.status }}"
                style="background: white; border-radius: var(--radius-lg); box-shadow: var(--shadow-md); overflow: hidden;">
                <div
                    style="display: grid; grid-template-columns: auto 1fr auto; gap: 24px; padding: 28px; align-items: center;">
                    <!-- Crop Icon -->
                    <div
                        style="width: 90px; height: 90px; background: linear-gradient(135deg, var(--accent-green), #059669); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; font-size: 48px; box-shadow: 0 4px 12px rgba(34, 197, 94, 0.2);">
                        {% set listing_icon_map = {
                        'Tomato': 'ğŸ…', 'Onion': 'ğŸ§…', 'Potato': 'ğŸ¥”', 'Brinjal': 'ğŸ†',
                        'Cabbage': 'ğŸ¥¬', 'Cauliflower': 'ğŸ¥¦', 'Carrot': 'ğŸ¥•', 'Beetroot': 'ğŸ ',
                        'Green Chilli': 'ğŸŒ¶ï¸', 'Capsicum': 'ğŸ«‘', 'Beans': 'ğŸ«˜', 'Lady Finger': 'ğŸ–ï¸',
                        'Drumstick': 'ğŸ¥¢', 'Bottle Gourd': 'ğŸ¥’', 'Pumpkin': 'ğŸƒ', 'Radish': 'ğŸ¥—',
                        'Sweet Corn': 'ğŸŒ½', 'Peas': 'ğŸ«›', 'Garlic': 'ğŸ§„', 'Ginger': 'ğŸ«š',
                        'Spinach': 'ğŸ¥¬', 'Mushroom': 'ğŸ„', 'Cucumber': 'ğŸ¥’', 'Lemon': 'ğŸ‹',
                        'Bitter Gourd': 'ğŸ¥’', 'Ridge Gourd': 'ğŸ¥’', 'Snake Gourd': 'ğŸ', 'Ash Gourd': 'âšª',
                        'Turnip': 'ğŸ¥”', 'Colocasia': 'ğŸ¥”', 'Jack Fruit': 'ğŸˆ', 'Pointed Gourd': 'ğŸ¥’',
                        'Apple': 'ğŸ', 'Banana': 'ğŸŒ', 'Orange': 'ğŸŠ', 'Mosambi': 'ğŸ‹',
                        'Grapes': 'ğŸ‡', 'Pomegranate': 'ğŸª€', 'Papaya': 'ğŸˆ', 'Pineapple': 'ğŸ',
                        'Watermelon': 'ğŸ‰', 'Muskmelon': 'ğŸˆ', 'Mango': 'ğŸ¥­', 'Guava': 'ğŸ',
                        'Custard Apple': 'ğŸ', 'Sapota': 'ğŸ¥”', 'Strawberry': 'ğŸ“',
                        'Kiwi': 'ğŸ¥', 'Pear': 'ğŸ', 'Plum': 'ğŸ«', 'Peach': 'ğŸ‘',
                        'Litchi': 'ğŸ’', 'Cherry': 'ğŸ’', 'Apricot': 'ğŸ‘', 'Ber': 'ğŸ’', 'Amla': 'ğŸ',
                        'Paddy': 'ğŸš', 'Rice': 'ğŸš', 'Wheat': 'ğŸŒ¾', 'Maize': 'ğŸŒ½',
                        'Barley': 'ğŸŒ¾', 'Bajra': 'ğŸŒ¾', 'Jowar': 'ğŸŒ¾', 'Ragi': 'ğŸŒ¾',
                        'Sorghum': 'ğŸŒ¾', 'Millet': 'ğŸŒ¾', 'Oats': 'ğŸ¥£',
                        'Bengal Gram': 'ğŸŸ¤', 'Gram': 'ğŸŸ¤', 'Black Gram': 'âš«',
                        'Green Gram': 'ğŸŸ¢', 'Moong': 'ğŸŸ¢', 'Red Gram': 'ğŸŸ¡', 'Arhar': 'ğŸŸ¡',
                        'Tur': 'ğŸŸ¡', 'Lentil': 'ğŸ”´', 'Masur': 'ğŸ”´', 'Horse Gram': 'ğŸŸ¤',
                        'Cowpea': 'ğŸ«˜', 'Lobia': 'ğŸ«˜', 'Chickpea': 'ğŸ§†', 'Rajmah': 'ğŸ«˜',
                        'Groundnut': 'ğŸ¥œ', 'Mustard': 'ğŸŒ¼', 'Soyabean': 'ğŸ«˜', 'Sunflower': 'ğŸŒ»',
                        'Sesamum': 'ğŸ¥¯', 'Sesame': 'ğŸ¥¯', 'Castor': 'ğŸŒ¿', 'Linseed': 'ğŸŒ¸',
                        'Niger': 'ğŸŒ¿', 'Safflower': 'ğŸŒº', 'Coconut': 'ğŸ¥¥', 'Copra': 'ğŸ¥¥', 'Palm': 'ğŸŒ´',
                        'Chilly': 'ğŸŒ¶ï¸', 'Turmeric': 'ğŸŸ¡', 'Coriander': 'ğŸŒ¿', 'Cumin': 'ğŸ§‚', 'Jeera': 'ğŸ§‚',
                        'Black Pepper': 'âš«', 'Cardamom': 'ğŸŒ¿', 'Tamarind': 'ğŸŸ¤', 'Arecanut': 'ğŸŒ°', 'Betelnut': 'ğŸŒ°',
                        'Ajwan': 'ğŸŒ¿',
                        'Cotton': 'â˜ï¸', 'Sugarcane': 'ğŸ‹', 'Tea': 'ğŸµ', 'Coffee': 'â˜•',
                        'Jute': 'ğŸ§¶', 'Rubber': 'ğŸŒ³', 'Tobacco': 'ğŸ‚', 'Mesta': 'ğŸ§¶',
                        'Cashewnut': 'ğŸ¥œ', 'Almond': 'ğŸŒ°', 'Raisin': 'ğŸ‡', 'Walnut': 'ğŸŒ°',
                        'Milk': 'ğŸ¥›', 'Egg': 'ğŸ¥š', 'Poultry': 'ğŸ”', 'Chicken': 'ğŸ”',
                        'Fish': 'ğŸŸ', 'Mutton': 'ğŸ¥©', 'Goat': 'ğŸ', 'Sheep': 'ğŸ‘'
                        } %}
                        {% set icon =
                        listing_icon_map.get(listing.crop.split('(')[0].split('Raw')[0].split('Seed')[0].strip(), 'ğŸŒ¾')
                        %}
                        {{ icon }}
                    </div>

                    <!-- Details -->
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
                            <h3 style="font-size: 26px; font-weight: 700; color: var(--text-primary); margin: 0;">{{
                                listing.crop }}</h3>
                            {% if listing.status == 'available' %}
                            <span class="status-badge"
                                style="background: #dcfce7; color: #166534; padding: 6px 16px; border-radius: 20px; font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">
                                <i class="fas fa-check-circle"></i> AVAILABLE
                            </span>
                            {% elif listing.status == 'sold' %}
                            <span class="status-badge"
                                style="background: #fee2e2; color: #991b1b; padding: 6px 16px; border-radius: 20px; font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">
                                <i class="fas fa-check-double"></i> SOLD
                            </span>
                            {% elif listing.status == 'cancelled' %}
                            <span class="status-badge"
                                style="background: #f1f5f9; color: #64748b; padding: 6px 16px; border-radius: 20px; font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">
                                <i class="fas fa-times-circle"></i> CANCELLED
                            </span>
                            {% endif %}
                        </div>

                        <div
                            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 20px; margin-bottom: 12px;">
                            <div>
                                <div
                                    style="font-size: 12px; color: var(--text-secondary); margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                                    Quantity</div>
                                <div style="font-weight: 700; color: var(--text-primary); font-size: 16px;">{{
                                    listing.quantity }} {{ listing.unit }}</div>
                            </div>
                            <div>
                                <div
                                    style="font-size: 12px; color: var(--text-secondary); margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                                    Your Price</div>
                                <div style="font-weight: 800; color: var(--accent-green); font-size: 22px;">â‚¹{{
                                    "%.2f"|format(listing.farmer_price) }}/kg</div>
                            </div>
                            <div>
                                <div
                                    style="font-size: 12px; color: var(--text-secondary); margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                                    Market Price</div>
                                <div style="font-weight: 600; color: var(--text-secondary); font-size: 16px;">â‚¹{{
                                    "%.2f"|format(listing.live_market_price|default(0)) }}/kg</div>
                            </div>
                            <div>
                                <div
                                    style="font-size: 12px; color: var(--text-secondary); margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                                    Location</div>
                                <div style="font-weight: 600; color: var(--text-primary); font-size: 15px;">
                                    <i class="fas fa-map-marker-alt" style="color: var(--accent-red);"></i> {{
                                    listing.district }}, {{ listing.state }}
                                </div>
                            </div>
                            <div>
                                <div
                                    style="font-size: 12px; color: var(--text-secondary); margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                                    Posted On</div>
                                <div style="font-weight: 600; color: var(--text-primary); font-size: 15px;">
                                    <i class="fas fa-calendar-alt" style="color: var(--accent-blue);"></i> {{
                                    listing.created_at[:10] }}
                                </div>
                            </div>
                        </div>

                        {% if listing.status == 'sold' and listing.buyer_name %}
                        <div
                            style="margin-top: 16px; padding: 14px 18px; background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: var(--radius-md); border-left: 4px solid #f59e0b; box-shadow: 0 2px 6px rgba(245, 158, 11, 0.2);">
                            <div style="font-size: 14px; color: #92400e; font-weight: 600;">
                                <i class="fas fa-user-check"></i> <strong>Sold to:</strong> {{ listing.buyer_name }} â€¢
                                ğŸ“ {{ listing.buyer_phone }}
                            </div>
                        </div>
                        {% endif %}

                        {% if listing.description %}
                        <div
                            style="margin-top: 14px; padding: 12px 16px; background: var(--bg-secondary); border-radius: var(--radius-md); font-size: 14px; color: var(--text-secondary); line-height: 1.6;">
                            <i class="fas fa-align-left" style="color: var(--accent-blue);"></i> {{ listing.description
                            }}
                        </div>
                        {% endif %}
                    </div>

                    <!-- Actions -->
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        {% if listing.status == 'available' %}
                        <button onclick="cancelListing(this)" data-id="{{ listing._id }}" class="btn-delete"
                            style="padding: 12px 24px; background: linear-gradient(135deg, #fee2e2, #fecaca); color: #dc2626; border: 2px solid #fca5a5; border-radius: var(--radius-md); font-weight: 700; cursor: pointer; white-space: nowrap; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(220, 38, 38, 0.2);">
                            <i class="fas fa-trash-alt"></i> Cancel
                        </button>
                        {% elif listing.status == 'cancelled' %}
                        <button disabled
                            style="padding: 12px 24px; background: #f1f5f9; color: #94a3b8; border: 2px solid #e2e8f0; border-radius: var(--radius-md); font-weight: 600; cursor: not-allowed; white-space: nowrap;">
                            <i class="fas fa-ban"></i> Cancelled
                        </button>
                        {% elif listing.status == 'sold' %}
                        <button disabled
                            style="padding: 12px 24px; background: #dcfce7; color: #166534; border: 2px solid #86efac; border-radius: var(--radius-md); font-weight: 600; cursor: not-allowed; white-space: nowrap;">
                            <i class="fas fa-check-double"></i> Sold
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-state-icon">ğŸ“‹</div>
            <h3>No Listings Yet</h3>
            <p style="margin-bottom: 24px;">You haven't created any crop listings yet. Start selling your crops directly
                to buyers!</p>
            <a href="{{ url_for('buyer_connect.create_listing') }}" class="btn-submit">
                <i class="fas fa-plus-circle"></i> Create Your First Listing
            </a>
        </div>
        {% endif %}
    </div>
</div>

<script>
    function cancelListing(button) {
        const listingId = button.dataset.id;
        if (!listingId) {
            alert('Error: Invalid Listing ID');
            console.error('Missing listing ID');
            return;
        }

        if (!confirm('âš ï¸ Are you sure you want to cancel this listing? This action cannot be undone.')) {
            return;
        }

        // The second parameter 'button' is passed as 'this' from the HTML onclick
        if (button) {
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cancelling...';
        }

        console.log('Cancelling crop listing:', listingId);

        // Use a placeholder to generate the correct base path even via reverse proxy
        const apiBase = "{{ url_for('buyer_connect.api_cancel_listing', listing_id='0') }}";
        // Replace '0' with the actual ID. splitting ensures we handle the tail correctly
        const url = apiBase.replace('0', listingId);

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            }
        })
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    return response.json().then(err => { throw err; }).catch(() => {
                        throw new Error('Server error: ' + response.status);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Cancel data:', data);
                if (data.success) {
                    if (window.showToast) {
                        showToast('Listing cancelled successfully!', 'success');
                    } else {
                        alert('âœ… Listing cancelled successfully!');
                    }
                    setTimeout(() => location.reload(), 1000);
                } else {
                    throw new Error(data.message || 'Failed to cancel listing');
                }
            })
            .catch(error => {
                console.error('Cancel error:', error);
                console.error('Failed URL:', url);

                let msg = error.message || 'Failed to cancel listing';
                if (msg.includes('Server error: 404')) {
                    msg = 'Server Error 404: Endpoint not found. URL: ' + url;
                }

                if (window.showToast) {
                    showToast(msg, 'error');
                } else {
                    alert('âŒ ' + msg);
                }
                if (button) {
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-trash-alt"></i> Cancel';
                }
            });
    }
</script>

<style>
    .btn-delete:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3) !important;
        background: linear-gradient(135deg, #fca5a5, #f87171) !important;
    }

    .listing-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12) !important;
    }

    .listing-card {
        border-left: 4px solid var(--text-muted);
    }

    .listing-card.status-available {
        border-left-color: var(--accent-green);
    }

    .listing-card.status-sold {
        border-left-color: var(--accent-red);
    }

    .listing-card.status-cancelled {
        border-left-color: var(--text-muted);
    }
</style>
{% endblock %}