{% extends "base.html" %}

{% block title %}Forgot Password - Smart Farming Assistant{% endblock %}

{% block content %}
<div class="auth-container"
    style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px;">
    <div class="auth-card"
        style="background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 450px; width: 100%; padding: 40px;">

        <!-- Header -->
        <div class="auth-header" style="text-align: center; margin-bottom: 30px;">
            <div style="font-size: 48px; margin-bottom: 15px;">üîê</div>
            <h2 style="margin: 0; font-size: 28px; color: #2d3748; font-weight: 700;">Forgot Password</h2>
            <p style="margin: 10px 0 0 0; color: #718096; font-size: 14px;">Enter your registered mobile number to
                receive OTP</p>
        </div>

        <!-- Alert Messages -->
        <div id="alertContainer"></div>

        <!-- Forgot Password Form -->
        <form id="forgotPasswordForm" style="margin-top: 25px;">

            <!-- Mobile Number Input -->
            <div class="form-group" style="margin-bottom: 20px;">
                <label for="mobileNumber"
                    style="display: block; margin-bottom: 8px; color: #4a5568; font-weight: 600; font-size: 14px;">
                    <i class="fas fa-mobile-alt" style="margin-right: 8px; color: #667eea;"></i>Mobile Number
                </label>
                <input type="tel" id="mobileNumber" name="mobile_number" class="form-control"
                    placeholder="Enter 10-digit mobile number" maxlength="10" pattern="[6-9][0-9]{9}" required
                    style="width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; transition: all 0.3s ease; outline: none;"
                    onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102,126,234,0.1)'"
                    onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'">
                <small style="display: block; margin-top: 6px; color: #a0aec0; font-size: 12px;">
                    We'll send a 6-digit OTP to this number
                </small>
            </div>

            <!-- Submit Button -->
            <button type="submit" id="submitBtn" class="btn-primary"
                style="width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; margin-top: 10px;"
                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 10px 20px rgba(102,126,234,0.3)'"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                <i class="fas fa-paper-plane" style="margin-right: 8px;"></i>
                <span id="btnText">Send OTP</span>
            </button>

        </form>

        <!-- Back to Login -->
        <div style="text-align: center; margin-top: 25px; padding-top: 25px; border-top: 1px solid #e2e8f0;">
            <p style="margin: 0; color: #718096; font-size: 14px;">
                Remember your password?
                <a href="{{ url_for('auth.login') }}"
                    style="color: #667eea; text-decoration: none; font-weight: 600; margin-left: 5px;">
                    Back to Login
                </a>
            </p>
        </div>

    </div>
</div>

<script>
document.getElementById('forgotPasswordForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const mobileNumber = document.getElementById('mobileNumber').value.trim();
    const submitBtn = document.getElementById('submitBtn');
    const btnText = document.getElementById('btnText');
    const alertContainer = document.getElementById('alertContainer');
    
    // Validate mobile number
    if (!/^[6-9]\d{9}$/.test(mobileNumber)) {
        showAlert('Please enter a valid 10-digit mobile number starting with 6-9', 'error');
        return;
    }
    
    // Disable button and show loading
    submitBtn.disabled = true;
    btnText.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending OTP...';
    
    try {
        const response = await fetch('/api/forgot-password/request-otp', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                mobile_number: mobileNumber
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert(data.message, 'success');
            
            // Redirect to OTP verification page after 2 seconds
            setTimeout(() => {
                window.location.href = `/verify-otp?mobile=${mobileNumber}`;
            }, 2000);
        } else {
            showAlert(data.message, 'error');
            submitBtn.disabled = false;
            btnText.textContent = 'Send OTP';
        }
        
    } catch (error) {
        console.error('Error:', error);
        showAlert('Network error. Please check your connection and try again.', 'error');
        submitBtn.disabled = false;
        btnText.textContent = 'Send OTP';
    }
});

function showAlert(message, type) {
    const alertContainer = document.getElementById('alertContainer');
    const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
    const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
    const bgColor = type === 'success' ? '#d4edda' : '#f8d7da';
    const textColor = type === 'success' ? '#155724' : '#721c24';
    const borderColor = type === 'success' ? '#c3e6cb' : '#f5c6cb';
    
    alertContainer.innerHTML = `
        <div class="${alertClass}" style="padding: 14px 16px; margin-bottom: 20px; border-radius: 10px; background-color: ${bgColor}; color: ${textColor}; border: 1px solid ${borderColor}; display: flex; align-items: center; animation: slideDown 0.3s ease;">
            <i class="fas ${icon}" style="margin-right: 10px; font-size: 18px;"></i>
            <span>${message}</span>
        </div>
    `;
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        alertContainer.innerHTML = '';
    }, 5000);
}

// Add slide down animation
const style = document.createElement('style');
style.textContent = `
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
`;
document.head.appendChild(style);
</script>

{% endblock %}