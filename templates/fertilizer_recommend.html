{% extends "base.html" %}

{% block title %}Fertilizer Recommendation - Smart Farming Assistant{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/crop.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/fertilizer.css') }}">
{% endblock %}

{% block content %}
<div class="dashboard-layout">
	<!-- Green Header Section -->
	<div class="dashboard-header">        
		<div class="header-content">
			<div class="header-left">
				<h1>AI-Powered Fertilizer Recommendation</h1>
				<p>Get tailored fertilizer suggestions based on crop and soil test results</p>
			</div>
			<div class="header-right">
				<span class="header-date">ğŸ“… {{ current_date or "Today" }}</span>
				<button class="logout-button" onclick="window.location.href='{{ url_for('auth.logout') }}'">ğŸ”´ Logout</button>
			</div>
		</div>
	</div>

	<!-- Main Content Area -->
	<div class="main-content">
		<!-- Sidebar -->
		<div class="sidebar">
			<!-- ...existing sidebar... -->
			<div class="sidebar-header">
				<div class="logo">
					<span class="logo-icon">ğŸŒ¾</span>
					<span class="logo-text">Farming Assistant</span>
				</div>
				<p class="subtitle">Smart Agriculture Platform</p>
			</div>
			<div class="welcome-section">
				<p class="welcome-label">Welcome back,</p>
				<h3 class="welcome-name">{{ user_name or "Farmer" }}! ğŸ‘‹</h3>
			</div>
			<nav class="sidebar-nav">
				<a href="{{ url_for('dashboard.dashboard') }}" class="nav-item">
					<span class="nav-icon">ğŸ“Š</span>
					<span class="nav-text">Dashboard</span>
				</a>
				<a href="{{ url_for('crop.crop_suggestion') }}" class="nav-item">
					<span class="nav-icon">ğŸŒ±</span>
					<span class="nav-text">Crop Suggestion</span>
				</a>
				<a href="{{ url_for('fertilizer.fertilizer_recommend') }}" class="nav-item active">
					<span class="nav-icon">ğŸ§ª</span>
					<span class="nav-text">Fertilizer Advice</span>
				</a>
				<a href="{{ url_for('disease.disease_detection') }}" class="nav-item">
					<span class="nav-icon">ğŸ¦ </span>
					<span class="nav-text">Disease Detection</span>
				</a>
			</nav>
		</div>

		<!-- Content Panel -->
		<div class="content-panel">
			<!-- Fertilizer Form Card -->
			<div class="fertilizer-form-card">
				<div class="form-header fertilizer-header">
					<div class="icon-wrapper">
						<span class="filter-icon">ğŸ§ª</span>
					</div>
					<div class="form-title">
						<h2>Smart Fertilizer Recommendation System</h2>
						<p>Enter soil results and crop info to get fertilizer suggestions</p>
					</div>
				</div>

				<form method="POST" class="crop-form">
					<div class="two-column-grid">
						<div class="form-panel">
							<h3 class="panel-title">Soil Test Results</h3>
							<div class="input-group">
								<label for="nitrogen">Nitrogen (N)</label>
								<input id="nitrogen" name="nitrogen" type="number" step="0.01" required value="{{ input_data.nitrogen if input_data else '' }}">
							</div>
							<div class="input-group">
								<label for="phosphorous">Phosphorus (P)</label>
								<input id="phosphorous" name="phosphorous" type="number" step="0.01" required value="{{ input_data.phosphorous if input_data else '' }}">
							</div>
							<div class="input-group">
								<label for="potassium">Potassium (K)</label>
								<input id="potassium" name="potassium" type="number" step="0.01" required value="{{ input_data.potassium if input_data else '' }}">
							</div>
						</div>

						<div class="form-panel">
							<h3 class="panel-title">Crop & Environment</h3>
							<div class="input-group">
								<label for="crop_type">Crop Type</label>
								<select id="crop_type" name="crop_type" required>
									<option value="">Choose a crop</option>
									<option value="rice" {% if input_data and input_data.crop_type=='rice' %}selected{% endif %}>Rice</option>
									<option value="wheat" {% if input_data and input_data.crop_type=='wheat' %}selected{% endif %}>Wheat</option>
									<option value="maize" {% if input_data and input_data.crop_type=='maize' %}selected{% endif %}>Maize</option>
									<option value="cotton" {% if input_data and input_data.crop_type=='cotton' %}selected{% endif %}>Cotton</option>
									<option value="jute" {% if input_data and input_data.crop_type=='jute' %}selected{% endif %}>Jute</option>
									<option value="banana" {% if input_data and input_data.crop_type=='banana' %}selected{% endif %}>Banana</option>
								</select>
							</div>

							<div class="input-group">
								<label for="temperature">Temperature (Â°C)</label>
								<input id="temperature" name="temperature" type="number" step="0.01" required value="{{ input_data.temperature if input_data else '' }}">
							</div>

							<div class="input-group">
								<label for="humidity">Humidity (%)</label>
								<input id="humidity" name="humidity" type="number" step="0.01" min="0" max="100" required value="{{ input_data.humidity if input_data else '' }}">
							</div>

							<div class="input-group">
								<label for="soil_moisture">Soil Moisture (%)</label>
								<input id="soil_moisture" name="soil_moisture" type="number" step="0.01" required value="{{ input_data.soil_moisture if input_data else '' }}">
							</div>
						</div>
					</div>

					<div class="form-actions">
						<button type="button" class="autofill-all-btn" onclick="autofillAllFields()">âœ¨ Auto-fill Average Values</button>
						<button type="button" class="clear-btn" onclick="clearAllFields()">ğŸ—‘ï¸ Clear</button>
						<button type="submit" class="submit-btn">ğŸ”® Get AI Fertilizer Recommendations</button>
					</div>
				</form>
			</div>

			<!-- Conditional results -->
			{% if recommendations %}
			<div class="crop-results-section">
				<div class="results-header">
					<div class="header-icon">ğŸ§¾</div>
					<div class="header-content">
						<h2>Recommended Fertilizers</h2>
						<p>Suggestions for <strong>{{ input_data.crop_type|capitalize }}</strong> (soil moisture: {{ input_data.soil_moisture }}%)</p>
					</div>
				</div>

				<div class="crop-cards-grid">
					{% for fert in recommendations %}
					<div class="fertilizer-card {{ 'high-priority' if fert.priority == 'High' else 'medium-priority' if fert.priority == 'Medium' else 'low-priority' }}">
						<div class="crop-header">
							<h3>{{ fert.name }}</h3>
							<span class="priority-badge {{ fert.priority.lower() }}">{{ fert.priority }}</span>
						</div>
						<div class="crop-details">
							<div class="detail-item"><span class="icon">âš–ï¸</span><span class="label">Dosage</span><span class="value">{{ fert.dosage }}</span></div>
							<div class="detail-item"><span class="icon">ğŸ“ˆ</span><span class="label">Effectiveness</span><span class="value">{{ "%.0f"|format(fert.confidence_percentage) }}%</span></div>
							<div class="detail-item"><span class="icon">ğŸ“</span><span class="label">Use</span><span class="value">{{ fert.usage }}</span></div>
							<div class="detail-item"><span class="icon">ğŸ’¡</span><span class="label">Notes</span><span class="value">{{ fert.note }}</span></div>
						</div>
						<div class="card-actions">
							<form method="POST" action="{{ url_for('fertilizer.save_fertilizer') }}" style="display:inline;">
								<input type="hidden" name="fertilizer_name" value="{{ fert.name }}">
								<input type="hidden" name="crop_type" value="{{ input_data.crop_type }}">
								<input type="hidden" name="priority" value="{{ fert.priority }}">
								<input type="hidden" name="description" value="{{ fert.note }}">
								<input type="hidden" name="application_rate" value="{{ fert.dosage }}">
								<button type="submit" class="btn-start">ğŸ’¾ Save</button>
							</form>
							<button class="btn-outline" onclick="viewFertilizerDetails('{{ fert.name }}')">ğŸ“„ Details</button>
						</div>
					</div>
					{% endfor %}
				</div>

				<div class="recommendation-summary">
					<div class="summary-card">
						<h3>ğŸ“Š Summary</h3>
						<div class="summary-stats">
							<div class="stat"><span class="stat-value">{{ recommendations|length }}</span><span class="stat-label">Fertilizers</span></div>
							<div class="stat"><span class="stat-value">{{ recommendations[0].name }}</span><span class="stat-label">Top Recommendation</span></div>
							<div class="stat"><span class="stat-value">{{ "%.0f"|format(recommendations[0].confidence_percentage) }}%</span><span class="stat-label">Confidence</span></div>
						</div>
					</div>
				</div>
			</div>
			{% endif %}
			<!-- end conditional -->
		</div>
	</div>
</div>

<script>
// Average autofill values
const averageValues = {
	nitrogen: 40,
	phosphorous: 30,
	potassium: 20,
	temperature: 25,
	humidity: 70,
	soil_moisture: 50
};

function autofillAllFields() {
	Object.keys(averageValues).forEach(k => {
		const el = document.getElementById(k);
		if (el) el.value = averageValues[k];
	});
	highlightFields(Object.keys(averageValues));
	showNotification('âœ¨ Autofilled average values');
}

function clearAllFields() {
	['nitrogen','phosphorous','potassium','temperature','humidity','soil_moisture'].forEach(id => {
		const el = document.getElementById(id);
		if (el) el.value = '';
	});
	showNotification('ğŸ—‘ï¸ Cleared input fields');
}

function highlightFields(fieldNames) {
	fieldNames.forEach(fieldName => {
		const field = document.getElementById(fieldName);
		if (field) {
			field.style.borderColor = '#7c4dff';
			field.style.backgroundColor = '#fbf6ff';
			setTimeout(() => {
				field.style.borderColor = '';
				field.style.backgroundColor = '';
			}, 1800);
		}
	});
}

function showNotification(message) {
	const notification = document.createElement('div');
	notification.className = 'autofill-notification';
	notification.textContent = message;
	notification.style.cssText = 'position:fixed;top:18px;right:18px;background:#7c4dff;color:#fff;padding:10px 14px;border-radius:8px;z-index:2000';
	document.body.appendChild(notification);
	setTimeout(()=>notification.remove(),2800);
}

function viewFertilizerDetails(name) {
	alert('Details for ' + name + '. Follow local extension guidance for application.');
}
</script>
{% endblock %}
